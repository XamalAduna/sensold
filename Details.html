<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>D√©tails du produit</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
<style>
body { font-family: Arial, sans-serif; background:#f7f7f7; margin:0; padding:20px; }
.container { max-width:800px; margin:0 auto; background:white; border-radius:12px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,0.1); padding-bottom: 75px;}
h2 { text-align:center; color:#00796B; margin-bottom:20px; }
.image-wrapper { position: relative; }
.main-image { width: 100%; max-height: 400px; object-fit: contain; border-radius: 12px; background: #00796B; margin-bottom: 15px; }
.arrow { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: #fff; border: none; font-size: 28px; padding: 8px 12px; cursor: pointer; border-radius: 50%; }
.arrow.left { left: 10px; }
.arrow.right { right: 10px; }
.thumbnails { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; scroll-behavior: smooth; justify-content: center; margin-bottom: 15px; }
.thumbnails img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: border 0.2s; }
.thumbnails img.active { border: 2px solid #00796B; }
.product-header { text-align: left; margin-bottom: 15px; }
.product-header .price { font-size: 32px; font-weight: bold; color: #00796B; margin: 0 0 5px 0; }
.product-header h1 { font-size: 24px; color: #00796B; margin: 0; }
.details { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
.details p { margin:0; font-size:15px; display:flex; align-items:center; gap:5px; padding:4px 8px; border:1px solid #ddd; border-radius:8px; background:#f9f9f9; }
.details i.material-icons { color:#00796B; font-size:20px; vertical-align:middle; }
.details .description-content { padding:8px; border:1px solid #ddd; border-radius:8px; background:#f1f1f1; margin-bottom:5px; white-space: pre-wrap; width:100%; display:flex; align-items:flex-start; gap:5px; }
.seller a { display:flex; align-items:center; gap:10px; text-decoration:none; color:inherit; max-width:100%; min-width:0; }
.seller img { width:50px; height:50px; border-radius:50%; object-fit:cover; flex-shrink:0; }
.seller div { flex:1 1 auto; min-width:0; }
.seller div strong { display:block; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
.seller div span {flex-shrink: 0; display: inline-flex; color: #00796B; font-size: 36px; overflow: visible; }
.buttons { display:flex; gap:10px; margin-top:20px; flex-wrap:wrap; }
.button { flex:1; text-align:center; padding:10px; border:none; border-radius:8px; font-size:16px; cursor:pointer; color:white; text-decoration:none; }
.button.whatsapp { background:#25D366; }
.button.phone { background:#00796B; }
.button.email { background:#00796B; }
.button.disabled { background:#999; cursor:not-allowed; }
.description-text { flex:1; min-width:0; white-space:normal; overflow-wrap:anywhere; word-break:break-word; }
.image-wrapper { position:relative; width:100%; height:400px; overflow:hidden; border-radius:12px; margin-bottom:15px; }
.main-image { width:100%; height:100%; object-fit:contain; background-color:white; display:block; }
.spinner { position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; margin: -20px 0 0 -20px; border: 4px solid #ccc; border-top: 4px solid #00796B; border-radius: 50%; animation: spin 1s linear infinite; z-index: 10; } @keyframes spin { 100% { transform: rotate(360deg); } }
.back-btn { position: fixed; top: 15px; right: 20px; background: #d32f2f; color: white; border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 20px; cursor: pointer; z-index: 10000; display: flex; justify-content: center; align-items: center; }
.back-btn:hover { background: #9a0007; }


.contact-card {
  margin-top: 20px;
  padding: 15px;
  border: 1px solid #ddd;
  border-radius: 14px;
  background: #fafafa;
}

.contact-top,
.contact-bottom {
  display: flex;
  gap: 10px;
  margin-top: 12px;
}

.contact-top .button,
.contact-bottom .button {
  flex: 1;
}

</style>
</head>
<body>
<h2>D√©tails du produit</h2>
<div class="container">
  <div class="image-wrapper">
    <img id="main-image" class="main-image" src="https://via.placeholder.com/400x300?text=Chargement...">
    <button class="arrow left" onclick="prevImage()">&#10094;</button>
    <button class="arrow right" onclick="nextImage()">&#10095;</button>
  </div>
  <div class="thumbnails" id="thumbnails"></div>
  <div class="product-header">
    <p class="price" id="product-price">...</p>
    <h1 id="product-title">Chargement...</h1>
    <p id="product-location"></p>
  </div>
  <div class="details" id="details"></div>
  <div class="seller" id="seller-info"></div>
  <div class="buttons" id="contact-buttons"></div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getFirestore, doc, getDoc, collection, addDoc, deleteDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDLrPKEzDueP4j-HjAdOhmkuA74cLsCn2M",
  authDomain: "diallo-ee5aa.firebaseapp.com",
  projectId: "diallo-ee5aa",
  storageBucket: "diallo-ee5aa.firebasestorage.app",
  messagingSenderId: "662485613383",
  appId: "1:662485613383:web:c1129a35c335cc95c0ea62",
  measurementId: "G-F3092DTNZY"
};
  
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const params = new URLSearchParams(window.location.search);
const id = params.get('id');
let images = [];
let currentIndex = 0;
  
let seller = null;
let currentUser = null;

function updateActiveThumbnail() {
  document.querySelectorAll('.thumbnails img').forEach((img, i) => {
    img.classList.toggle('active', i === currentIndex);
  });
}
function escapeHTML(str) {
  return str
    ? str.replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
    : "";
}
function timeAgo(timestamp){
  if(!timestamp) return "Date inconnue";
  const seconds = (Date.now() - timestamp.toDate().getTime()) / 1000;
  if(seconds < 60) return "√† l‚Äôinstant";
  const minutes = Math.floor(seconds/60);
  if(minutes < 60) return `il y a ${minutes} min`;
  const hours = Math.floor(minutes/60);
  if(hours < 24) return `il y a ${hours} h`;
  const days = Math.floor(hours/24);
  return `il y a ${days} j`;
}
function isValidImageURL(url) {
  return /^https?:\/\//i.test(url);
}
function showSecurityModal(callback) {
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;';
  const box = document.createElement('div');
  box.style.cssText = 'background:white;padding:20px;border-radius:12px;max-width:400px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,0.2);position:relative;';
  const closeBtn = document.createElement('button');
  closeBtn.textContent = '√ó';
  closeBtn.style.cssText = 'position:absolute;top:10px;right:10px;background:transparent;border:none;font-size:24px;cursor:pointer;color:#00796B;';
  closeBtn.addEventListener('click', () => document.body.removeChild(modal));
  box.appendChild(closeBtn);
  const msg = document.createElement('p');
  msg.textContent = "‚ö†Ô∏è Conseils de s√©curit√© :\n1 - Ne pas envoyer de paiements sans v√©rifier le produit.\n2 - Ne pas envoyer d'argent par virement ou transfert.\n3 - Rencontrer le vendeur dans un lieu public.";
  msg.style.whiteSpace = 'pre-line';
  msg.style.marginBottom = '20px';
  box.appendChild(msg);
  const okBtn = document.createElement('button');
  okBtn.textContent = 'OK';
  okBtn.style.cssText = 'padding:10px 20px;background:#00796B;color:white;border:none;border-radius:8px;cursor:pointer;';
  okBtn.addEventListener('click', () => {
    document.body.removeChild(modal);
    callback();
  });
  box.appendChild(okBtn);
  modal.appendChild(box);
  document.body.appendChild(modal);
}
async function loadDetails() {
  try {
    const docRef = doc(db, "annonces", id);
    const docSnap = await getDoc(docRef);
    if (!docSnap.exists()) {
      document.getElementById('details').textContent = "Produit non trouv√©.";
      return;
    }
    const data = docSnap.data();
    const mainImage = document.getElementById('main-image');
    const thumbnails = document.getElementById('thumbnails');
    thumbnails.innerHTML = '';
    const spinner = document.createElement('div');
    spinner.className = 'spinner';
    mainImage.parentElement.style.position = 'relative';
    mainImage.parentElement.appendChild(spinner);
    images = Array.isArray(data.images) && data.images.length > 0
      ? data.images.filter(isValidImageURL)
      : ["https://via.placeholder.com/400x300?text=Pas+d'image"];
    currentIndex = 0;
    function updateMainImage() {
      spinner.style.display = 'block';
      mainImage.style.opacity = '0.3';
      mainImage.src = images[currentIndex];
    }
    mainImage.addEventListener('load', () => {
      spinner.style.display = 'none';
      mainImage.style.opacity = '1';
    });
    updateMainImage();
    images.forEach((url, index) => {
  const thumb = document.createElement('img');
  thumb.src = url;
  thumb.loading = "lazy";
  if (index === 0) thumb.classList.add("active");
  thumb.addEventListener('click', () => {
    document.querySelectorAll('.thumbnails img').forEach(img => img.classList.remove('active'));
    thumb.classList.add('active');
    currentIndex = index;
    updateMainImage();
  });
  thumbnails.appendChild(thumb);
});
    document.getElementById('product-price').textContent = data.price ? escapeHTML(data.price + " FCFA") : "Prix sur demande";
    document.getElementById('product-title').innerHTML = escapeHTML(data.title || "Sans titre");   
    document.getElementById('product-location').innerHTML = `<i class="material-icons" style="color:#E91E63;">location_on</i> ${escapeHTML(data.city || "")}${data.quartier ? " - " + escapeHTML(data.quartier) : ""}`;
    if (data.createdAt) {
      const timeElem = document.createElement('p');
      timeElem.style.fontSize = "14px";
      timeElem.style.color = "#666";
      timeElem.innerHTML = `<i class="material-icons" style="font-size:16px;vertical-align:middle;">schedule</i> ${timeAgo(data.createdAt)}`;
      document.querySelector('.product-header').appendChild(timeElem);
    }
    const order = ["categorie","souscategorie","Marque","Mod√®le","Ann√©e","Kilom√©trage","Carburant","Transmission","Nombredeportes","Surface(m¬≤)","Nombredechambres","Nombredesallesdebain","Nombredepi√®ces","Nombred‚Äôappartements","Nombred‚Äô√©tages","Ann√©edeconstruction","Typedeculture","√âtatg√©n√©ral","Option","produitNeuf","livraison","description"];
    const iconsMap = { categorie:"category", souscategorie:"category", Marque:"branding_watermark", Mod√®le:"build", Ann√©e:"calendar_today", Kilom√©trage:"speed", Carburant:"local_gas_station", Transmission:"settings", Nombredeportes:"door_front", "Surface(m¬≤)":"square_foot", Nombredechambres:"bed", Nombredesallesdebain:"bathtub", Nombredepi√®ces:"meeting_room", "Nombred‚Äôappartements":"apartment", "Nombred‚Äô√©tages":"stairs", Ann√©edeconstruction:"history", Typedeculture:"agriculture", √âtatg√©n√©ral:"construction", Option:"done", produitNeuf:"new_releases", livraison:"local_shipping", description:"description"};
    const detailsDiv = document.getElementById('details');
    detailsDiv.innerHTML = "";
    order.forEach(key => {
      if (data[key] !== undefined && data[key] !== false) {
        const icon = iconsMap[key] || "info";
        const div = document.createElement(key === "description" ? "div" : "p");
        div.innerHTML = key === "description"
          ? `<div class="description-content"><i class="material-icons">${icon}</i><div class="description-text"><strong>${escapeHTML(key)}:</strong> ${escapeHTML(data[key])}</div></div>`
          : `<i class="material-icons">${icon}</i> <strong>${escapeHTML(key)}:</strong> ${escapeHTML(data[key] === true ? "Oui" : data[key])}`;
        detailsDiv.appendChild(div);
      }
    });
    if (data.ownerId) {
  const sellerRef = doc(db, "users", data.ownerId);
  const sellerSnap = await getDoc(sellerRef);
  if (sellerSnap.exists()) {
    seller = {
      ...sellerSnap.data(),
      uid: sellerSnap.id
    };
  }
}
    
    const sellerDiv = document.getElementById('seller-info');
let isPro = seller.subscribe === true && seller.subscribeEnd && seller.subscribeEnd.toDate() > new Date();
sellerDiv.innerHTML = `
  <a href="Profil.html?uid=${encodeURIComponent(seller.uid || '')}" style="display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit;">
    <img src="${isValidImageURL(seller.profileImage) ? seller.profileImage : 'https://via.placeholder.com/50'}" alt="Profil" loading="lazy" style="width:50px;height:50px;border-radius:50%;object-fit:cover;">
    <div class="seller-info" style="display:flex;align-items:center;gap:6px;">
      <strong>${escapeHTML(seller.fullName || "Inconnu")}</strong>
      ${isPro ? '<span class="material-symbols-outlined" title="Boutique Pro" style="color:#00796B;font-size:36px;">storefront</span>' : ''}
    </div>
  </a>
`;
    
    const contactDiv = document.getElementById('contact-buttons');
    contactDiv.innerHTML = "";

    /* Carte englobante */
    const card = document.createElement('div');
    card.className = "contact-card";

    /* Zone haute : WhatsApp + T√©l√©phone */
    const topButtons = document.createElement('div');
    topButtons.className = "contact-top";

    /* Zone basse : Signaler + S'abonner */
    const bottomButtons = document.createElement('div');
    bottomButtons.className = "contact-bottom";

    const wa = document.createElement('a');
    wa.className = "button whatsapp";
    if(data.whatsapp){
      wa.href = "#";
      wa.innerHTML = `<i class="fa-brands fa-whatsapp fa-2x"></i>`;
      wa.addEventListener('click', e => {
        e.preventDefault();
        showSecurityModal(() => {
          const text = `Bonjour, je suis int√©ress√© par votre ${escapeHTML(data.title)} de ${escapeHTML(data.price || "Prix sur demande")}.\nLien: ${window.location.href}`;
          window.open(`https://wa.me/${data.whatsapp.replace(/\D/g,'')}?text=${encodeURIComponent(text)}`, "_blank");
        });
      });
    } else wa.classList.add("disabled");
    
    topButtons.appendChild(wa);
    
    const phone = document.createElement('a');
phone.className = "button phone";
if(data.telephone){
  phone.href = "#";
  phone.innerHTML = `<i class="material-icons">call</i>`;
  phone.addEventListener('click', e => {
    e.preventDefault();
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;';
    const box = document.createElement('div');
    box.style.cssText = 'background:white;padding:20px;border-radius:12px;max-width:400px;text-align:center;position:relative;';
    const closeBtn = document.createElement('button');
    closeBtn.textContent = '√ó';
    closeBtn.style.cssText = 'position:absolute;top:10px;right:10px;background:transparent;border:none;font-size:24px;cursor:pointer;color:#00796B;';
    closeBtn.addEventListener('click', () => document.body.removeChild(modal));
    box.appendChild(closeBtn);
    const warning = document.createElement('p');
    warning.textContent = "‚ö†Ô∏è Conseils de s√©curit√© :\n1 - Ne pas envoyer de paiements sans v√©rifier le produit.\n2 - Ne pas envoyer d'argent par virement ou transfert.\n3 - Rencontrer le vendeur dans un lieu public.";
    warning.style.whiteSpace = 'pre-line';
    warning.style.marginBottom = '20px';
    box.appendChild(warning);
    const number = document.createElement('p');
    number.innerHTML = `üìû Num√©ro du vendeur : <strong>${escapeHTML(data.telephone)}</strong>`;
    number.style.fontSize = '18px';
    box.appendChild(number);
    modal.appendChild(box);
    document.body.appendChild(modal);
  });
} else phone.classList.add("disabled");

topButtons.appendChild(phone);
    
    // ===== BOUTONS SIGNALER ET SUIVI =====
const auth = getAuth();
let isSubscribed = false;
let hasReported = false;

// ===== NOTIFICATION SIMPLE =====
function notify(msg){
  alert(msg);
}

onAuthStateChanged(auth, async (user) => {
  currentUser = user;
  if (currentUser && seller && seller.uid) {
    await checkSubscription();
    await checkReport();
    updateSubscribeButton();
    updateReportButton();
  }
});

/* =======================
   ===== BOUTON SIGNALER =====
   ======================= */
const reportBtn = document.createElement('button');
reportBtn.className = "button phone";
reportBtn.innerHTML = `<i class="fa-solid fa-thumbs-down"></i> Signaler ce vendeur`;
reportBtn.style.background = "#D32F2F";

async function checkReport(){
  if(!currentUser) return;
  const q = query(
    collection(db,"reports"),
    where("annonceId","==",id),
    where("reporterId","==",currentUser.uid)
  );
  const snap = await getDocs(q);
  hasReported = !snap.empty;
}

function updateReportButton(){
  if(hasReported){
    reportBtn.disabled = true;
    reportBtn.classList.add("disabled");
    reportBtn.innerHTML = "Signalement envoy√©";
  }
}
    
reportBtn.addEventListener('click', () => {
  if (!currentUser) return notify("Vous devez √™tre connect√© pour signaler.");
  if (currentUser.uid === seller.uid) return notify("Vous ne pouvez pas vous signaler vous-m√™me.");

  const modal = document.createElement('div');
  modal.style.cssText = `
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.6);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:1000;
  `;

  const box = document.createElement('div');
  box.style.cssText = `
    background:#fff;
    width:90%;
    max-width:420px;
    border-radius:14px;
    padding:20px;
    box-shadow:0 10px 30px rgba(0,0,0,0.25);
    position:relative;
    animation:scaleIn .2s ease;
  `;

  /* Bouton X */
  const closeBtn = document.createElement('button');
  closeBtn.innerHTML = '&times;';
  closeBtn.style.cssText = `
    position:absolute;
    top:12px;
    right:14px;
    border:none;
    background:none;
    font-size:26px;
    cursor:pointer;
    color:#888;
  `;
  closeBtn.onclick = () => document.body.removeChild(modal);

  /* Titre */
  const title = document.createElement('h3');
  title.textContent = "Signaler ce vendeur";
  title.style.cssText = `
    margin:0 0 15px;
    color:#D32F2F;
    text-align:center;
  `;

  /* Select */
  const select = document.createElement('select');
  select.style.cssText = `
    width:100%;
    padding:12px;
    border-radius:8px;
    border:1px solid #ccc;
    font-size:15px;
    margin-bottom:15px;
  `;
  select.innerHTML = `
    <option value="">‚Äî Choisir un motif ‚Äî</option>
    <option>Arnaque</option>
    <option>Produit faux</option>
    <option>Comportement inappropri√©</option>
    <option>Autre</option>
  `;

  /* Bouton confirmer */
  const confirm = document.createElement('button');
  confirm.textContent = "Envoyer le signalement";
  confirm.style.cssText = `
    width:100%;
    padding:12px;
    background:#D32F2F;
    color:#fff;
    border:none;
    border-radius:8px;
    font-size:16px;
    cursor:pointer;
  `;

  confirm.onclick = async () => {
    if (!select.value) return notify("Veuillez choisir un motif.");

    await addDoc(collection(db, "reports"), {
      annonceId: id,
      reporterId: currentUser.uid,
      reportedId: seller.uid,
      motif: select.value,
      createdAt: new Date()
    });

    hasReported = true;
    updateReportButton();
    notify("Signalement envoy√© avec succ√®s.");
    document.body.removeChild(modal);
  };

  box.append(closeBtn, title, select, confirm);
  modal.appendChild(box);
  document.body.appendChild(modal);
});

bottomButtons.appendChild(reportBtn);

/* =======================
   ===== BOUTON S'ABONNER UNIQUE =====
   ======================= */
const subscribeBtn = document.createElement('button');
subscribeBtn.className = "button whatsapp";

function updateSubscribeButton(){
  if(isSubscribed){
    subscribeBtn.textContent = "Se d√©sabonner";
    subscribeBtn.style.background = "#D32F2F";
  }else{
    subscribeBtn.textContent = "S'abonner";
    subscribeBtn.style.background = "#00796B";
  }
}

async function checkSubscription(){
  const q = query(
    collection(db,"subscriptions"),
    where("followerId","==",currentUser.uid),
    where("followingId","==",seller.uid)
  );
  const snap = await getDocs(q);
  isSubscribed = !snap.empty;
}

subscribeBtn.addEventListener('click', async ()=>{
  if(!currentUser) return notify("Vous devez √™tre connect√©.");
  if(currentUser.uid === seller.uid) return notify("Vous ne pouvez pas vous abonner √† vous-m√™me.");

  if(!isSubscribed){
    await addDoc(collection(db,"subscriptions"),{
      followerId:currentUser.uid,
      followingId:seller.uid,
      createdAt:new Date()
    });
    isSubscribed = true;
    notify("Vous √™tes maintenant abonn√© √† ce vendeur.");
  }else{
    const q = query(
      collection(db,"subscriptions"),
      where("followerId","==",currentUser.uid),
      where("followingId","==",seller.uid)
    );
    const snap = await getDocs(q);
    snap.forEach(async d=> await deleteDoc(doc(db,"subscriptions",d.id)));
    isSubscribed = false;
    notify("Vous vous √™tes d√©sabonn√© avec succ√®s.");
  }
  updateSubscribeButton();
});

bottomButtons.appendChild(subscribeBtn);

card.appendChild(topButtons);
card.appendChild(bottomButtons);
contactDiv.appendChild(card);



  } catch(err){
    console.error("Erreur chargement d√©tails:", err);
    document.getElementById('details').textContent = "‚ö†Ô∏è Erreur de chargement : " + escapeHTML(err.message);
  }}
window.prevImage = function() {
  currentIndex = (currentIndex - 1 + images.length) % images.length;
  document.getElementById('main-image').src = images[currentIndex];
  updateActiveThumbnail();
}
window.nextImage = function() {
  currentIndex = (currentIndex + 1) % images.length;
  document.getElementById('main-image').src = images[currentIndex];
  updateActiveThumbnail();
}
loadDetails();
</script>
</body>
</html>
