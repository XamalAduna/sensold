<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mes annonces</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
body { font-family: Arial, sans-serif; background:#f7f7f7; margin:0; padding:20px; }
h2 { text-align:center; margin-bottom:10px; color:#00796B; }
h3 { text-align:center; color:#00796B; margin-bottom:15px; }
.annonces-container { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:20px; }
@media (min-width:1024px){ .annonces-container { grid-template-columns: repeat(4,1fr); } }
@media (max-width:600px){ .annonces-container { grid-template-columns: repeat(2,1fr); } }
.annonce-card { background:white; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); overflow:hidden; display:flex; flex-direction:column; position:relative;}
.annonce-card img { width:100%; height:200px; object-fit:cover; }
.content { padding:12px; flex:1; }
.title { font-size:16px; font-weight:bold; margin:0 0 6px; color:#333; }
.price { color:#00796B; font-weight:bold; font-size:18px; margin:0 0 6px; }
.location, .date { font-size:13px; color:#555; margin:2px 0; }
.actions { display:flex; justify-content:space-between; padding:10px 12px; border-top:1px solid #eee; background:#fafafa; }
.actions button { background:#00796B; border:none; color:white; padding:6px 10px; border-radius:6px; cursor:pointer; font-size:13px; transition:0.3s; }
.actions button:hover { background:#004d40; }
#deleteModal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index:9999; justify-content: center; align-items: center; }
#deleteModal .modal-content { background:white; padding:20px 30px; border-radius:12px; max-width:400px; width:90%; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.2); }
#deleteModal p { font-size:16px; margin-bottom:20px; }
#deleteModal button { width:auto; padding:10px 20px; margin:5px; border:none; border-radius:6px; cursor:pointer; }
#confirmDelete { background:#d32f2f; color:white; }
#confirmDelete:hover { background:#9a0007; }
#cancelDelete { background:#ccc; color:#333; }
#cancelDelete:hover { background:#999; }
.title { font-size:16px; font-weight:bold; margin:0 0 6px; color:#333; text-align:left; }
#successMessage { display: none; position: fixed; top:20px; right:20px; background:#4caf50; color:white; padding:12px 20px; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.2); z-index:10000; font-size:14px; }
 
@media (max-width: 600px) {
  .actions {
    flex-direction: column;
    gap: 8px;}}
 
.back-btn { position: fixed; top: 20px; right: 20px; background: #d32f2f; color: white; border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 20px; cursor: pointer; z-index: 10000; display: flex; justify-content: center; align-items: center; }
.back-btn:hover { background: #9a0007; }
</style>
</head>
<body>
<button class="back-btn" onclick="window.location.href='../index.html'">‚úñ</button>
 
<h2>üì¢ Mes annonces</h2>
<h3 id="user-email"></h3>
<div id="annonces-container" class="annonces-container"></div>

<div id="deleteModal">
  <div class="modal-content">
    <p>√ätes-vous s√ªr de vouloir supprimer cette annonce ?</p>
    <button id="confirmDelete">üóëÔ∏è Supprimer</button>
    <button id="cancelDelete">‚ùå Annuler</button>
  </div>
</div>

<div id="successMessage">‚úÖ L'annonce a √©t√© supprim√©e avec succ√®s</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getFirestore, collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDLrPKEzDueP4j-HjAdOhmkuA74cLsCn2M",
  authDomain: "diallo-ee5aa.firebaseapp.com",
  projectId: "diallo-ee5aa",
  storageBucket: "diallo-ee5aa.firebasestorage.app",
  messagingSenderId: "662485613383",
  appId: "1:662485613383:web:c1129a35c335cc95c0ea62",
  measurementId: "G-F3092DTNZY"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();
const container = document.getElementById("annonces-container");
const emailEl = document.getElementById("user-email");

const deleteModal = document.getElementById("deleteModal");
const confirmDeleteBtn = document.getElementById("confirmDelete");
const cancelDeleteBtn = document.getElementById("cancelDelete");
const successMessage = document.getElementById("successMessage");
let annonceToDelete = null;

function timeAgo(timestamp){
  if(!timestamp) return "Date inconnue";
  const seconds = (Date.now() - timestamp.toDate().getTime()) / 1000;
  if(seconds < 60) return "√† l‚Äôinstant";
  const minutes = Math.floor(seconds/60);
  if(minutes < 60) return `il y a ${minutes} min`;
  const hours = Math.floor(minutes/60);
  if(hours < 24) return `il y a ${hours} h`;
  const days = Math.floor(hours/24);
  return `il y a ${days} j`;
}

onAuthStateChanged(auth, async (user) => {
  if(!user){
    window.location.href = "../index.html";
    return;
  }

  emailEl.textContent = `Connect√© : ${user.email}`;

  const annoncesSnap = await getDocs(collection(db,"annonces"));
  const annonces = [];
  annoncesSnap.forEach(d=>{
    const data = d.data();
    data.id = d.id;
    if(data.userEmail && data.userEmail.toLowerCase().trim() === user.email.toLowerCase().trim()){
      annonces.push(data);
    }
  });

  if(annonces.length === 0){
    container.innerHTML = "<p>Vous n'avez publi√© aucune annonce.</p>";
    return;
  }

  container.innerHTML = "";
  annonces.forEach(a => {
    const quartier = a.quartier ? ", " + a.quartier : "";
    const card = document.createElement("div");
    card.className = "annonce-card";
    card.innerHTML = `
      <img src="${a.images?.[0] || 'https://via.placeholder.com/400x200?text=Annonce'}" alt="${a.title || 'Annonce'}">
      <div class="content">
        <p class="price">${a.price ? a.price + " FCFA" : "Prix sur demande"}</p>
        <h3 class="title">${a.title || "Sans titre"}</h3>
        <p class="location">üìç ${a.city || "Ville non pr√©cis√©e"}${quartier}</p>
        <p class="date">‚è∞ ${timeAgo(a.createdAt)}</p>
      </div>
      <div class="actions">
        <button class="edit">‚úèÔ∏è Modifier</button>
        <button class="delete">üóëÔ∏è Supprimer</button>
      </div>
    `;

    card.querySelector(".edit").addEventListener("click", (e)=>{
      e.stopPropagation();
      window.location.href = `../Edit.html?id=${a.id}`;
    });

    card.querySelector(".delete").addEventListener("click", (e)=>{
      e.stopPropagation();
      annonceToDelete = a;
      deleteModal.style.display = "flex";
    });
    
    container.appendChild(card);
  });
});

confirmDeleteBtn.addEventListener("click", async ()=>{
  if(annonceToDelete){
    await deleteDoc(doc(db,"annonces",annonceToDelete.id));

    const card = [...document.querySelectorAll(".annonce-card")]
      .find(c=>c.querySelector(".title").textContent===annonceToDelete.title);
    if(card) card.remove();

    annonceToDelete = null;
    deleteModal.style.display = "none";

    successMessage.style.display = "block";
    setTimeout(()=>{ successMessage.style.display = "none"; }, 3000);
  }
});

cancelDeleteBtn.addEventListener("click", ()=>{
  annonceToDelete = null;
  deleteModal.style.display = "none";
});
</script>
</body>
</html>
