<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Publier une annonce</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body {font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background: #f0f2f5;margin: 0;padding: 20px;color: #333;}
.form-container {max-width: 900px;margin: auto;background: #fff;padding: 30px;border-radius: 15px;box-shadow: 0 8px 20px rgba(0,0,0,0.1);}
h1 { text-align: center; margin-bottom: 25px; color: #00796B; font-weight: 700; font-size: 25px; }
h2 { margin: 20px 0 10px; color: #2980b9; font-size: 18px; font-weight: 700; padding-bottom: 5px; border-bottom: 2px solid #2980b9; }
.form-section { margin-bottom: 25px; }
.image-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); gap: 10px; }
.image-upload { display: flex; justify-content: center; align-items: center; height: 65px; border: 2px dashed #3498db; border-radius: 10px; cursor: pointer; background: #eaf2fb; position: relative; overflow: hidden; transition: all 0.3s ease; }
.image-upload:hover { background: #d6e8fc; border-color: #00796B; }
.image-upload input { display: none; }
.image-upload img { max-width: 100%; max-height: 100%; display: block; object-fit: cover; border-radius: 8px; }
.image-upload .material-icons { font-size: 28px; color: #00796B; }
input, textarea { width: 80%;padding: 16px 15px;  margin-top: 8px; border: 1px solid #ccc; border-radius: 12px; font-size: 17px; transition: all 0.3s ease; }
input:focus, textarea:focus { border-color: #2980b9; box-shadow: 0 0 8px rgba(41, 128, 185, 0.3); outline: none; }
textarea { resize: none; height: 120px; }
.custom-dropdown { position: relative; width: 80%; margin-top: 8px; cursor: pointer; }
.custom-dropdown .selected { padding: 16px; border-radius: 12px; border: 1px solid #ccc; background: #eaf2fb; display: flex; align-items: center; gap:10px; }
.custom-dropdown .options { display: none; position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #ccc; border-radius: 12px; z-index: 10; max-height: 200px; overflow-y: auto; }
.custom-dropdown .options div { padding: 12px; display: flex; align-items: center; gap: 10px; cursor:pointer; }
.custom-dropdown .options div:hover { background: #d6e8fc; }
.custom-dropdown.active .options { display: block; }
.checkbox-container { display: inline-flex;align-items: center;gap: 5px;cursor: pointer;font-size: 15px;}
.checkbox-container input { width: auto; accent-color: #2980b9; cursor: pointer; }
.checkbox-container .material-icons { font-size: 22px; color: #2980b9; }
.error-msg { color: #e74c3c; font-size: 14px; margin-top: 5px; display: none; }
.button-group {display: flex;justify-content: center;gap: 15px;margin-top: 25px;flex-wrap: wrap;width: 100%;box-sizing: border-box;}
button { padding: 14px 20px; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; transition: all 0.3s ease; }
.btn-cancel { background: #e74c3c; color: white; }
.btn-cancel:hover { background: #c0392b; }
.btn-submit { background:#00796B ; color: white; }
.btn-submit:hover { background:#27ae60 ; }
::placeholder { color: #95a5a6; opacity: 1; }
@media(max-width: 600px){ .image-grid { grid-template-columns: repeat(3, 1fr); } .button-group { flex-direction: column; } button { width: 100%; } }
.form-container {position: relative;}
.closeBtnX {position: absolute; top: 15px; right: 15px; font-size: 28px; color: #333; cursor: pointer; transition: 0.3s;}
.closeBtnX:hover {color: red; transform: scale(1.2);}
#title, #price, #whatsapp, #telephone {display: block; width: 80%; margin: 10px auto; border: 2px solid #2980b9 !important; border-radius: 20px !important; padding: 6px 15px; background: #fff; font-size: 17px;}
#title:focus, #price:focus, #whatsapp:focus, #telephone:focus {border-color: #00796B !important; box-shadow: 0 0 8px rgba(39, 174, 96, 0.3); outline: none;}
#categorieDropdown, #souscategorieDropdown, #cityDropdown, #quartierDropdown {display: block; width: 80%; margin: 10px auto;}
#description {display: block; width: 80%; margin: 10px auto;}
.form-section div[style*="display:flex"] {justify-content: center; gap: 30px; flex-wrap: wrap;}
label p {font-size: 20px; margin: 0;}
#livraison + .material-icons, #produitNeuf + .material-icons {color: #00796B; font-size: 50px;}
.input-left-icon {display: flex; align-items: center; width: 80%; margin: 5px auto; gap: 10px;}
.input-left-icon i {font-size: 35px; color: #25D366;}
.input-left-icon input {flex: 1; padding: 10px 12px; border-radius: 12px; border: 1px solid #2980b9; font-size: 16px;}
.input-left-icon i.fa-phone {color: #2980b9;}
.error-msg {width: 80%; margin: 0 auto 10px; color: #e74c3c; font-size: 14px; display: none;}
@media(max-width: 400px) {input, textarea, .custom-dropdown {width: 95%;}}
.custom-dropdown {position: relative;z-index: 1;}
.custom-dropdown.active {z-index: 5000;}
.custom-dropdown .options {position: absolute;top: 100%;left: 0;right: 0;background: #fff;border: 1px solid #ccc; border-radius: 12px;max-height: 200px;overflow-y: auto;}
textarea {position: relative; z-index: 1;}
</style>
</head>
<body>
<div class="form-container">
<h1>Publier une annonce</h1>      
<form id="adForm">
  <div class="form-section">
    <div class="image-grid">
      <label class="image-upload"><input type="file" name="image1" accept="image/*" onchange="previewImage(this)"><span class="material-icons">add_a_photo</span></label>
      <label class="image-upload"><input type="file" name="image2" accept="image/*" onchange="previewImage(this)"><span class="material-icons">add_a_photo</span></label>
      <label class="image-upload"><input type="file" name="image3" accept="image/*" onchange="previewImage(this)"><span class="material-icons">add_a_photo</span></label>
      <label class="image-upload"><input type="file" name="image4" accept="image/*" onchange="previewImage(this)"><span class="material-icons">add_a_photo</span></label>
      <label class="image-upload"><input type="file" name="image5" accept="image/*" onchange="previewImage(this)"><span class="material-icons">add_a_photo</span></label>
      <label class="image-upload"><input type="file" name="image6" accept="image/*" onchange="previewImage(this)"><span class="material-icons">add_a_photo</span></label>
      <label class="image-upload"><input type="file" name="image7" accept="image/*" onchange="previewImage(this)"><span class="material-icons">add_a_photo</span></label>
      <label class="image-upload"><input type="file" name="image8" accept="image/*" onchange="previewImage(this)"><span class="material-icons">add_a_photo</span></label>
      <label class="image-upload"><input type="file" name="image9" accept="image/*" onchange="previewImage(this)"><span class="material-icons">add_a_photo</span></label>
    </div>
    <div id="imagesError" class="error-msg">Veuillez sélectionner au moins 1 image.</div>
  </div>
  <div class="form-section">
    <input type="text" id="title" placeholder="Titre du produit" maxlength="30">
    <div id="titleError" class="error-msg">Veuillez saisir un titre.</div>
    <input type="text" id="price" placeholder="0 FCFA" maxlength="14">
    <div id="priceError" class="error-msg">Veuillez saisir un prix valide.</div>
    <div class="custom-dropdown" id="categorieDropdown">
      <div class="selected">Catégorie ▼</div>
      <div class="options"></div>
    </div>
    <input type="hidden" id="categorie">
    <div id="categorieError" class="error-msg">Veuillez sélectionner une catégorie.</div>
    <div class="custom-dropdown" id="souscategorieDropdown" style="display:none;">
      <div class="selected">Sous-Catégorie ▼</div>
      <div class="options"></div>
    </div>
    <input type="hidden" id="souscategorie">
    <div id="souscategorieError" class="error-msg">Veuillez sélectionner une sous-catégorie.</div>
    <div id="additionalFieldsContainer" style="width:80%; margin:10px auto;"></div>
    <div class="custom-dropdown" id="cityDropdown">
      <div class="selected">Région ▼</div>
      <div class="options"></div>
    </div>
    <input type="hidden" id="city">
    <div id="cityError" class="error-msg">Veuillez sélectionner une Région.</div>
    <div class="custom-dropdown" id="quartierDropdown" style="display:none;">
      <div class="selected">Commune ▼</div>
      <div class="options"></div>
    </div>
    <input type="hidden" id="quartier">
    <div id="quartierError" class="error-msg">Veuillez sélectionner une Commune.</div>
    <div style="display:flex; flex-wrap:wrap; gap:30px; align-items:center; font-size:20px;">
      <label style="display:flex; align-items:center; gap:10px;">
        <p>Je livre</p>
        <input type="checkbox" id="livraison" style="width:22px; height:22px;">
        <span class="material-icons" style="font-size:40px;">delivery_dining</span>
      </label>
      <label style="display:flex; align-items:center; gap:10px;">
        <p>Produit neuf</p>
        <input type="checkbox" id="produitNeuf" style="width:22px; height:22px;">
        <span class="material-icons" style="font-size:40px;">fiber_new</span>
      </label>
    </div>
    <div style="position: relative; width: 100%;">
      <textarea id="description" maxlength="650" placeholder="Description du produit (max 650 caractères)" style="width: 95%; padding-bottom:25px;  height:250px;"></textarea>
      <span id="descCount" style="position:absolute; bottom:8%; right:6%; font-size:12px; color:#555;">0 / 650</span>
    </div>
    <div id="descriptionError" class="error-msg">Veuillez saisir une description.</div>
  </div>
  <div class="form-section">
    <div class="input-left-icon">
      <i class="fa-brands fa-whatsapp"></i>
      <input type="tel" id="whatsapp" placeholder="7X 123 45 67">
    </div>
    <div id="whatsappError" class="error-msg">Veuillez saisir un numéro WhatsApp valide.</div>
    <div class="input-left-icon">
      <i class="fa-solid fa-phone"></i>
      <input type="tel" id="telephone" placeholder="7X 123 45 67">
    </div>
    <div id="telephoneError" class="error-msg">Veuillez saisir un numéro de téléphone valide.</div>
  <div class="button-group">
    <button type="reset" class="btn-cancel">Annuler</button>
    <button type="submit" class="btn-submit">Publier gratuitement</button>
  </div>
</form>
<div id="loader" style="display:none;position:fixed;top:0; left:0; right:0; bottom:0;background:rgba(0,0,0,0.4);z-index:1000;align-items:center;justify-content:center;">
  <div style="background:white;padding:30px;border-radius:12px;display:flex;flex-direction:column;align-items:center;gap:10px;">
    <span class="material-icons" style="font-size:48px; animation:spin 1s linear infinite;">autorenew</span>
    <p>Publication en cours...</p>
  </div>
</div>
<style>
@keyframes spin { from{transform:rotate(0deg);} to{transform:rotate(360deg);} }
</style>
<script>
const categorieDropdown = document.getElementById('categorieDropdown');
const categorieSelected = categorieDropdown.querySelector('.selected');
const categorieOptions = categorieDropdown.querySelector('.options');
const categorieInput = document.getElementById('categorie');
const sousDropdown = document.getElementById('souscategorieDropdown');
const sousSelected = sousDropdown.querySelector('.selected');
const sousOptions = sousDropdown.querySelector('.options');
const sousInput = document.getElementById('souscategorie');
const cityDropdown = document.getElementById('cityDropdown');
const citySelected = cityDropdown.querySelector('.selected');
const cityOptions = cityDropdown.querySelector('.options');
const cityInput = document.getElementById('city');
const quartierDropdown = document.getElementById('quartierDropdown');
const quartierSelected = quartierDropdown.querySelector('.selected');
const quartierOptions = quartierDropdown.querySelector('.options');
const quartierInput = document.getElementById('quartier');
const additionalFieldsContainer = document.getElementById("additionalFieldsContainer");
const categoryLabels = {vehicules: 'Véhicules',immobilier: 'Immobilier', electronique: 'Électronique'};
const categoryIcons = {vehicules: 'directions_car',immobilier: 'apartment',electronique: 'devices'};
let categoriesMap = {};
let quartiersDakar = [];
const additionalFields = {
  vehicules: {
    "Voitures & utilitaires": [
      { name: 'Marque', type: 'select', options: ['Toyota','Peugeot','Renault','Hyundai','Kia','Mercedes-Benz','BMW','Nissan','Mitsubishi','Ford','Volkswagen','Honda','Mazda','Suzuki','Isuzu','Acura','Alfa Romeo','Alpine','Aston Martin','Audi','BAIC','Bentley','Bugatti','Buick','BYD','Cadillac','Changan','Chery','Chevrolet','Chrysler','Citroën','Cupra','Dacia','Daewoo','Daihatsu','Datsun','Dodge','Dongfeng','DS Automobiles','FAW','Ferrari','Fiat','Fisker','Geely','Genesis','GMC','Great Wall','Haval','Holden','Hummer','Infiniti','Jaguar','Jeep','Koenigsegg','Lada','Lamborghini','Lancia','Land Rover','Lexus','Lincoln','Lotus','Lucid','Maserati','Maybach','McLaren','MG','Mini','Opel','Pagani','Polestar','Pontiac','Porsche','Proton','Ram','Rivian','Rolls-Royce','Rover','Saab','Samsung','Seat','Škoda','Smart','SsangYong','Subaru','Tata','Tesla','Vauxhall','VinFast','Volvo','Wuling','Zotye']},
      { name: 'Modèle', type: 'text' },
      { name: 'Kilométrage', type: 'number' },
      { name: 'Année',type: 'select', options: Array.from({length: 2026 - 1950 + 1}, (_, i) => (2026 - i).toString())},
      { name: 'Transmission', type: 'select', options: ['Manuelle', 'Automatique'] },
      { name: 'Carburant', type: 'select', options: ['Essence', 'Gasoil', 'Hybride', 'Électrique'] },
      {name: 'Nombre de portes',type: 'select',options: ['Nombre de portes', '2', '3', '4', '5', '6', '7']}
      ],
    "Moto & scooters": [
      {name: 'Marque',  type: 'select', options: ['Yamaha','Honda','Suzuki','TVS','Bajaj','Kawasaki','KTM','Royal Enfield','Sym','Kymco','Aprilia','Benelli','BMW Motorrad','CFMoto','Derbi','Ducati','Fantic','Harley-Davidson','Hero','Husqvarna','Indian','Jawa','Lifan','Moto Guzzi','Horex','Hyosung','Italjet','Lambretta','Mahindra','Mash','Malaguti','MV Agusta','Peugeot Scooters','Piaggio','Beverly','Triumph','Vespa','Zontes']},
      { name: 'Modèle', type: 'text' },
      { name: 'Kilométrage', type: 'number' },
      {name: 'Année',type: 'select', options: Array.from({length: 2026 - 1950 + 1}, (_, i) => (2026 - i).toString())}
      ],
    "Camion & bus": [
      { name: 'Marque',  type: 'select', options: ['Mercedes-Benz','Renault Trucks','Volvo','Isuzu','Hyundai','Mitsubishi Fuso','Tata','MAN','Scania','IVECO','Ford','DAF Trucks','Ashok Leyland','Berliet','BYD','Chevrolet','Chrysler','Daewoo','Daf','Dodge','Fiat','Freightliner','Fuso','GMC','Hino','Kamaz','Kenworth','Mack','Mahindra','Navistar','Neoplan','Nikola','Setra','UD Trucks','Western Star','ZIL']},
      { name: 'Modèle', type: 'text' },
      { name: 'Kilométrage', type: 'number' },
      {name: 'Année',type: 'select', options: Array.from({length: 2026 - 1950 + 1}, (_, i) => (2026 - i).toString())}
      ],
    "Équipements et accessoires": [],
    "Location de véhicule": [],
    "Bateaux": []},
  immobilier: {
    "Villas": [
      { name: 'Surface (m²)', type: 'number' },
      { name: 'Nombre de chambres', type: 'number' },
      { name: 'Nombre de salles de bain', type: 'number' },
      { name: 'Nombre d’étages', type: 'number' },
      { name: 'Option', type: 'select', options: ['Vente', 'Location'] },
      { name: 'État général', type: 'select', options: ['Neuf', 'Bon état', 'À rénover'] }
      ],
    "Appartements": [
      { name: 'Surface (m²)', type: 'number' },
      { name: 'Nombre de pièces', type: 'number' },
      { name: 'Nombre de salles de bain', type: 'number' },
      { name: 'Option', type: 'select', options: ['Vente', 'Location'] },
      { name: 'État général', type: 'select', options: ['Neuf', 'Bon état', 'À rénover'] }
      ],
    "Terrains": [
      { name: 'Surface (m²)', type: 'number' },
      { name: 'Option', type: 'select', options: ['Vente', 'Location'] },
      ],
    "Immeubles": [
      { name: 'Surface (m²)', type: 'number' },
      { name: 'Nombre d’étages', type: 'number' },
      { name: 'Nombre d’appartements', type: 'number' },
      { name: 'Année de construction', type: 'number' },
      { name: 'État général', type: 'select', options: ['Neuf', 'Bon état', 'À rénover'] },
      { name: 'Option', type: 'select', options: ['Vente', 'Location'] }
      ],
    "Bureaux et commerce": [
      { name: 'Surface (m²)', type: 'number' },
      { name: 'Nombre de pièces', type: 'number' },
      { name: 'Nombre de salles de bain', type: 'number', optional: true },
      { name: 'Option', type: 'select', options: ['Vente', 'Location'] },
      { name: 'État général', type: 'select', options: ['Neuf', 'Bon état', 'À rénover'] }
      ],
      "Maison de vacances": [
      { name: 'Surface (m²)', type: 'number' },
      { name: 'Nombre de pièces', type: 'number' },
      { name: 'Nombre de salles de bain', type: 'number', optional: true },
      { name: 'Option', type: 'select', options: ['Location'] }
      ],
      "Chambres": [
      { name: 'Surface (m²)', type: 'number' },
      { name: 'Nombre de pièces', type: 'number', optional: true },
      { name: 'Nombre de salles de bain', type: 'number', optional: true },
      { name: 'Option', type: 'select', options: ['Location'] }
      ],
      "Terrains agricoles": [
      { name: 'Surface (m²)', type: 'number' },
      { name: 'Type de culture', type: 'text' },
      { name: 'Option', type: 'select', options: ['Vente', 'Location'] }
      ],
      "Appartements meublés": [
      { name: 'Surface (m²)', type: 'number' },
      { name: 'Nombre de pièces', type: 'number' },
      { name: 'Nombre de salles de bain', type: 'number' },
      { name: 'Option', type: 'select', options: ['Vente', 'Location'] },
      { name: 'État général', type: 'select', options: ['Neuf', 'Bon état', 'À rénover'] }
      ],
      "Ferme et verger": [
      { name: 'Surface (m²)', type: 'number' },
      { name: 'Option', type: 'select', options: ['Vente', 'Location'] }
     ]}};
function fetchJSON(url, callback) {
  fetch(url)
    .then(res => {
      if (!res.ok) throw new Error(`Erreur chargement ${url}`);
      return res.json();})
    .then(callback)
    .catch(err => console.error(err));}
fetchJSON('../categories.json', data => {
  categoriesMap = data;
  categorieOptions.innerHTML = '';
  Object.keys(categoriesMap).forEach(catKey => {
    const catLabel = categoryLabels[catKey] || catKey.replace(/_/g,' ').replace(/\b\w/g, c => c.toUpperCase());
    const catIcon = categoryIcons[catKey] || 'folder';
    const div = document.createElement('div');
    div.dataset.value = catKey;
    div.innerHTML = `<i class="material-icons">${catIcon}</i> ${catLabel}`;
    div.addEventListener('click', () => {
      categorieSelected.innerHTML = div.innerHTML;
      categorieInput.value = catKey;
      categorieDropdown.classList.remove('active');
      updateSousCategories(catKey);
      additionalFieldsContainer.innerHTML = "";
    });
    categorieOptions.appendChild(div);
  });
});
fetchJSON('../quartiersDakar.json', data => quartiersDakar = data);
fetchJSON('../villes.json', villes => {
  cityOptions.innerHTML = '';
  villes.forEach(v => {
    const div = document.createElement('div');
    div.dataset.value = v;
    div.textContent = v;
    cityOptions.appendChild(div);
    div.addEventListener('click', () => {
      citySelected.textContent = v;
      cityInput.value = v;
      cityDropdown.classList.remove('active');
      if (v === 'Dakar') {
        quartierDropdown.style.display = 'block';
        quartierOptions.innerHTML = '';
        quartiersDakar.forEach(q => {
          const opt = document.createElement('div');
          opt.textContent = q;
          opt.dataset.value = q;
          opt.addEventListener('click', () => {
            quartierSelected.textContent = q;
            quartierInput.value = q;
            quartierDropdown.classList.remove('active');
          });
          quartierOptions.appendChild(opt);
        });
        quartierSelected.textContent = 'Commune ▼';
        quartierInput.value = '';
      } else {
        quartierDropdown.style.display = 'none';
        quartierInput.value = '';}
    });
  });
});
const dropdowns = [categorieDropdown, sousDropdown, cityDropdown, quartierDropdown];
[categorieSelected, sousSelected, citySelected, quartierSelected].forEach((el, i) => {
  el.addEventListener('click', (e) => {
    e.stopPropagation();
    dropdowns.forEach(d => d.classList.remove('active'));
    dropdowns[i].classList.add('active'); 
  });
});
function updateSousCategories(catKey) {
  sousOptions.innerHTML = '';
  sousInput.value = '';
  let subs = [];
  if (Array.isArray(categoriesMap[catKey])) subs = categoriesMap[catKey];
  else if (categoriesMap[catKey]?.sous) subs = categoriesMap[catKey].sous;
  if (!subs || subs.length === 0) {
    sousDropdown.style.display = 'none';
    additionalFieldsContainer.innerHTML = ""; 
    return;}
  subs.forEach(sc => {
    const div = document.createElement('div');
    div.dataset.value = (sc.label || '').toLowerCase();
    div.innerHTML = `<i class="material-icons">${sc.icon || 'label'}</i> ${sc.label}`;
    div.addEventListener('click', () => {
      sousSelected.innerHTML = div.innerHTML;
      sousInput.value = sc.label;
      sousDropdown.classList.remove('active');
      if(additionalFields[catKey] && additionalFields[catKey][sc.label] && additionalFields[catKey][sc.label].length > 0){
        showAdditionalFields(catKey, sc.label);
      } else {additionalFieldsContainer.innerHTML = "";}
    });
    sousOptions.appendChild(div);
  });
  sousDropdown.style.display = 'block';
  sousSelected.innerHTML = 'Sous-Catégorie ▼';
  sousInput.value = '';}
function showAdditionalFields(category, subCategory) {
  additionalFieldsContainer.innerHTML = ""; 
  const fields = additionalFields[category][subCategory];
  if (!fields || fields.length === 0) return;
  fields.forEach(fieldData => {
    const fieldWrapper = document.createElement('div');
    fieldWrapper.style.marginBottom = "10px";
    const label = document.createElement('label');
    label.textContent = fieldData.name;
    label.style.display = "block";
    label.style.marginBottom = "5px";
    fieldWrapper.appendChild(label);
    if (fieldData.type === 'text' || fieldData.type === 'number') {
      const input = document.createElement('input');
      input.type = fieldData.type;
      input.id = fieldData.name.replace(/\s+/g,'');
      input.placeholder = fieldData.name;
      input.style.width = "100%";
      fieldWrapper.appendChild(input);
    } else if (fieldData.type === 'select') {
      const dropdown = document.createElement('div');
      dropdown.classList.add('custom-dropdown');
      dropdown.style.width = "100%";
      const selected = document.createElement('div');
      selected.classList.add('selected');
      selected.textContent = `${fieldData.name} ▼`;
      dropdown.appendChild(selected);
      const optionsContainer = document.createElement('div');
      optionsContainer.classList.add('options');
      fieldData.options.forEach(optText => {
        const optionDiv = document.createElement('div');
        optionDiv.textContent = optText;
        optionDiv.dataset.value = optText;
        optionDiv.addEventListener('click', () => {
          selected.textContent = optText;
          dropdown.classList.remove('active');
          let hiddenInput = document.getElementById(fieldData.name.replace(/\s+/g,''));
          if (!hiddenInput) {
            hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.id = fieldData.name.replace(/\s+/g,'');
            additionalFieldsContainer.appendChild(hiddenInput);}
          hiddenInput.value = optText;
        });
        optionsContainer.appendChild(optionDiv);
      });
      dropdown.appendChild(optionsContainer);
      selected.addEventListener('click', e => {
        e.stopPropagation();
        additionalFieldsContainer.querySelectorAll('.custom-dropdown').forEach(dd => dd.classList.remove('active'));
        dropdown.classList.add('active');
      });
      fieldWrapper.appendChild(dropdown);}
    additionalFieldsContainer.appendChild(fieldWrapper);
  });
  document.addEventListener('click', () => {
    additionalFieldsContainer.querySelectorAll('.custom-dropdown').forEach(dd => dd.classList.remove('active'));
  });}
function getAdditionalFieldsData() {
  const data = {};
  additionalFieldsContainer.querySelectorAll('input, select').forEach(field => {
    const key = field.id;
    let value = field.value ? field.value.trim() : null;
    data[key] = value || null;
  });
  return data;}
const additionalData = getAdditionalFieldsData();
function previewImage(input) {
  if (!input.files || !input.files[0]) return;
  const reader = new FileReader();
  reader.onload = e => {
    let icon = input.parentElement.querySelector('.material-icons');
    let img = input.parentElement.querySelector('img');
    if (!img) {
      img = document.createElement('img');
      input.parentElement.appendChild(img);
      if (icon) icon.style.display = 'none';
      const removeBtn = document.createElement('span');
      removeBtn.textContent = '×';
      removeBtn.style.position = 'absolute';
      removeBtn.style.top = '2px';
      removeBtn.style.right = '2px';
      removeBtn.style.background = 'red';
      removeBtn.style.color = 'white';
      removeBtn.style.padding = '2px 6px';
      removeBtn.style.borderRadius = '50%';
      removeBtn.style.cursor = 'pointer';
      removeBtn.style.fontWeight = 'bold';
      removeBtn.addEventListener('click', () => {
        input.value = "";       
        img.remove();              
        removeBtn.remove();       
        if (icon) icon.style.display = 'block';
      });
      input.parentElement.appendChild(removeBtn);}
    img.src = e.target.result;}
  reader.readAsDataURL(input.files[0]);}
</script>
<script>
const priceInput = document.getElementById('price');
priceInput.value = ' FCFA';
priceInput.addEventListener('input', () => {
  let value = priceInput.value.replace(/\s*FCFA$/i, ''); 
  value = value.replace(/\D/g, '');
  priceInput.value = value + ' FCFA';
});
priceInput.addEventListener('click', () => {
  const pos = priceInput.value.length - 5; 
  priceInput.setSelectionRange(pos, pos);
});
priceInput.addEventListener('focus', () => {
  const pos = priceInput.value.length - 5;
  priceInput.setSelectionRange(pos, pos);
});
</script>
<script>
  function setupNumberField(id) {
    const input = document.getElementById(id);
    input.addEventListener('input', () => {
      let value = input.value.replace(/\D/g, '');
      if (value.length > 9) value = value.slice(0, 9);
      input.value = value;
    });}
  setupNumberField('whatsapp');
  setupNumberField('telephone');
</script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import { getFirestore, collection, addDoc, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyDLrPKEzDueP4j-HjAdOhmkuA74cLsCn2M",
  authDomain: "diallo-ee5aa.firebaseapp.com",
  projectId: "diallo-ee5aa",
  storageBucket: "diallo-ee5aa.firebasestorage.app",
  messagingSenderId: "662485613383",
  appId: "1:662485613383:web:c1129a35c335cc95c0ea62",
  measurementId: "G-F3092DTNZY"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);
const emailDisplay = document.createElement('p');
emailDisplay.id = 'userEmailDisplay';
emailDisplay.style.fontWeight = 'bold';
emailDisplay.style.marginTop = '15px';
document.querySelector('.form-container').prepend(emailDisplay);
onAuthStateChanged(auth, async user => {
  if(!user){
    window.location.href = "../index.html";
    return;}
  emailDisplay.textContent = "Connecté : " + user.email;
  const userDoc = await getDoc(doc(db, "users", user.uid));
  const userData = userDoc.data();
  let isSubscribed = false;
  if(userData?.subscribe === true && userData?.subscribeEnd){
    const now = new Date();
    const end = new Date(userData.subscribeEnd.seconds * 1000);
    if(end > now) isSubscribed = true;}
  const imageLabels = document.querySelectorAll('.image-upload');
  imageLabels.forEach((label, idx) => {
    if(isSubscribed || idx < 3){
      label.style.filter = "none";
      label.style.pointerEvents = "auto";
    } else {
      label.style.filter = "blur(3px) grayscale(50%)";
      label.style.pointerEvents = "auto"; 
      label.addEventListener('click', (e) => {
        e.preventDefault(); 
        showSubscribeModal();
      });}
  });
});
function showSubscribeModal() {
  const modalHTML = `
    <div id="subscribeModal" style="
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center;
      z-index: 9999;">
      <div style="background:#fff; padding:20px; border-radius:10px; max-width:400px; text-align:center;">
        <h2>Abonnement requis</h2>
        <p>Pour accéder à tous les champs d'image, vous devez vous abonner.</p>
        <button id="closeModal" style="margin-top:15px;">Fermer</button>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  document.getElementById('closeModal').addEventListener('click', () => {
    document.getElementById('subscribeModal').remove();
  });}
function escapeHTML(str) {
  if (!str) return '';
  return str.replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;");}
function resetDropdowns() {
  categorieSelected.innerHTML = 'Catégorie ▼';
  categorieInput.value = '';
  sousSelected.innerHTML = 'Sous-Catégorie ▼';
  sousInput.value = '';
  sousDropdown.style.display = 'none';
  citySelected.innerHTML = 'Région ▼';
  cityInput.value = '';
  quartierSelected.innerHTML = 'Commune ▼';
  quartierInput.value = '';
  quartierDropdown.style.display = 'none';}
function cleanAdditionalData(data) {
  const cleaned = {};
  for (let key in data) {
    if (key && data[key] !== undefined && data[key] !== "") {
      cleaned[key] = data[key];}}
  return cleaned;}
const adForm = document.getElementById('adForm');
const loader = document.getElementById('loader');
adForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  let isValid = true;
  const images = adForm.querySelectorAll('input[type="file"]');
  let selectedImages = 0;
  images.forEach(img=>{ if(img.files.length>0) selectedImages++; });
  if(selectedImages<1){ document.getElementById('imagesError').style.display='block'; isValid=false; }
  else document.getElementById('imagesError').style.display='none';
  const title = document.getElementById('title');
  const titleValue = title.value.trim();
  if(titleValue === ''){
    document.getElementById('titleError').textContent = "Veuillez saisir un titre.";
    document.getElementById('titleError').style.display='block';
    isValid=false;
} else if(titleValue.length > 30){
    document.getElementById('titleError').textContent = "Le titre ne doit pas dépasser 30 caractères.";
    document.getElementById('titleError').style.display='block';
    isValid=false;
} else {
    document.getElementById('titleError').style.display='none';}
  const categorieInput = document.getElementById('categorie');
  if(categorieInput.value===''){ document.getElementById('categorieError').style.display='block'; isValid=false; }
  else document.getElementById('categorieError').style.display='none';
  const sousInput = document.getElementById('souscategorie');
  const sousDropdown = document.getElementById('souscategorieDropdown');
  if(sousDropdown.style.display!=='none' && sousInput.value===''){ document.getElementById('souscategorieError').style.display='block'; isValid=false; }
  else document.getElementById('souscategorieError').style.display='none';
  const cityInput = document.getElementById('city');
  if(cityInput.value===''){ document.getElementById('cityError').style.display='block'; isValid=false; }
  else document.getElementById('cityError').style.display='none';
  const quartierInput = document.getElementById('quartier');
  const quartierValue = quartierInput.value;
  if(cityInput.value === 'Dakar' && quartierValue === ''){
    document.getElementById('quartierError').style.display = 'block';
    isValid = false;
  } else document.getElementById('quartierError').style.display = 'none';
  const description = document.getElementById('description');
  if(description.value.trim()===''){ document.getElementById('descriptionError').style.display='block'; isValid=false; }
  else document.getElementById('descriptionError').style.display='none';
  const whatsapp = document.getElementById('whatsapp');
  if(!/^\d{9}$/.test(whatsapp.value.trim())){ document.getElementById('whatsappError').style.display='block'; isValid=false; }
  else document.getElementById('whatsappError').style.display='none';
  const telephone = document.getElementById('telephone');
  if(!/^\d{9}$/.test(telephone.value.trim())){ document.getElementById('telephoneError').style.display='block'; isValid=false; }
  else document.getElementById('telephoneError').style.display='none';
  if(!isValid) return;
  try {
    loader.style.display = 'flex';
    const imageFiles = Array.from(images).filter(input=>input.files[0]).map(i=>i.files[0]);
    const imageUrls = [];
    const userId = auth.currentUser.uid;
    for(const file of imageFiles){
      const storageRef = ref(storage, `annonces/${userId}/${Date.now()}_${file.name}`);
      await uploadBytes(storageRef, file);
      const url = await getDownloadURL(storageRef);
      imageUrls.push(url);}
    let priceVal = document.getElementById('price').value.replace(/\s*FCFA$/i,'').trim();
    if(priceVal === ''){
    document.getElementById('priceError').textContent = "Veuillez saisir un prix.";
    document.getElementById('priceError').style.display='block';
    isValid=false;} 
    else if(priceVal.length > 14){
    document.getElementById('priceError').textContent = "Le prix ne doit pas dépasser 14 caractères.";
    document.getElementById('priceError').style.display='block';
    isValid=false;}
    else {document.getElementById('priceError').style.display='none';}
    const additionalFieldsContainer = document.getElementById('additionalFieldsContainer');
    const additionalData = {};
    if(additionalFieldsContainer){
      additionalFieldsContainer.querySelectorAll('input, select').forEach(field => {
        const key = field.id;
        let value = field.value.trim();
        if(value === '') value = null;
        additionalData[key] = value;
      });}
    const cleanedAdditionalData = cleanAdditionalData(additionalData);
    await addDoc(collection(db,'annonces'),{
      title: escapeHTML(title.value.trim()),
      price: priceVal, 
      categorie: categorieInput.value,
      souscategorie: sousInput.value,   
      city: escapeHTML(cityInput.value),
      quartier: escapeHTML(quartierInput.value.trim()),
      description: escapeHTML(description.value.trim()),
      whatsapp: '+221' + escapeHTML(whatsapp.value.trim()),
      telephone: '+221' + escapeHTML(telephone.value.trim()),
      livraison: document.getElementById('livraison').checked,
      produitNeuf: document.getElementById('produitNeuf').checked,
      images: imageUrls,
      createdAt: serverTimestamp(),
      userEmail: escapeHTML(auth.currentUser.email),
      ownerId: auth.currentUser.uid,
      isBoosted: false,
      boost: false, 
      boostEnd: null,
      ...Object.fromEntries(Object.entries(cleanedAdditionalData).map(([k,v])=>[escapeHTML(k), escapeHTML(v)]))
    });
    loader.style.display = 'none';
    M.toast({html: 'Annonce publiée avec succès !', classes: 'green darken-1'});
    adForm.reset();
resetDropdowns();
document.querySelectorAll('.image-upload').forEach(label => {
  const inputFile = label.querySelector('input[type="file"]');
  const preview = label.querySelector('img');
  const icon = label.querySelector('.material-icons');
  const removeBtn = label.querySelector('.remove-image-btn'); // le X
  if (preview) preview.remove();  
  if (removeBtn) removeBtn.remove(); 
  if (icon) icon.style.display = 'block'; 
  if (inputFile) inputFile.value = "";   
});
    document.getElementById("additionalFieldsContainer").innerHTML = "";
  } catch(err){
    loader.style.display = 'none';
    console.error("Erreur Firestore :", err);
    alert("Erreur Firestore : " + err.message);
    M.toast({html: 'Erreur lors de l\'enregistrement de l\'annonce.', classes: 'red darken-1'});}
});
</script>
<script>
const description = document.getElementById('description');
const descCount = document.getElementById('descCount');
description.addEventListener('input', () => {
  const len = description.value.length;
  descCount.textContent = `${len} / 650`;
  if (len > 650) {
    descCount.style.color = 'red';
  } else if (len > 500) {
    descCount.style.color = 'orange';
  } else {
    descCount.style.color = '#555';}
});
  document.addEventListener('click', (e) => {
    document.querySelectorAll('.custom-dropdown').forEach(dd => {
      if (!dd.contains(e.target)) {
        dd.classList.remove('active');}
    });
  });
</script>
</body>
</html>
