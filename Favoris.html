<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Favoris ‚Äì MonCoin</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
body { font-family: Arial, sans-serif; background:#f7f7f7; margin:0; padding:20px; }
h2, h3 { text-align:center; color:#00796B; margin-bottom:10px; }
.annonces-container { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:20px; }
@media (min-width:1024px){ .annonces-container { grid-template-columns: repeat(4,1fr); } }
@media (max-width:600px){ .annonces-container { grid-template-columns: repeat(2,1fr); } }
.annonce-card { background:white; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); overflow:hidden; display:flex; flex-direction:column; position:relative; cursor:pointer; }
.annonce-card img { width:100%; height:200px; object-fit:cover; }
.favorite { position:absolute; top:10px; right:10px; background:white; border-radius:50%; padding:5px; cursor:pointer; color:#00796B; box-shadow:0 2px 6px rgba(0,0,0,0.2); transition:color 0.3s; }
.favorite.active { color:red; }
.content { padding:12px; flex:1; }
.title { font-size:16px; font-weight:bold; margin:0 0 6px; color:#333; }
.price { color:#00796B; font-weight:bold; font-size:18px; margin:0 0 6px; }
.location, .date { font-size:13px; color:#555; margin:2px 0; }
.seller { display:flex; align-items:center; gap:10px; padding:10px 12px; border-top:1px solid #eee; background:#fafafa; }
.seller img { width:40px; height:40px; border-radius:50%; object-fit:cover; }
.seller-info { font-size:14px; }
.seller-info strong { display:block; }
</style>
</head>
<body>
<h2>‚≠ê Mes favoris</h2>
<h3 id="user-email"></h3>
<div id="favoris-container" class="annonces-container"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getFirestore, collection, doc, getDoc, getDocs, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDLrPKEzDueP4j-HjAdOhmkuA74cLsCn2M",
  authDomain: "diallo-ee5aa.firebaseapp.com",
  projectId: "diallo-ee5aa",
  storageBucket: "diallo-ee5aa.appspot.com",
  messagingSenderId: "662485613383",
  appId: "1:662485613383:web:c1129a35c335cc95c0ea62",
  measurementId: "G-F3092DTNZY"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();

const container = document.getElementById("favoris-container");
const emailEl = document.getElementById("user-email");

function escapeHTML(text){
  const div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML;
}

function timeAgo(timestamp){
  if(!timestamp) return "Date inconnue";
  const seconds = (Date.now() - timestamp.toDate().getTime()) / 1000;
  if(seconds < 60) return "√† l‚Äôinstant";
  const minutes = Math.floor(seconds/60);
  if(minutes < 60) return `il y a ${minutes} min`;
  const hours = Math.floor(minutes/60);
  if(hours < 24) return `il y a ${hours} h`;
  const days = Math.floor(hours/24);
  return `il y a ${days} j`;
}

onAuthStateChanged(auth, async (user) => {
  if(!user){
    window.location.href = "index.html";
    return;
  }

  emailEl.textContent = `Connect√© : ${escapeHTML(user.email)}`;
  const userRef = doc(db, "users", user.uid);
  const userSnap = await getDoc(userRef);
  let favorites = userSnap.data()?.favorites || [];

  if(favorites.length === 0){
    container.innerHTML = "<p>Vous n'avez aucun favori.</p>";
    return;
  }

  container.innerHTML = "";

  for (let favId of favorites){
    const annDoc = await getDoc(doc(db, "annonces", favId));
    if(!annDoc.exists()) continue;
    const a = annDoc.data();
    a.id = annDoc.id;

    if(!a.userId) continue;
    const sellerRef = doc(db, "users", a.userId);
    const sellerSnap = await getDoc(sellerRef);
    const sellerData = sellerSnap.exists() ? sellerSnap.data() : {};
    const fullName = sellerData.fullName || "Inconnu";
    const photo = sellerData.profileImage || "https://via.placeholder.com/40";

    const card = document.createElement("div");
    card.className = "annonce-card";

    const img = document.createElement("img");
    img.src = a.images?.[0] || 'https://via.placeholder.com/400x200?text=Annonce';
    img.alt = a.title ? escapeHTML(a.title) : "Annonce";

    const favBtn = document.createElement("span");
    favBtn.className = "material-icons favorite active";
    favBtn.textContent = "favorite";

    const content = document.createElement("div");
    content.className = "content";

    const priceEl = document.createElement("p");
    priceEl.className = "price";
    priceEl.textContent = a.price ? a.price + " FCFA" : "Prix sur demande";

    const titleEl = document.createElement("h3");
    titleEl.className = "title";
    titleEl.textContent = a.title ? a.title : "Sans titre";

    const locationEl = document.createElement("p");
    locationEl.className = "location";
    locationEl.textContent = `üìç ${a.city || "Ville non pr√©cis√©e"}${a.quartier ? ", " + a.quartier : ""}`;

    const dateEl = document.createElement("p");
    dateEl.className = "date";
    dateEl.textContent = `‚è∞ ${timeAgo(a.createdAt)}`;

    content.append(priceEl, titleEl, locationEl, dateEl);

    const sellerDiv = document.createElement("div");
    sellerDiv.className = "seller";

    const sellerImg = document.createElement("img");
    sellerImg.src = photo;
    sellerImg.alt = fullName;

    const sellerInfo = document.createElement("div");
    sellerInfo.className = "seller-info";
    const sellerName = document.createElement("strong");
    sellerName.textContent = fullName;
    sellerInfo.appendChild(sellerName);

    sellerDiv.append(sellerImg, sellerInfo);

    card.append(img, favBtn, content, sellerDiv);

    card.addEventListener("click", (e) => {
      if(e.target === favBtn) return;
      window.location.href = `Details.html?id=${a.id}`;
    });

    favBtn.addEventListener("click", async (e) => {
      e.stopPropagation();
      if(favBtn.classList.contains("active")){
        favorites = favorites.filter(favId => favId !== a.id);
        favBtn.classList.remove("active");
        favBtn.textContent = "favorite_border";
        card.remove();
      } else {
        favorites.push(a.id);
        favBtn.classList.add("active");
        favBtn.textContent = "favorite";
      }
      await updateDoc(userRef, { favorites });
    });

    container.appendChild(card);
  }
});
</script>
</body>
</html>
