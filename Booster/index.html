<!DOCTYPE html>
<html lang="fr"> 
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Booster mes annonces</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
body { font-family: Arial, sans-serif; background:#f7f7f7; margin:0; padding:20px; }
h2 {position:fixed;top:0;left:0;right:0;background:#f7f7f7;z-index:1000;text-align:center;padding:10px 0;margin:0;}
.annonces-container { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:20px;margin-top: 60px;}
@media (min-width:1024px){ .annonces-container { grid-template-columns: repeat(4,1fr); } }
@media (max-width:600px){ .annonces-container { grid-template-columns: repeat(2,1fr); } }
.annonce-card { background:white; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); overflow:hidden; display:flex; flex-direction:column; position:relative; cursor:pointer; }
.annonce-card img { width:100%; height:150px; object-fit:cover; border-radius:8px 8px 0 0; }
.content { padding:0 5px; flex:1; min-width:0; }
.title { font-size:16px; font-weight:bold; color:#333; margin:0; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; text-overflow:ellipsis; line-height:1.2em; text-align: left; }
.price { color:#00796B; font-weight:bold; font-size:18px; margin:0; line-height:1; }
.location { font-size:13px; color:#555; margin:2px 0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.annonce-card .time-badge { position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.6); color:#fff; padding:4px 8px; border-radius:6px; font-size:12px; font-weight:bold; z-index:5; }
.actions { display:flex; justify-content:space-between; padding:10px 12px; border-top:1px solid #eee; background:#fafafa; }
.actions button { background:#00796B; border:none; color:white; padding:6px 10px; border-radius:6px; cursor:pointer; font-size:13px; transition:0.3s; }
.actions button:hover { background:#004d40; }
.back-btn { position: fixed; top: 15px; right: 20px; background: #d32f2f; color: white; border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 20px; cursor: pointer; z-index: 10000; display: flex; justify-content: center; align-items: center; }
.back-btn:hover { background: #9a0007; }
@media (max-width: 600px) { .actions { flex-direction: column; gap: 8px; } } 
#boostModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.55); z-index:9999; justify-content:center; align-items:center; backdrop-filter:blur(4px); }
#boostModal .modal-content { position:relative; background:#ffffff; padding:30px 35px; border-radius:16px; max-width:420px; width:90%; box-shadow:0 6px 30px rgba(0,0,0,0.25); text-align:center; animation:modalFade .35s ease; font-family:"Poppins", Arial, sans-serif; }
@keyframes modalFade { from {opacity:0; transform:translateY(-10px) scale(0.95);} to {opacity:1; transform:translateY(0) scale(1);} }
#boostModal .brand { position:absolute; top:12px; left:18px; color:#00b050; font-weight:700; font-size:18px; letter-spacing:0.5px; }
#boostModal h3 { margin-top:5px; margin-bottom:10px; font-size:22px; font-weight:600; color:#222; }
#boostModal p.info { background:#e9f9f2; padding:12px; border-radius:10px; font-size:14px; color:#007a52; border:1px solid #b5e7c4; line-height:1.5; }
#boostModal select, #boostModal input { width:100%; padding:11px 12px; margin:8px 0 2px; border-radius:8px; border:1px solid #d1d1d1; background:#fafafa; font-size:15px; transition:all 0.2s ease-in-out; }
#boostModal select:focus, #boostModal input:focus { border-color:#00b050; background:#fff; outline:none; box-shadow:0 0 0 3px rgba(0,176,80,0.15); }
.error { color:#e53935; font-size:13px; text-align:left; margin-bottom:6px; display:none; }
#boostModal label { font-size:14px; color:#333; }
#boostModal label a { color:#00796B; text-decoration:underline; font-weight:500; }
#boostModal input[type="checkbox"] { accent-color:#00b050; }
#boostModal button { margin-top:15px; width:100%; background:linear-gradient(90deg,#00b050,#009c46); color:white; border:none; padding:12px; border-radius:8px; cursor:pointer; font-size:16px; font-weight:600; letter-spacing:0.3px; transition:background 0.25s ease, transform 0.15s; }
#boostModal button:hover { background:linear-gradient(90deg,#009643,#00b050); transform:translateY(-2px); }
#boostModal button:active { transform:translateY(0); }
@media (max-width:480px) { #boostModal .modal-content { padding:25px 20px; width:92%; } #boostModal h3 { font-size:19px; } }
#boostModal input#clientPhone { width:100%; max-width:100%; box-sizing:border-box; }
</style>
</head>
<body>

<button class="back-btn" onclick="window.history.back()">‚úñ</button>
<h2>‚ö° Boostage</h2>
<div id="annonces-container" class="annonces-container"></div>
  
<div id="boostModal">
  <div class="modal-content">
    <span class="brand">SenSold</span>
    <h3>Choisir un tarif pour booster</h3>

    <p style="background:#e0f7fa;padding:10px;border-radius:8px;">
      üì± Envoyez le paiement au num√©ro :<br>
      <strong>+221 78 173 98 14</strong><br>
      (Disponible sur Wave et Orange Money)
    </p>
    <select id="tarifSelect" required>
      <option value="">-- S√©lectionnez un tarif --</option>
      <option value="1000">1000 FCFA - 7 jours</option>
      <option value="2000">2000 FCFA - 14 jours</option>
      <option value="3000">3000 FCFA - 21 jours</option>
    </select>

    <input type="tel" id="clientPhone" placeholder="Votre num√©ro pour le paiement" required pattern="[0-9]{8,15}" title="Entrez uniquement des chiffres" />

    <select id="paymentMethod" required>
      <option value="">-- Choisir le mode de paiement --</option>
      <option value="Wave">Wave</option>
      <option value="Orange Money">Orange Money</option>
    </select>

    <div style="text-align:left;margin-top:10px;">
      <label>
        <input type="checkbox" id="acceptRules" required>
        J‚Äôai lu et j‚Äôaccepte les 
        <a href="regles-paiement.html" target="_blank" style="color:#00796B;text-decoration:underline;">
          r√®gles de paiement
        </a>.
      </label>
    </div>

    <button id="confirmBoost">Confirmer et ouvrir WhatsApp</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDLrPKEzDueP4j-HjAdOhmkuA74cLsCn2M",
  authDomain: "diallo-ee5aa.firebaseapp.com",
  projectId: "diallo-ee5aa",
  storageBucket: "diallo-ee5aa.firebasestorage.app",
  messagingSenderId: "662485613383",
  appId: "1:662485613383:web:c1129a35c335cc95c0ea62",
  measurementId: "G-F3092DTNZY"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();
const container = document.getElementById("annonces-container");

const boostModal = document.getElementById("boostModal");
const tarifSelect = document.getElementById("tarifSelect");
const confirmBoost = document.getElementById("confirmBoost");

let currentAnnonce = null;

function timeAgo(timestamp){
  if(!timestamp) return "Date inconnue";
  const seconds = (Date.now() - timestamp.toDate().getTime()) / 1000;
  if(seconds < 60) return "√† l‚Äôinstant";
  const minutes = Math.floor(seconds/60);
  if(minutes < 60) return `il y a ${minutes} min`;
  const hours = Math.floor(minutes/60);
  if(hours < 24) return `il y a ${hours} h`;
  const days = Math.floor(hours/24);
  return `il y a ${days} j`;
}

onAuthStateChanged(auth, async (user) => {
  if(!user){
    window.location.href = "../index.html";
    return;
  }

  const annoncesSnap = await getDocs(collection(db,"annonces"));
  const annonces = [];
  annoncesSnap.forEach(d=>{
    const data = d.data();
    data.id = d.id;
    if(data.userEmail && data.userEmail.toLowerCase().trim() === user.email.toLowerCase().trim()){
      annonces.push(data);
    }
  });

  if(annonces.length === 0){
    container.innerHTML = "<p>Vous n'avez publi√© aucune annonce.</p>";
    return;
  }

  annonces.sort((a,b)=>{
    if(!a.createdAt || !b.createdAt) return 0;
    return b.createdAt.toDate() - a.createdAt.toDate();
  });

  container.innerHTML = "";
  annonces.forEach(a => {
    const quartier = a.quartier ? ", " + a.quartier : "";
    const card = document.createElement("div");
    card.className = "annonce-card";

    const now = new Date();
    const boostEnd = a.boostEnd ? a.boostEnd.toDate() : null;
    const isBoosted = a.boost === true && boostEnd && boostEnd > now;

    card.innerHTML = `
      <img src="${a.images?.[0] || 'https://via.placeholder.com/400x200?text=Annonce'}" alt="${a.title || 'Annonce'}">
      <span class="time-badge">‚è∞ ${timeAgo(a.createdAt)}</span>
      <div class="content">
        <p class="price">${a.price ? a.price + " FCFA" : "Prix sur demande"}</p>
        <h3 class="title">${a.title || "Sans titre"}</h3>
        <p class="location">üìç ${a.city || "Ville non pr√©cis√©e"}${quartier}</p>
      </div>
      <div class="actions">
        <button class="boost" ${isBoosted ? "disabled style='background:#ccc; cursor:not-allowed;'" : ""}>‚ö° Booster</button>
      </div>
    `;

    const boostBtn = card.querySelector(".boost");
    if(!isBoosted){
      boostBtn.addEventListener("click", e=>{
        e.stopPropagation();
        currentAnnonce = a;
        boostModal.style.display = "flex";
      });
    }

    container.appendChild(card);
  });
});

confirmBoost.addEventListener("click", ()=>{
  if(!currentAnnonce) return;
  const tarif = tarifSelect.value.trim();
  const clientPhoneValue = document.getElementById("clientPhone").value.trim();
  const paymentMethodValue = document.getElementById("paymentMethod").value.trim();
  const acceptRules = document.getElementById("acceptRules").checked;

  if(!tarif || !clientPhoneValue || !paymentMethodValue || !acceptRules){
    alert("Veuillez remplir tous les champs et accepter les r√®gles de paiement avant de continuer.");
    return;
  }

  let duree = "";
  if(tarif === "1000") duree = "7 jours";
  else if(tarif === "2000") duree = "14 jours";
  else if(tarif === "3000") duree = "21 jours";

  const phone = "221781739814";
  const text = encodeURIComponent(
    `Bonjour, je souhaite payer le boost de mon annonce "${currentAnnonce.title}" sur *Sensold*.\n\n` +
    `AnnonceID: ${currentAnnonce.id}\n` +
    `Tarif choisi: ${tarif} FCFA (${duree})\n` +
    `Num√©ro utilis√© pour le paiement: ${clientPhoneValue}\n` +
    `Mode de paiement: ${paymentMethodValue}\n\n` +
    `‚úÖ J‚Äôai lu et accept√© les r√®gles de paiement.`
  );

  window.open(`https://wa.me/${phone}?text=${text}`,"_blank");
  boostModal.style.display = "none";
  tarifSelect.value = "";
  document.getElementById("clientPhone").value = "";
  document.getElementById("paymentMethod").value = "";
  document.getElementById("acceptRules").checked = false;
});

boostModal.addEventListener("click", e=>{
  if(e.target === boostModal) boostModal.style.display = "none";
});
document.getElementById('clientPhone').addEventListener('input', function(e){
  this.value = this.value.replace(/\D/g,''); // supprime tout ce qui n'est pas un chiffre
});
</script>
</body>
</html>
