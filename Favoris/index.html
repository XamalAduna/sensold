<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mes Favoris ‚Äì MonCoin</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
body { font-family:Arial, sans-serif; background:#f7f7f7; margin:0; padding:8px; padding-bottom:100px; }
h2 { text-align:center; margin-bottom:20px; color:#00796B; }
.annonces-container { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:20px; }
@media (min-width:1024px){ .annonces-container { grid-template-columns:repeat(4,1fr); } }
@media (max-width:600px){ .annonces-container { grid-template-columns:repeat(2,1fr); } }
.annonce-card { background:white; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); overflow:hidden; display:flex; flex-direction:column; position:relative; cursor:pointer; }
.annonce-card img { width:100%; height:150px; object-fit:cover; border-radius:8px 8px 0 0; display:block; margin-bottom:2px; }
.favorite { position:absolute; top:10px; right:10px; background:white; border-radius:50%; padding:5px; cursor:pointer; color:#00796B; box-shadow:0 2px 6px rgba(0,0,0,0.2); transition:color 0.3s; }
.favorite.active { color:red; }
.content { padding:0; flex:1; min-width:0; }
.price { color:#00796B; font-weight:bold; font-size:18px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex-shrink:0; margin:0; line-height:1; }
.title { font-size:16px; font-weight:bold; color:#333; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; text-overflow:ellipsis; white-space:normal; line-height:1.2em; margin:0; }
.location, .date { font-size:13px; color:#555; margin:2px 0; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
.seller { display:flex; align-items:center; gap:8px; padding:2px 12px; border-top:1px solid #eee; background:#fafafa; }
.seller img { width:30px; height:30px; border-radius:50%; object-fit:cover; }
.seller-info { flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; position:relative; padding-right:70px; }
.seller-info strong { display:block; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; font-size:13px; }
.loader { border:6px solid #f3f3f3; border-top:6px solid #009688; border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite; }
@keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
.annonce-card .time-badge { position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.6); color:#fff; padding:4px 8px; border-radius:6px; font-size:12px; font-weight:bold; z-index:5; }
</style>
</head>
<body>
<h2>Mes Favoris ‚ù§Ô∏è</h2>
<div id="spinner" style="display:flex; justify-content:center; align-items:center; height:200px;">
  <div class="loader"></div>
</div>
<div id="annonces" class="annonces-container"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy, doc, getDoc, updateDoc, arrayRemove } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDLrPKEzDueP4j-HjAdOhmkuA74cLsCn2M",
  authDomain: "diallo-ee5aa.firebaseapp.com",
  projectId: "diallo-ee5aa",
  storageBucket: "diallo-ee5aa.firebasestorage.app",
  messagingSenderId: "662485613383",
  appId: "1:662485613383:web:c1129a35c335cc95c0ea62",
  measurementId: "G-F3092DTNZY"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();

const annoncesContainer = document.getElementById("annonces");
let currentUser = null;
let userFavorites = [];

function escapeHTML(str){ if(!str) return ""; return str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }
function timeAgo(timestamp){ if(!timestamp) return "Date inconnue"; const seconds=(Date.now()-timestamp.toDate().getTime())/1000; if(seconds<60) return "√† l‚Äôinstant"; const minutes=Math.floor(seconds/60); if(minutes<60) return `il y a ${minutes} min`; const hours=Math.floor(minutes/60); if(hours<24) return `il y a ${hours} h`; const days=Math.floor(hours/24); return `il y a ${days} j`; }

onAuthStateChanged(auth, async (user)=>{
  currentUser = user;
  if(!user){
    annoncesContainer.innerHTML="<p style='text-align:center;color:#777;'>Connectez-vous pour voir vos favoris.</p>";
    document.getElementById("spinner").style.display="none";
    return;
  }

  const userSnap = await getDoc(doc(db,"users",user.uid));
  userFavorites = userSnap.data()?.favorites || [];

  // R√©cup√©ration de toutes les annonces
  const annoncesSnap = await getDocs(query(collection(db,"annonces"), orderBy("createdAt","desc")));
  const annoncesData = [];
  annoncesSnap.forEach(d=>{
    const data=d.data();
    data.id=d.id;
    if(userFavorites.includes(d.id)) annoncesData.push(data);
  });

  // R√©cup√©ration de tous les utilisateurs pour faire le mapping email -> user
  const usersSnap = await getDocs(collection(db,"users"));
  const usersMap = {};
  usersSnap.forEach(uDoc=>{
    const u=uDoc.data();
    if(u.email) usersMap[u.email.toLowerCase().trim()]=u;
  });

  annoncesContainer.innerHTML="";
  for(const a of annoncesData){
    const card=document.createElement("div");
    card.className="annonce-card";

    const annonceImage = escapeHTML(a.images?.[0] || "https://via.placeholder.com/400x200?text=Annonce");
    const sellerData = usersMap[(a.userEmail||"").toLowerCase().trim()] || {};
    const sellerPhoto = escapeHTML(sellerData.profileImage || "https://via.placeholder.com/40");
    const sellerName = escapeHTML(sellerData.fullName || "Utilisateur inconnu");
    const quartier = a.quartier ? ", "+escapeHTML(a.quartier) : "";

    card.innerHTML=`
      <img src="${annonceImage}" loading="lazy" alt="${escapeHTML(a.title||'Annonce')}">
      <span class="time-badge">‚è∞ ${timeAgo(a.createdAt)}</span>
      <span class="material-icons favorite active">favorite</span>
      <div class="content">
        <p class="price">${escapeHTML(a.price? a.price+" FCFA":"Prix sur demande")}</p>
        <h3 class="title">${escapeHTML(a.title||"Sans titre")}</h3>
        <p class="location">üìç ${escapeHTML(a.city||"Ville non pr√©cis√©e")}${quartier}</p>
      </div>
      <div class="seller">
        <img src="${sellerPhoto}" alt="profil vendeur">
        <div class="seller-info"><strong>${sellerName}</strong></div>
      </div>
    `;

    const favBtn = card.querySelector(".favorite");
    favBtn.addEventListener("click", async e=>{
      e.stopPropagation();
      await updateDoc(doc(db,"users",currentUser.uid), {favorites: arrayRemove(a.id)});
      card.remove();
    });

    card.addEventListener("click", ()=>{ window.location.href=`Details.html?id=${encodeURIComponent(a.id)}`; });

    annoncesContainer.appendChild(card);
  }

  document.getElementById("spinner").style.display="none";
});
</script>
</body>
</html>
