<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mes Favoris ‚Äì SenSold</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
<style>
body { font-family:Arial, sans-serif; background:#f7f7f7; margin:0; padding:8px; padding-bottom:100px; }
h2 { text-align:center; margin-bottom:20px; color:#00796B; }
.annonces-container { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:20px; }
@media (min-width:1024px){ .annonces-container { grid-template-columns:repeat(4,1fr); } }
@media (max-width:600px){ .annonces-container { grid-template-columns:repeat(2,1fr); } }
.annonce-card { background:white; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); overflow:hidden; display:flex; flex-direction:column; position:relative; cursor:pointer; }
.annonce-card img { width:100%; height:150px; object-fit:cover; border-radius:8px 8px 0 0; display:block; margin-bottom:2px; }
.favorite { position:absolute; top:10px; right:10px; background:white; border-radius:50%; padding:5px; cursor:pointer; color:#00796B; box-shadow:0 2px 6px rgba(0,0,0,0.2); transition:color 0.3s; }
.favorite.active { color:red; }
.content { padding:0; flex:1; min-width:0; }
.price { color:#00796B; font-weight:bold; font-size:18px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex-shrink:0; margin:0; line-height:1; }
.title { font-size:16px; font-weight:bold; color:#333; display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical; overflow:hidden; text-overflow:ellipsis; white-space:normal; line-height:1.2em; margin:0; }
.location, .date { font-size:13px; color:#555; margin:2px 0; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
.seller { display:flex; align-items:center; gap:8px; padding:2px 12px; border-top:1px solid #eee; background:#fafafa; }
.seller img { width:30px; height:30px; border-radius:50%; object-fit:cover; }
.seller-info { flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; position:relative; padding-right:70px; display:flex; align-items:center; min-height:30px; }
.seller-info strong { display:block; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; font-size:13px; }
.seller-info .boutique-pro {position:absolute; right:0; top:50%; transform:translateY(-50%); background:white; color:#00796B; font-size:34px; padding:6px; border-radius:6px; display:flex; align-items:center; justify-content:center;}
.material-symbols-outlined {font-variation-settings:'FILL' 0,'wght' 400,'GRAD' 0, 'opsz' 24; font-size:30px; color:#1f1f1f; }
.image-container {position:relative; display:block;}
.boost-icon {position:absolute; bottom:8px; right:8px; font-size:40px; color:#00796B; background:transparent; border-radius:0; padding:0; z-index:20; display:flex; align-items:center; justify-content:center; line-height:1;}
.time-badge {position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.6); color:#fff; padding:4px 8px; border-radius:6px; font-size:12px; font-weight:bold; z-index:5; }
.title.long-text { font-size:14px; }
.loader { border:6px solid #f3f3f3; border-top:6px solid #009688; border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite; }
@keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
#notLoggedMsg { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; padding:20px 30px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.25); text-align:center; z-index:99999; }
#notLoggedMsg a { display:inline-block; margin:8px 0; color:#009688; text-decoration:none; font-weight:bold; }
</style>
</head>
<body>
<h2>Mes Favoris</h2>
<div id="spinner" style="display:flex; justify-content:center; align-items:center; height:200px;">
  <div class="loader"></div>
</div>
<div id="annonces" class="annonces-container"></div>
<div id="notLoggedMsg">
  <p>Veuillez vous connecter pour ajouter cette annonce √† vos favoris.</p>
  <a href="login.html">Se connecter</a>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getFirestore, collection, doc, getDoc, updateDoc, arrayRemove } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDLrPKEzDueP4j-HjAdOhmkuA74cLsCn2M",
  authDomain: "diallo-ee5aa.firebaseapp.com",
  projectId: "diallo-ee5aa",
  storageBucket: "diallo-ee5aa.firebasestorage.app",
  messagingSenderId: "662485613383",
  appId: "1:662485613383:web:c1129a35c335cc95c0ea62",
  measurementId: "G-F3092DTNZY"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();

let currentUser = null;
let userFavorites = [];
let annoncesData = [];

function timeAgo(timestamp){
  if(!timestamp) return "Date inconnue";
  const seconds = (Date.now() - timestamp.toDate().getTime()) / 1000;
  if(seconds < 60) return "√† l‚Äôinstant";
  const minutes = Math.floor(seconds/60);
  if(minutes < 60) return `il y a ${minutes} min`;
  const hours = Math.floor(minutes/60);
  if(hours < 24) return `il y a ${hours} h`;
  const days = Math.floor(hours/24);
  return `il y a ${days} j`;
}

function isBoostActive(annonce) {
  if (!annonce.boost || !annonce.boostEnd) return false;
  const now = new Date();
  const boostEndDate = new Date(annonce.boostEnd.toDate ? annonce.boostEnd.toDate() : annonce.boostEnd);
  return boostEndDate > now;
}

onAuthStateChanged(auth, async (user) => {
  currentUser = user;
  if(!user){
    document.getElementById("spinner").style.display = "none";
    document.getElementById("annonces").innerHTML = "<p style='text-align:center;color:#777;'>Connectez-vous pour voir vos favoris.</p>";
    return;
  }
  const userRef = doc(db,"users",user.uid);
  const userSnap = await getDoc(userRef);
  userFavorites = userSnap.data()?.favorites || [];
  await loadFavorites();
});

async function loadFavorites(){
  annoncesData = [];
  const promises = userFavorites.map(async id => {
    const aDoc = await getDoc(doc(db,"annonces",id));
    if(aDoc.exists()) annoncesData.push(aDoc.data());
  });
  await Promise.all(promises);
  renderFavorites();
}

async function renderFavorites(){
  const container = document.getElementById("annonces");
  container.innerHTML = "";
  if(annoncesData.length === 0){
    container.innerHTML = "<p style='text-align:center;color:#777;'>Aucun favori trouv√©.</p>";
    return;
  }

  if(!window.__usersCache){
    try {
      const usersSnap = await getDocs(collection(db,"users"));
      const byEmail={}, byId={};
      usersSnap.forEach(uDoc=>{
        const u = uDoc.data() || {};
        byId[uDoc.id] = u;
        const email = (u.email||u.emailAddress||"").toLowerCase().trim();
        if(email) byEmail[email] = u;
      });
      window.__usersCache = { byEmail, byId };
    } catch(err){ window.__usersCache = { byEmail:{}, byId:{} }; console.error(err); }
  }

  annoncesData.forEach(a=>{
    const card = document.createElement("div");
    card.className = "annonce-card";

    const isFav = true; // d√©j√† favori

    // seller data
    let sellerData = null;
    const annonceEmail = (a.userEmail || "").toLowerCase().trim();
    if(annonceEmail) sellerData = window.__usersCache.byEmail[annonceEmail];
    if(!sellerData && a.userId) sellerData = window.__usersCache.byId[a.userId];
    if(!sellerData && a.uid) sellerData = window.__usersCache.byId[a.uid];
    if(!sellerData && a.user && typeof a.user==="object") sellerData = a.user;

    let isPro = false;
    if(sellerData && sellerData.subscribe === true){
      const now = new Date();
      const subEnd = sellerData.subscribeEnd?.toDate ? sellerData.subscribeEnd.toDate() : new Date(sellerData.subscribeEnd);
      if(subEnd > now) isPro = true;
    }

    let fullName = "Utilisateur inconnu";
    if(sellerData){
      fullName = `${sellerData.fullName||sellerData.displayName||sellerData.name||sellerData.prenom||"Utilisateur"}`
    }
    let sellerPhoto = (sellerData && (sellerData.profileImage || sellerData.photoURL || sellerData.avatar)) || "https://via.placeholder.com/40";

    let annonceImage = a.images?.[0] || "https://via.placeholder.com/400x200?text=Annonce";

    card.innerHTML = `
      <div class="image-container">
        <img src="${annonceImage}" alt="${a.title||'Annonce'}" loading="lazy" onerror="this.onerror=null;this.src='https://via.placeholder.com/400x200?text=Annonce'">
        ${isBoostActive(a)?'<span class="boost-icon material-symbols-outlined">arrow_shape_up</span>':''}
        <span class="time-badge">‚è∞ ${timeAgo(a.createdAt)}</span>
        <span class="material-icons favorite active">favorite</span>
      </div>
      <div class="content">
        <p class="price">${a.price ? a.price + " FCFA" : "Prix sur demande"}</p>
        <h3 class="title ${a.title.length>30?'long-text':''}">${a.title||'Sans titre'}</h3>
        <p class="location">üìç ${a.city||'Ville non pr√©cis√©e'}${a.quartier?", "+a.quartier:""}</p>
      </div>
      <div class="seller">
        <img src="${sellerPhoto}" loading="lazy" alt="profil vendeur" onerror="this.onerror=null;this.src='https://via.placeholder.com/40'">
        <div class="seller-info">
          <strong>${fullName}</strong>
          ${isPro?'<span class="boutique-pro material-symbols-outlined" title="Boutique Pro">storefront</span>':''}
        </div>
      </div>
    `;

    const favBtn = card.querySelector(".favorite");
    favBtn.addEventListener("click", async e=>{
      e.stopPropagation();
      const favRef = doc(db,"users",currentUser.uid);
      favBtn.classList.remove("active");
      favBtn.textContent="favorite_border";
      userFavorites = userFavorites.filter(id=>id!==a.id);
      await updateDoc(favRef,{favorites: arrayRemove(a.id)});
      card.remove();
    });

    card.addEventListener("click", e=>{
      if(e.target.classList.contains("favorite")) return;
      window.location.href = `Details.html?id=${encodeURIComponent(a.id)}`;
    });

    container.appendChild(card);
  });

  document.getElementById("spinner").style.display="none";
}
</script>
</body>
</html>
