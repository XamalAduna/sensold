<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"> 
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mes Favoris – Sensold</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
<style>
body { font-family:Arial, sans-serif; background:#f7f7f7; margin:0; padding:20px; padding-bottom:100px; }
h2 {position:fixed;top:0;left:0;right:0;background:#f7f7f7;z-index:1000;text-align:center;padding:10px 0;margin:0;}
.annonces-container { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:20px; margin-top:60px;}
@media (min-width:1024px){ .annonces-container { grid-template-columns:repeat(4,1fr); } }
@media (max-width:600px){ .annonces-container { grid-template-columns:repeat(2,1fr); } }
.annonce-card { background:white; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); overflow:hidden; display:flex; flex-direction:column; position:relative; cursor:pointer; }
.annonce-card img { width:100%; height:150px; object-fit:cover; border-radius:8px 8px 0 0; display:block; margin-bottom:2px; }
.favorite { position:absolute; top:10px; right:10px; background:white; border-radius:50%; padding:5px; cursor:pointer; color:#00796B; box-shadow:0 2px 6px rgba(0,0,0,0.2); transition:color 0.3s; }
.favorite.active { color:red; }
.content { padding:0 5px; flex:1; min-width:0; }
.price { color:#00796B; font-weight:bold; font-size:18px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin:0; line-height:1; }
.title { font-size:16px; font-weight:bold; color:#333; display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical; overflow:hidden; text-overflow:ellipsis; line-height:1.2em; margin:2px 0 0 0; }
.location, .date { font-size:13px; color:#555; margin:2px 0; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
.seller { display:flex; align-items:center; gap:8px; padding:2px 12px; border-top:1px solid #eee; background:#fafafa; }
.seller img { width:30px; height:30px; border-radius:50%; object-fit:cover; }
.seller-info { flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; position:relative; padding-right:70px; display:flex; align-items:center; min-height:30px; }
.seller-info strong { display:block; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; font-size:13px; }
.seller-info .boutique-pro { position:absolute; right:0; top:50%; transform:translateY(-50%); background:white; color:#00796B; font-size:34px; padding:6px; border-radius:6px; display:flex; align-items:center; justify-content:center; }
.material-symbols-outlined { font-variation-settings:'FILL' 0,'wght' 400,'GRAD' 0, 'opsz' 24; font-size:30px; color:#1f1f1f; }
.image-container { position:relative; display:block; }
.boost-icon { position:absolute; bottom:8px; right:8px; font-size:40px; color:#00796B; background:transparent; border-radius:0; padding:0; z-index:20; display:flex; align-items:center; justify-content:center; line-height:1; }
.time-badge { position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.6); color:#fff; padding:4px 8px; border-radius:6px; font-size:12px; font-weight:bold; z-index:5; }
.long-text { font-size:14px; }
.loader { border:6px solid #f3f3f3; border-top:6px solid #009688; border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite; }
@keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
#notLoggedMsg { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; padding:20px 30px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.25); text-align:center; z-index:99999; }
#notLoggedMsg a { display:inline-block; margin:8px 0; color:#009688; text-decoration:none; font-weight:bold; }
#notLoggedMsg a:hover { text-decoration:underline; }
.back-btn { position: fixed; top: 15px; right: 20px; background: #d32f2f; color: white; border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 20px; cursor: pointer; z-index: 10000; display: flex; justify-content: center; align-items: center; }
.back-btn:hover { background: #9a0007; }
#toast { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#00796B; color:white; padding:12px 20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.2); display:none; z-index:10000; font-weight:bold; }
</style>
</head>
<body>
<button class="back-btn" onclick="window.history.back()">✖</button>
<h2>Mes Favoris ❤️</h2>
<div id="spinner" style="display:flex; justify-content:center; align-items:center; height:200px;">
  <div class="loader"></div>
</div>
<div id="annonces" class="annonces-container"></div>
<div id="notLoggedMsg">
  <p>Veuillez vous connecter pour ajouter  cette annonce à vos favoris.</p>
  <a href="login.html">Se connecter</a>
</div>
<div id="toast">Annonce retirée de vos favoris</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, arrayRemove, arrayUnion, query, orderBy } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDLrPKEzDueP4j-HjAdOhmkuA74cLsCn2M",
  authDomain: "diallo-ee5aa.firebaseapp.com",
  projectId: "diallo-ee5aa",
  storageBucket: "diallo-ee5aa.firebasestorage.app",
  messagingSenderId: "662485613383",
  appId: "1:662485613383:web:c1129a35c335cc95c0ea62",
  measurementId: "G-F3092DTNZY"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();

const annoncesContainer = document.getElementById("annonces");
let currentUser = null;
let userFavorites = [];
let annoncesData = [];

function timeAgo(timestamp){
  if(!timestamp) return "Date inconnue";
  const seconds = (Date.now() - timestamp.toDate().getTime()) / 1000;
  if(seconds < 60) return "à l’instant";
  const minutes = Math.floor(seconds/60);
  if(minutes < 60) return `il y a ${minutes} min`;
  const hours = Math.floor(minutes/60);
  if(hours < 24) return `il y a ${hours} h`;
  const days = Math.floor(hours/24);
  return `il y a ${days} j`;
}

function escapeHTML(str){ if(!str) return ""; return str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }

function showToast(message){
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.style.display = "block";
  setTimeout(()=>{ toast.style.display = "none"; }, 2500);
}

function isBoostActive(annonce){
  if(!annonce.boost || !annonce.boostEnd) return false;
  const now = new Date();
  const boostEndDate = new Date(annonce.boostEnd.toDate ? annonce.boostEnd.toDate() : annonce.boostEnd);
  return boostEndDate > now;
}

onAuthStateChanged(auth, async user => {
  currentUser = user;
  if(!user){
    annoncesContainer.innerHTML = "<p>Veuillez vous connecter pour voir vos favoris.</p>";
    document.getElementById("spinner").style.display = "none";
    return;
  }
  const userRef = doc(db,"users",user.uid);
  const userSnap = await getDoc(userRef);
  userFavorites = userSnap.data()?.favorites || [];
  loadFavorites();
});

async function loadFavorites() {
  annoncesContainer.innerHTML = "";
  document.getElementById("spinner").style.display = "flex";

  try {
    const annoncesQuery = query(collection(db, "annonces"), orderBy("createdAt","desc"));
    const annoncesSnap = await getDocs(annoncesQuery);
    annoncesData = [];
    annoncesSnap.forEach(docSnap => {
      const data = docSnap.data();
      data.id = docSnap.id;
      if(userFavorites.includes(docSnap.id)) annoncesData.push(data);
    });
    if (annoncesData.length === 0){
      annoncesContainer.innerHTML = "<p>Vous n'avez aucune annonce en favoris.</p>";
      document.getElementById("spinner").style.display = "none";
      return;
    }
    if (!window.__usersCache) {
      const usersSnap = await getDocs(collection(db,"users"));
      const byEmail = {}, byId = {};
      usersSnap.forEach(uDoc => {
        const u = uDoc.data() || {};
        byId[uDoc.id] = u;
        const email = (u.email || u.emailAddress || "").toLowerCase().trim();
        if(email) byEmail[email] = u;
      });
      window.__usersCache = { byEmail, byId };
    }
    renderFavorites();
  } catch(err){
    console.error(err);
    annoncesContainer.innerHTML = "<p>Erreur de chargement des favoris.</p>";
  } finally {
    document.getElementById("spinner").style.display = "none";
  }
}

async function renderFavorites(){
  annoncesContainer.innerHTML = "";
  for(const a of annoncesData){
    const docId = escapeHTML(a.id);
    const card = document.createElement("div");
    card.className = "annonce-card";

    const isFav = currentUser && userFavorites.includes(a.id);

    let sellerData = null;
    const annonceEmail = (a.userEmail || "").toLowerCase().trim();
    if(annonceEmail) sellerData = window.__usersCache.byEmail[annonceEmail];
    if(!sellerData && a.userId) sellerData = window.__usersCache.byId[a.userId];
    if(!sellerData && a.uid) sellerData = window.__usersCache.byId[a.uid];
    if(!sellerData && a.user && typeof a.user === "object") sellerData = a.user;

    let isPro = false;
    if(sellerData && sellerData.subscribe === true){
      const now = new Date();
      const subEnd = sellerData.subscribeEnd?.toDate ? sellerData.subscribeEnd.toDate() : new Date(sellerData.subscribeEnd);
      if(subEnd > now) isPro = true;
    }

    let fullName = "Utilisateur inconnu";
    if(sellerData){
      fullName = escapeHTML(
        sellerData.fullName ||
        `${sellerData.firstName || sellerData.prenom || ""} ${sellerData.lastName || sellerData.nom || ""}`.trim() ||
        sellerData.displayName ||
        sellerData.name ||
        sellerData.nom ||
        sellerData.prenom ||
        "Utilisateur"
      );
    }

    let sellerPhoto = (sellerData && (
      sellerData.profileImage || sellerData.profilePic || sellerData.profile || sellerData.photoURL || sellerData.avatar || sellerData.image || sellerData.photo
    )) || "";
    if(!sellerPhoto || typeof sellerPhoto !== "string" || sellerPhoto.startsWith("gs://") || sellerPhoto.startsWith("/")){
      sellerPhoto = "https://via.placeholder.com/40";
    }
    sellerPhoto = escapeHTML(sellerPhoto);
    let annonceImage = escapeHTML(a.images?.[0] || "https://via.placeholder.com/400x200?text=Annonce");

    card.innerHTML = `
    <div class="image-container">
      <img src="${annonceImage}" loading="lazy" alt="${escapeHTML(a.title || 'Annonce')}" onerror="this.onerror=null;this.src='https://via.placeholder.com/400x200?text=Annonce'">
      ${isBoostActive(a) ? '<span class="boost-icon material-symbols-outlined">arrow_shape_up</span>' : ''}
      <span class="time-badge">⏰ ${timeAgo(a.createdAt)}</span>
      <span class="material-icons favorite ${isFav?'active':''}">${isFav?'favorite':'favorite_border'}</span>
    </div>
    <div class="content">
      <p class="price">${escapeHTML(a.price ? a.price + " FCFA" : "Prix sur demande")}</p>
      <h3 class="title">${escapeHTML(a.title || "Sans titre")}</h3>
      <p class="location">📍 ${escapeHTML(a.city || "Ville non précisée")}${a.quartier ? ", "+escapeHTML(a.quartier):""}</p>
    </div>
    <div class="seller">
      <img src="${sellerPhoto}" loading="lazy" alt="profil vendeur" onerror="this.onerror=null;this.src='https://via.placeholder.com/40'">
      <div class="seller-info">
        <strong>${fullName}</strong>
        ${isPro?'<span class="boutique-pro material-symbols-outlined" title="Boutique Pro">storefront</span>':''}
      </div>
    </div>
    `;
    const favBtn = card.querySelector(".favorite");
    favBtn.addEventListener("click", async e=>{
      e.stopPropagation();
      if(!currentUser){
        const msg = document.getElementById("notLoggedMsg");
        msg.style.display = "block";
        setTimeout(()=>{msg.style.display="none";},3000);
        return;
      }
      const favRef = doc(db,"users",currentUser.uid);
      if(favBtn.classList.contains("active")){
        favBtn.classList.remove("active");
        favBtn.textContent = "favorite_border";
        userFavorites = userFavorites.filter(id=>id!==docId);
        await updateDoc(favRef,{favorites:arrayRemove(docId)});
        card.remove(); // retire la carte du favoris
        showToast("Annonce retirée de vos favoris");
      } else {
        favBtn.classList.add("active");
        favBtn.textContent = "favorite";
        userFavorites.push(docId);
        await updateDoc(favRef,{favorites:arrayUnion(docId)});
      }
    });
    card.addEventListener("click", e=>{
      if(e.target.classList.contains("favorite")) return;
      if(!a.id) return console.error("Annonce sans ID :", a);
      window.location.href=`../Details.html?id=${encodeURIComponent(a.id)}`;
    });
    annoncesContainer.appendChild(card);
  }
}
</script>
</body>
</html>
