<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profil du vendeur – MonCoin</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
body { font-family: Arial, sans-serif; background:#f7f7f7; margin:0; padding:20px;}
.container { max-width:800px; margin:0 auto; background:white; border-radius:12px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,0.1);padding-bottom: 75px;}
.seller-info { display:flex; align-items:center; gap:15px; margin-bottom:20px; }
.seller-info img { width:80px; height:80px; border-radius:50%; object-fit:cover; }
.annonces { display:flex; flex-direction:column; gap:15px; }
.annonce { display:flex; gap:15px; padding:10px; border:1px solid #ddd; border-radius:8px; background:#f9f9f9; align-items:center; cursor:pointer; transition:0.2s; }
.annonce:hover { background:#e0f2f1; }
.annonce img { width:120px; height:90px; object-fit:cover; border-radius:8px; }
.annonce h3 { margin:0; color:#00796B; }
.annonce-info { display:flex; flex-direction:column; gap:5px; }
.seller-info div { flex:1 1 auto; min-width:0; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
.seller-info div strong, .seller-info div p { display:block; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
.message { text-align:center; color:#666; padding:20px; }
</style>
</head>
<body>
<div class="container">
  <div class="seller-info" id="seller-info"></div>
  <h2>Les annonces de ce vendeur</h2>
  <div class="annonces" id="seller-annonces"></div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getFirestore, doc, getDoc, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
const firebaseConfig = {
  apiKey: "AIzaSyDLrPKEzDueP4j-HjAdOhmkuA74cLsCn2M",
  authDomain: "diallo-ee5aa.firebaseapp.com",
  projectId: "diallo-ee5aa",
  storageBucket: "diallo-ee5aa.firebasestorage.app",
  messagingSenderId: "662485613383",
  appId: "1:662485613383:web:c1129a35c335cc95c0ea62",
  measurementId: "G-F3092DTNZY"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

function escapeHTML(str) {
  return str
    ? str.replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;")
    : "";
}

const params = new URLSearchParams(window.location.search);
const uid = params.get('uid');

async function loadSellerProfile() {
  try {
    const sellerRef = doc(db, "users", uid);
    const sellerSnap = await getDoc(sellerRef);
    const seller = sellerSnap.exists() ? sellerSnap.data() : {};

    const isPro = seller.subscribe === true && seller.subscribeEnd && seller.subscribeEnd.toDate() > new Date();
    const sellerDiv = document.getElementById('seller-info');
sellerDiv.innerHTML = `
  <img src="${isValidImageURL(seller.profileImage) ? seller.profileImage : 'https://via.placeholder.com/80'}" alt="Profil">
  <div style="display:flex; align-items:center; gap:6px;">
    <strong>${escapeHTML(seller.fullName) || "Inconnu"}</strong>
    ${isPro ? '<span class="material-symbols-outlined" title="Boutique Pro" style="color:#00796B;font-size:28px;">storefront</span>' : ''}
  </div>
`;


    const annoncesSnap = await getDocs(query(collection(db,"annonces"), where("ownerId","==",uid)));
    const annoncesDiv = document.getElementById('seller-annonces');
    annoncesDiv.innerHTML = '';

    if(annoncesSnap.empty){
      annoncesDiv.innerHTML = `<div class="message">Ce vendeur n’a publié aucune annonce.</div>`;
      return;
    }

    annoncesSnap.forEach(doc => {
      try {
        const data = doc.data();
        if(!data) return;

        const mainImage = Array.isArray(data.images) && data.images.length > 0 
          ? data.images[0] 
          : 'https://via.placeholder.com/120x90?text=Pas+d\'image';

        const annonceElem = document.createElement('div');
        annonceElem.className = 'annonce';

        const imgElem = document.createElement('img');
        imgElem.src = mainImage;
        imgElem.alt = "Image annonce";
        imgElem.loading = "lazy";

        const infoDiv = document.createElement('div');
        infoDiv.className = 'annonce-info';
        infoDiv.innerHTML = `
          <h3>${escapeHTML(data.title || 'Sans titre')}</h3>
          <p>Prix: ${data.price ? escapeHTML(data.price) + " FCFA" : "Prix sur demande"}</p>
        `;

        annonceElem.appendChild(imgElem);
        annonceElem.appendChild(infoDiv);

        annonceElem.addEventListener('click', () => {
          window.location.href = `Details.html?id=${encodeURIComponent(doc.id)}`;
        });

        annoncesDiv.appendChild(annonceElem);

      } catch(e) {
        console.warn("Annonce ignorée à cause d'une erreur:", e);
      }
    });

  } catch(err) {
    console.error("Erreur chargement profil vendeur:", err);
    document.getElementById('seller-annonces').innerHTML = `<div class="message">Erreur lors du chargement des annonces.</div>`;
  }
}
loadSellerProfile();
</script>
</body>
</html>
