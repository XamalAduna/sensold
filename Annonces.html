
<!DOCTYPE html> 
<html lang="fr"> 
<head> 
<meta charset="UTF-8"> 
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Annonces</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
<style>
body { font-family:Arial, sans-serif; background:#f7f7f7; margin:0; padding:8px; padding-bottom:100px; }
h2 { text-align:center; margin-bottom:20px; color:#00796B; }
.annonces-container { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:20px; }
@media (min-width:1024px){ .annonces-container { grid-template-columns:repeat(4,1fr); } }
@media (max-width:600px){ .annonces-container { grid-template-columns:repeat(2,1fr); } }
.annonce-card { background:white; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); overflow:hidden; display:flex; flex-direction:column; position:relative; cursor:pointer; }
.annonce-card img { width:100%; height:150px; object-fit:cover; border-radius:8px 8px 0 0; display:block; margin-bottom:2px; }
.favorite { position:absolute; top:10px; right:10px; background:white; border-radius:50%; padding:5px; cursor:pointer; color:#00796B; box-shadow:0 2px 6px rgba(0,0,0,0.2); transition:color 0.3s; }
.favorite.active { color:red; }
.content { padding:0; flex:1; min-width:0; }
.price { color:#00796B; font-weight:bold; font-size:18px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex-shrink:0; margin:0; line-height:1; }
.title { font-size:16px; font-weight:bold; color:#333; display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical; overflow:hidden; text-overflow:ellipsis; white-space:normal; line-height:1.2em; margin:0; }
.location, .date { font-size:13px; color:#555; margin:2px 0; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
.seller { display:flex; align-items:center; gap:8px; padding:2px 12px; border-top:1px solid #eee; background:#fafafa; }
.seller img { width:30px; height:30px; border-radius:50%; object-fit:cover; }
.search-bar { display:flex; flex-direction:row; align-items:center; justify-content:center; gap:10px; margin-bottom:10px; width:100%; }
.search-box { flex:0 1 auto; max-width:600px; }
#search-input { width:100%; padding:12px 50px 12px 16px; font-size:16px; border-radius:10px; border:1px solid #ccc; box-sizing:border-box; outline:none; transition:border 0.3s ease; }
#search-input:focus { border-color:#009688; }
.search-btn { position:absolute; right:12px; top:50%; transform:translateY(-50%); cursor:pointer; color:#009688; font-size:24px; transition:color 0.3s ease; }
.search-btn:hover { color:#004d40; }
.suggestions { position:absolute; top:100%; left:0; right:0; background:white; border:1px solid #ccc; border-top:none; max-height:200px; overflow-y:auto; z-index:1000; border-radius:0 0 8px 8px; }
.suggestion-item { padding:10px 12px; cursor:pointer; font-size:15px; }
.suggestion-item:hover { background:#f0f0f0; }
.price-filters { display:flex; gap:10px; justify-content:center; align-items:center; width:100%; max-width:300px; }
.price-btn { border:1px solid #ccc; border-radius:8px; padding:6px 12px; background:white; cursor:pointer; color:#00796B; display:flex; flex-direction:row; align-items:center; gap:6px; font-size:14px; transition:0.2s ease; }
.price-btn .material-icons { font-size:18px; }
.price-btn span.label { font-size:13px; color:#333; }
.price-btn:hover { background:#f0f0f0; color:#004d40; }
.categories { margin:20px 0; text-align:center; margin-top:5px; }
.center-title { margin-bottom:15px; font-weight:bold; font-size:18px; color:#222; }
.categories-wrapper { display:flex; justify-content:center; }
.categories-scroll { display:flex; overflow-x:auto; gap:20px; padding:15px; max-width:650px; scrollbar-width:thin; }
.categories-scroll::-webkit-scrollbar { height:6px; }
.categories-scroll::-webkit-scrollbar-thumb { background:#009688; border-radius:10px; }
.category { flex:0 0 auto; text-align:center; width:60px; background:#fff; border-radius:12px; padding:13px; transition:transform 0.3s ease, box-shadow 0.3s ease; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.1); text-decoration:none; color:inherit; display:flex; flex-direction:column; align-items:center; }
.category:hover { transform:translateY(-5px); box-shadow:0 4px 10px rgba(0,0,0,0.15); }
.category i { font-size:28px; color:gray; margin-bottom:5px; display:block; }
.category p { font-size:11px; color:#333; margin:0; }
.category.clicked { animation:bounce 0.4s ease; }
@keyframes bounce { 0% { transform:scale(1); } 30% { transform:scale(0.9); } 60% { transform:scale(1.05); } 100% { transform:scale(1); } }
.subcategories { display:flex; flex-wrap:wrap; gap:15px; justify-content:center; margin-top:15px; padding:10px; }
.subcategory { flex:0 0 auto; width:120px; text-align:center; background:#fff; border-radius:10px; padding:12px; box-shadow:0 2px 5px rgba(0,0,0,0.1); cursor:pointer; transition:transform 0.2s ease, box-shadow 0.2s ease; }
.subcategory:hover { transform:translateY(-4px); box-shadow:0 4px 8px rgba(0,0,0,0.15); }
.subcategory i { font-size:26px; color:#009688; margin-bottom:5px; }
.subcategory p { font-size:13px; margin:0; color:#333; }
.category.active { background:#1976d2; color:white; border-radius:8px; }
.category.active i { color:white; }
#notLoggedMsg { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; padding:20px 30px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.25); text-align:center; z-index:99999; }
#notLoggedMsg a { display:inline-block; margin:8px 0; color:#009688; text-decoration:none; font-weight:bold; }
#notLoggedMsg a:hover { text-decoration:underline; }
.seller-info { flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; position:relative; padding-right:70px; }
.seller-info strong { display:block; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; font-size:13px; }
.loader { border:6px solid #f3f3f3; border-top:6px solid #009688; border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite; }
@keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
.annonce-card .time-badge { position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.6); color:#fff; padding:4px 8px; border-radius:6px; font-size:12px; font-weight:bold; z-index:5; }
.annonce-card .title { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; text-overflow:ellipsis; font-size:16px; line-height:1.2em; }
.annonce-card .title.long-text { font-size:14px; }
.location { line-height:1.2; }
.annonce-card .price, .annonce-card .title { margin:0 5px; line-height:1.2; }
.seller-info { position: relative;overflow: hidden;white-space: nowrap;text-overflow: ellipsis; padding-right: 70px;min-height: 30px; display: flex; align-items: center; }
.seller-info .boutique-pro {position: absolute;right: 0;top: 50%;transform: translateY(-50%);background: white;color: #00796B;font-size: 34px;padding: 6px;border-radius: 6px;display: flex;align-items: center;justify-content: center;}
.material-symbols-outlined {font-variation-settings:'FILL' 0,'wght' 400,'GRAD' 0, 'opsz' 24; font-size: 30px; color: #1f1f1f; }
.image-container {position: relative; display: block;}
.boost-icon {position: absolute;bottom: 8px;right: 8px;font-size: 40px;color: #00796B;background: transparent; border-radius: 0; padding: 0; z-index: 20;display: flex; align-items: center;justify-content: center; line-height: 1;}
</style>
</head>
<body>
<div class="search-bar" style="display:flex; align-items:center; gap:10px;">
  <div class="search-box" style="flex:1; display:flex; align-items:center; position:relative;">
    <input type="text" id="search-input" placeholder="Rechercher..." style="flex:1; padding:8px 36px 8px 12px; border:1px solid #ccc; border-radius:8px;">
    <span class="material-icons search-btn" id="search-btn" style="position:absolute; right:8px; cursor:pointer; color:#009688;">search</span>
    <div id="suggestions" class="suggestions" style="display:none;"></div>
  </div>
  <span id="filter-toggle" class="material-icons" style="cursor:pointer; color:#009688; font-size:28px;">
    filter_list
  </span>
</div>
<div id="filter-menu" style="display:none; margin-top:6px; background:#fff; border:1px solid #ccc; border-radius:8px; padding:6px; width:200px; box-shadow:0 2px 6px rgba(0,0,0,0.15);">
  <button class="price-btn" id="price-asc">
    <span class="material-icons">arrow_upward</span>
    <span class="label">Prix ‚Üë</span>
  </button>
  <button class="price-btn" id="price-desc">
    <span class="material-icons">arrow_downward</span>
    <span class="label">Prix ‚Üì</span>
  </button>
</div>
<section class="categories">
  <div class="categories-wrapper">
    <div class="categories-scroll">
     
      <div class="category" data-cat="all">
         <i class="material-icons">apps</i>
        <p>Tous</p>
      </div>
      <div class="category" data-cat="vehicules">
        <i class="material-icons">directions_car</i>
        <p>V√©hicules</p>
      </div>
      <div class="category" data-cat="electronique">
        <i class="material-icons">devices</i>
        <p>√âlectronique</p>
      </div>
      <div class="category" data-cat="immobilier">
        <i class="material-icons">home</i>
        <p>Immobilier</p>
      </div>
      <div class="category" data-cat="mode">
        <i class="material-icons">checkroom</i>
        <p>Mode & Beaut√©</p>
      </div>
      <div class="category" data-cat="electromenager">
        <i class="material-icons">kitchen</i>
        <p>√âlectrom√©nager</p>
      </div>
      <div class="category" data-cat="maison">
        <i class="material-icons">king_bed</i>
        <p>Pour la maison</p>
      </div>
      <div class="category" data-cat="emplois">
        <i class="material-icons">work</i>
        <p>Emplois</p>
      </div>
      <div class="category" data-cat="services">
        <i class="material-icons">handshake</i>
        <p>Services</p>
      </div>
      <div class="category" data-cat="sports_loisirs">
        <i class="material-icons">sports_basketball</i>
        <p>Sports & Loisirs</p>
      </div>
      <div class="category" data-cat="alimentation">
        <i class="material-icons">restaurant</i>
        <p>Alimentation</p>
      </div>
      <div class="category" data-cat="animaux">
        <i class="material-icons">pets</i>
        <p>Animaux</p>
      </div>
      <div class="category" data-cat="materiel_pro">
        <i class="material-icons">build</i>
        <p>Mat√©riel Pro</p>
      </div>
    </div>
  </div>
  <div id="subcategories-container"></div>
</section>
<div id="spinner" style="display:flex; justify-content:center; align-items:center; height:200px;">
  <div class="loader"></div>
</div>
<div id="annonces" class="annonces-container"></div>
<div id="notLoggedMsg" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; padding:20px 30px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.25); text-align:center; z-index:99999;">
  <p>Veuillez vous connecter pour ajouter ‚ÄØcette annonce √† vos favoris.</p>
  <a href="login.html">Se connecter</a>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy, limit, doc, updateDoc, arrayUnion, arrayRemove, getDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
const firebaseConfig = {
  apiKey: "AIzaSyDLrPKEzDueP4j-HjAdOhmkuA74cLsCn2M",
  authDomain: "diallo-ee5aa.firebaseapp.com",
  projectId: "diallo-ee5aa",
  storageBucket: "diallo-ee5aa.firebasestorage.app",
  messagingSenderId: "662485613383",
  appId: "1:662485613383:web:c1129a35c335cc95c0ea62",
  measurementId: "G-F3092DTNZY"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();
const categoriesData = {
  "vehicules": [
    {"label": "Voitures & utilitaires", "icon": "directions_car"},
    {"label": "Moto & scooters", "icon": "motorcycle"},
    {"label": "Camion & bus", "icon": "local_shipping"},
    {"label": "√âquipements et accessoires", "icon": "build"},
    {"label": "Location de v√©hicule", "icon": "key"},
    {"label": "Bateaux", "icon": "sailing"}
  ],
  "immobilier": [
    {"label": "Villas", "icon": "villa"},
    {"label": "Terrains", "icon": "terrain"},
    {"label": "Appartements", "icon": "apartment"},
    {"label": "Immeubles", "icon": "domain"},
    {"label": "Bureaux et commerce", "icon": "business"},
    {"label": "Maison de vacances", "icon": "holiday_village"},
    {"label": "Chambres", "icon": "bedroom_parent"},
    {"label": "Terrains agricoles", "icon": "agriculture"},
    {"label": "Appartements meubl√©s", "icon": "home_filled"},
    {"label": "Ferme et verger", "icon": "agriculture"}
  ],
  "electronique": [
    { "label": "T√©l√©phones & Tablettes", "icon": "smartphone" },
    { "label": "Ordinateurs", "icon": "computer" },
    { "label": "Son, Hifi & Casques", "icon": "headphones" },
    { "label": "Accessoires Informatiques", "icon": "keyboard" },
    { "label": "Jeux vid√©o & Consoles", "icon": "sports_esports" },
    { "label": "Accessoires T√©l√©phonie", "icon": "phone_iphone" },
    { "label": "TV, box & Vid√©o projecteurs", "icon": "tv" },
    { "label": "Appareils photos et Cam√©ras", "icon": "photo_camera" },
    { "label": "Montres connect√©es & GPS", "icon": "watch" },
    { "label": "Imprimantes & Photocopieurs", "icon": "print" },
    { "label": "Autres √©lectronique", "icon": "devices_other" }
  ],
  "mode": [
    { "label": "V√™tements Homme", "icon": "checkroom" },
    { "label": "V√™tements Femme", "icon": "checkroom" },
    { "label": "Chaussures Homme", "icon": "hiking" },
    { "label": "Chaussures Femme", "icon": "hiking" },
    { "label": "Montres & Bijoux", "icon": "watch" },
    { "label": "Cosm√©tique & Parfums", "icon": "spa" },
    { "label": "Maroquinerie & Bagagerie", "icon": "work" },
    { "label": "Accessoires cheveux, Coiffure & Cils", "icon": "content_cut" },
    { "label": "Tissus & Foulards", "icon": "texture" },
    { "label": "Lingerie", "icon": "favorite" },
    { "label": "Lunettes", "icon": "visibility" },
    { "label": "Autres accessoires", "icon": "more_horiz" }
  ],
  "electromenager": [
    { "label": "Cuisini√®res, Gazini√®res & Fours", "icon": "kitchen" },
    { "label": "R√©frig√©rateurs & Cong√©lateurs", "icon": "ac_unit" },
    { "label": "Climatiseurs & ventilateurs", "icon": "air" },
    { "label": "Machine √† laver vaisselles & linges", "icon": "local_laundry_service" },
    { "label": "Petit √©lectrom√©nager", "icon": "blender" },
    { "label": "Autre √©lectrom√©nager", "icon": "devices_other" }
  ],
  "maison": [
    { "label": "Meubles", "icon": "weekend" },
    { "label": "Vaisselle", "icon": "restaurant" },
    { "label": "D√©coration & luminaires", "icon": "lightbulb" },
    { "label": "Linges de maison", "icon": "hotel" },
    { "label": "Jardin & Piscine", "icon": "pool" },
    { "label": "Bricolage", "icon": "build" },
    { "label": "Literie & Matelas", "icon": "bed" },
    { "label": "Autres pour la maison", "icon": "home" }
  ],
  "emplois": [
    { "label": "Offre d'emploi", "icon": "work" },
    { "label": "Demande d'emploi", "icon": "search" },
    { "label": "Formation", "icon": "school" }
  ],
  "services": [
    { "label": "Covoiturage", "icon": "directions_car" },
    { "label": "Cours particuliers", "icon": "school" },
    { "label": "Babysitting et nounou", "icon": "child_care" },
    { "label": "M√©nage & Cuisine", "icon": "cleaning_services" },
    { "label": "Courses, livraisons & d√©m√©nagement", "icon": "local_shipping" },
    { "label": "Travaux, bricolage et jardinage", "icon": "construction" },
    { "label": "Services Web, Design & Photo", "icon": "photo_camera" },
    { "label": "Services Mode, Beaut√© & Bien-√™tre", "icon": "spa" },
    { "label": "Autres services", "icon": "miscellaneous_services" }
  ],
  "enfant": [
    { "label": "V√™tements Enfants", "icon": "checkroom" },
    { "label": "Chaussures Enfants", "icon": "hiking" },
    { "label": "Mobilier & √âquipement b√©b√©", "icon": "crib" },
    { "label": "Jeux et Jouets", "icon": "toys" },
    { "label": "Fournitures Scolaires", "icon": "menu_book" },
    { "label": "Autres", "icon": "child_friendly" }
  ],
  "sports_loisirs": [
    { "label": "DVDs, CDs & Livres", "icon": "library_books" },
    { "label": "V√©los & Trottinettes", "icon": "directions_bike" },
    { "label": "Instruments de musique", "icon": "music_note" },
    { "label": "Sport & Fitness", "icon": "fitness_center" },
    { "label": "√âv√©nements", "icon": "event" },
    { "label": "Art & Artisanat", "icon": "palette" },
    { "label": "Voyage & Tourisme", "icon": "flight_takeoff" },
    { "label": "Autres Sports & Loisirs", "icon": "sports" }
  ],
  "alimentation": [],
  "animaux": [
    { "label": "Chiens", "icon": "pets" },
    { "label": "Moutons", "icon": "yard" },
    { "label": "Poules, Lapins & Pigeons", "icon": "egg" },
    { "label": "Mat√©riel pour animaux", "icon": "pets" },
    { "label": "Autres animaux", "icon": "eco" }
  ],
  "materiel_pro": [
    { "label": "Mat√©riel Agricole", "icon": "agriculture" },
    { "label": "Transport & Manutention", "icon": "local_shipping" },
    { "label": "Mat√©riaux Construction, BTP, Outillages", "icon": "construction" },
    { "label": "Fournitures de Bureaux", "icon": "business_center" },
    { "label": "Mat√©riel March√©s & Commerces", "icon": "store" },
    { "label": "Mat√©riel M√©dical", "icon": "medical_services" },
    { "label": "√ânergie, Groupes √âlectrog√®ne & Panneaux solaires", "icon": "battery_charging_full" },
    { "label": "Cam√©ras et Mat√©riel de surveillance", "icon": "videocam" },
    { "label": "Autre mat√©riel professionnel", "icon": "miscellaneous_services" }
  ]
};

// ------------------------ INITIALISATION ------------------------
const annoncesContainer = document.getElementById("annonces");
const subContainer = document.getElementById("subcategories-container");
const categoryElements = document.querySelectorAll(".category");
const suggestionsBox = document.getElementById("suggestions");

const filterToggle = document.getElementById("filter-toggle");
const filterMenu = document.getElementById("filter-menu");
const priceAscBtn = document.getElementById("price-asc");
const priceDescBtn = document.getElementById("price-desc");

let currentUser = null;
let userFavorites = [];
let annoncesData = []; // pour cache local
let selectedCategory = "all";
let selectedSubcategory = null;
let searchText = "";
let sortOrder = "default";
let lastVisible = null; // pour infinite scroll Firestore
const annoncesPerBatch = 50; // nombre d'annonces par batch (lazy loading)

// ------------------------ UTILITAIRES ------------------------
function timeAgo(timestamp){
  if(!timestamp) return "Date inconnue";
  const seconds = (Date.now() - timestamp.toDate().getTime()) / 1000;
  if(seconds < 60) return "√† l‚Äôinstant";
  const minutes = Math.floor(seconds/60);
  if(minutes < 60) return `il y a ${minutes} min`;
  const hours = Math.floor(minutes/60);
  if(hours < 24) return `il y a ${hours} h`;
  const days = Math.floor(hours/24);
  return `il y a ${days} j`;
}

function escapeHTML(str) {
  if (!str) return "";
  return str.replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;");
}

function isBoostActive(annonce) {
  if (!annonce.boost || !annonce.boostEnd) return false;
  const now = new Date();
  const boostEndDate = new Date(annonce.boostEnd.toDate ? annonce.boostEnd.toDate() : annonce.boostEnd);
  return boostEndDate > now;
}

// ------------------------ AUTHENTIFICATION ------------------------
onAuthStateChanged(auth, async (user) => {
  currentUser = user;
  if(user){
    const userSnap = await getDoc(doc(db,"users",user.uid));
    userFavorites = userSnap.data()?.favorites || [];
  } else userFavorites = [];
  resetAnnonces();
});

// ------------------------ CHARGEMENT DES ANNONCES ------------------------
async function fetchAnnoncesBatch() {
  const batchQuery = query(
    collection(db, "annonces"),
    orderBy("boostEnd", "desc"), // boost√© d'abord
    orderBy("createdAt", "desc"),
    limit(annoncesPerBatch),
    lastVisible ? startAfter(lastVisible) : undefined
  );

  const snap = await getDocs(batchQuery);
  if(snap.empty) return [];

  lastVisible = snap.docs[snap.docs.length -1];
  const batch = snap.docs.map(docSnap => {
    const data = docSnap.data();
    data.id = docSnap.id;
    return data;
  });
  return batch;
}

// ------------------------ RENDER ANNONCE ------------------------
async function renderAnnoncesBatch(batch){
  if(!window.__usersCache){
    const usersSnap = await getDocs(collection(db, "users"));
    const byEmail = {};
    const byId = {};
    usersSnap.forEach(uDoc => {
      const u = uDoc.data() || {};
      byId[uDoc.id] = u;
      const email = (u.email || u.emailAddress || "").toLowerCase().trim();
      if(email) byEmail[email] = u;
    });
    window.__usersCache = { byEmail, byId };
  }

  for(const a of batch){
    const docId = escapeHTML(a.id || "");
    const card = document.createElement("div");
    card.className = "annonce-card";

    const isFav = currentUser && userFavorites.includes(a.id);

    let sellerData = null;
    const annonceEmail = (a.userEmail || "").toLowerCase().trim();
    if(annonceEmail) sellerData = window.__usersCache.byEmail[annonceEmail];
    if(!sellerData && a.userId) sellerData = window.__usersCache.byId[a.userId];
    if(!sellerData && a.uid) sellerData = window.__usersCache.byId[a.uid];
    if(!sellerData && a.user && typeof a.user === "object") sellerData = a.user;

    let isPro = false;
    if(sellerData?.subscribe){
      const subEnd = sellerData.subscribeEnd?.toDate ? sellerData.subscribeEnd.toDate() : new Date(sellerData.subscribeEnd);
      if(subEnd > new Date()) isPro = true;
    }

    let fullName = "Utilisateur inconnu";
    if(sellerData){
      fullName =
        escapeHTML(
          sellerData.fullName ||
          `${sellerData.firstName || sellerData.prenom || ""} ${sellerData.lastName || sellerData.nom || ""}`.trim() ||
          sellerData.displayName ||
          sellerData.name ||
          sellerData.nom ||
          sellerData.prenom ||
          "Utilisateur"
        );
    }

    let sellerPhoto =
      escapeHTML(
        sellerData?.profileImage ||
        sellerData?.profilePic ||
        sellerData?.profile ||
        sellerData?.photoURL ||
        sellerData?.avatar ||
        sellerData?.image ||
        sellerData?.photo ||
        "https://via.placeholder.com/40"
      );

    let annonceImage = escapeHTML(a.images?.[0] || "https://via.placeholder.com/400x200?text=Annonce");

    card.innerHTML = `
      <div class="image-container">
        <img src="${annonceImage}" loading="lazy" alt="${escapeHTML(a.title||'Annonce')}"
             onerror="this.onerror=null;this.src='https://via.placeholder.com/400x200?text=Annonce'">
        ${isBoostActive(a)?'<span class="boost-icon material-symbols-outlined">arrow_shape_up</span>':''}
        <span class="time-badge">‚è∞ ${timeAgo(a.createdAt)}</span>
        <span class="material-icons favorite ${isFav?'active':''}">
          ${isFav?'favorite':'favorite_border'}
        </span>
      </div>
      <div class="content">
        <p class="price">${escapeHTML(a.price?a.price+" FCFA":"Prix sur demande")}</p>
        <h3 class="title">${escapeHTML(a.title || "Sans titre")}</h3>
        <p class="location">üìç ${escapeHTML(a.city || "Ville non pr√©cis√©e")}${a.quartier?", "+escapeHTML(a.quartier):""}</p>
      </div>
      <div class="seller">
        <img src="${sellerPhoto}" loading="lazy" alt="profil vendeur"
             onerror="this.onerror=null;this.src='https://via.placeholder.com/40'">
        <div class="seller-info">
          <strong>${fullName}</strong>
          ${isPro?'<span class="boutique-pro material-symbols-outlined" title="Boutique Pro">storefront</span>':''}
        </div>
      </div>
    `;

    // gestion des favoris
    const favBtn = card.querySelector(".favorite");
    favBtn.addEventListener("click", async e=>{
      e.stopPropagation();
      if(!currentUser){
        const msg = document.getElementById("notLoggedMsg");
        msg.style.display="block";
        setTimeout(()=>{msg.style.display="none";},3000);
        return;
      }
      const favRef = doc(db,"users",currentUser.uid);
      if(favBtn.classList.contains("active")){
        favBtn.classList.remove("active");
        favBtn.textContent="favorite_border";
        userFavorites=userFavorites.filter(id=>id!==docId);
        await updateDoc(favRef,{favorites:arrayRemove(docId)});
      } else {
        favBtn.classList.add("active");
        favBtn.textContent="favorite";
        userFavorites.push(docId);
        await updateDoc(favRef,{favorites:arrayUnion(docId)});
      }
    });

    card.addEventListener("click", e=>{
      if(e.target.classList.contains("favorite")) return;
      window.location.href=`Details.html?id=${encodeURIComponent(docId)}`;
    });

    annoncesContainer.appendChild(card);
  }
}

// ------------------------ INFINITE SCROLL ------------------------
window.addEventListener("scroll", async ()=>{
  if((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200){
    const batch = await fetchAnnoncesBatch();
    if(batch.length>0) await renderAnnoncesBatch(batch);
  }
});

// ------------------------ FILTRES & TRI ------------------------
function applyAllFiltersClientSide(batch){
  let filtered = batch;
  if(selectedCategory && selectedCategory!=="all")
    filtered = filtered.filter(a=>a.categorie===selectedCategory);
  if(selectedSubcategory)
    filtered = filtered.filter(a=>a.souscategorie===selectedSubcategory);
  if(searchText)
    filtered = filtered.filter(a=>
      (a.title?.toLowerCase().includes(searchText.toLowerCase()))||
      (a.city?.toLowerCase().includes(searchText.toLowerCase()))
    );

  if(sortOrder==="asc") filtered.sort((a,b)=>(a.price||0)-(b.price||0));
  if(sortOrder==="desc") filtered.sort((a,b)=>(b.price||0)-(a.price||0));

  return filtered;
}

function resetAnnonces(){
  annoncesContainer.innerHTML="";
  lastVisible=null;
  fetchAnnoncesBatch().then(batch=>{
    const filtered = applyAllFiltersClientSide(batch);
    renderAnnoncesBatch(filtered);
  });
}

// ------------------------ SEARCH & SORT ------------------------
function setupSearchAndSort(){
  const searchInput = document.getElementById("search-input");
  const searchBtn = document.getElementById("search-btn");

  searchInput.addEventListener("input", ()=>{ searchText = searchInput.value; });
  searchBtn.addEventListener("click", ()=>{ resetAnnonces(); });
  searchInput.addEventListener("keypress", e=>{ if(e.key==="Enter") resetAnnonces(); });

  if(filterToggle){
    filterToggle.addEventListener("click", ()=>{ filterMenu.style.display = filterMenu.style.display==="block"?"none":"block"; });
    priceAscBtn.addEventListener("click", ()=>{ sortOrder="asc"; resetAnnonces(); filterMenu.style.display="none"; });
    priceDescBtn.addEventListener("click", ()=>{ sortOrder="desc"; resetAnnonces(); filterMenu.style.display="none"; });
  }
}

// ------------------------ CATEGORIES ------------------------
function setupCategoryFilters() {
  const allCategory = document.querySelector('.category[data-cat="all"]');
  if(allCategory) allCategory.classList.add("active");

  categoryElements.forEach(cat=>{
    cat.addEventListener("click", ()=>{
      categoryElements.forEach(c=>c.classList.remove("active"));
      cat.classList.add("active");
      selectedCategory = cat.dataset.cat;
      selectedSubcategory = null;
      resetAnnonces();
    });
  });
}

// ------------------------ INIT ------------------------
setupCategoryFilters();
setupSearchAndSort();


</script>  
</body>
</html>
