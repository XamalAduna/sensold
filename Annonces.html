<!DOCTYPE html> 
<html lang="fr"> 
<head> 
<meta charset="UTF-8"> 
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Annonces</title> 
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
<style>
body { font-family:Arial, sans-serif; background:#E8F5F3; margin:0; padding:8px; padding-bottom:100px; }
h2 { text-align:center; margin-bottom:20px; color:#00796B; }
.annonces-container { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:20px; }
@media (min-width:1024px){ .annonces-container { grid-template-columns:repeat(4,1fr); } }
@media (max-width:600px){ .annonces-container { grid-template-columns:repeat(2,1fr); } }
.annonce-card { background:white; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); overflow:hidden; display:flex; flex-direction:column; position:relative; cursor:pointer; }
.annonce-card img { width:100%; height:150px; object-fit:cover; border-radius:8px 8px 0 0; display:block; margin-bottom:2px; }
.favorite { position:absolute; top:10px; right:10px; background:white; border-radius:50%; padding:5px; cursor:pointer; color:#00796B; box-shadow:0 2px 6px rgba(0,0,0,0.2); transition:color 0.3s; }
.favorite.active { color:red; }
.content { padding:0; flex:1; min-width:0; }
.price { color:#00796B; font-weight:bold; font-size:18px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex-shrink:0; margin:0; line-height:1; }
.title { font-size:16px; font-weight:bold; color:#333; display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical; overflow:hidden; text-overflow:ellipsis; white-space:normal; line-height:1.2em; margin:0; }
.location, .date { font-size:13px; color:#555; margin:2px 0; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
.seller { display:flex; align-items:center; gap:8px; padding:2px 12px; border-top:1px solid #eee; background:#fafafa; }
.seller img { width:30px; height:30px; border-radius:50%; object-fit:cover; }
.search-bar { display:flex; flex-direction:row; align-items:center; justify-content:center; gap:10px; margin-bottom:10px; width:100%; }
.search-box { flex:0 1 auto; max-width:600px; }
#search-input { width:100%; padding:12px 50px 12px 16px; font-size:16px; border-radius:10px; border:1px solid #ccc; box-sizing:border-box; outline:none; transition:border 0.3s ease; }
#search-input:focus { border-color:#009688; }
.search-btn { position:absolute; right:12px; top:50%; transform:translateY(-50%); cursor:pointer; color:#009688; font-size:24px; transition:color 0.3s ease; }
.search-btn:hover { color:#004d40; }
.suggestions { position:absolute; top:100%; left:0; right:0; background:white; border:1px solid #ccc; border-top:none; max-height:200px; overflow-y:auto; z-index:1000; border-radius:0 0 8px 8px; }
.suggestion-item { padding:10px 12px; cursor:pointer; font-size:15px; }
.suggestion-item:hover { background:#f0f0f0; }
.price-filters { display:flex; gap:10px; justify-content:center; align-items:center; width:100%; max-width:300px; }
.price-btn { border:1px solid #ccc; border-radius:8px; padding:6px 12px; background:white; cursor:pointer; color:#00796B; display:flex; flex-direction:row; align-items:center; gap:6px; font-size:14px; transition:0.2s ease; }
.price-btn .material-icons { font-size:18px; }
.price-btn span.label { font-size:13px; color:#333; }
.price-btn:hover { background:#f0f0f0; color:#004d40; }
.categories { margin:20px 0; text-align:center; margin-top:5px; }
.center-title { margin-bottom:15px; font-weight:bold; font-size:18px; color:#222; }
.categories-wrapper { display:flex; justify-content:center; }
.categories-scroll { display:flex; overflow-x:auto; gap:20px; padding:15px; max-width:650px; scrollbar-width:thin; }
.categories-scroll::-webkit-scrollbar { height:6px; }
.categories-scroll::-webkit-scrollbar-thumb { background:#009688; border-radius:10px; }
.category { flex:0 0 auto; text-align:center; width:60px; background:#fff; border-radius:12px; padding:13px; transition:transform 0.3s ease, box-shadow 0.3s ease; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.1); text-decoration:none; color:inherit; display:flex; flex-direction:column; align-items:center; }
.category:hover { transform:translateY(-5px); box-shadow:0 4px 10px rgba(0,0,0,0.15); }
.category i { font-size:28px; color:gray; margin-bottom:5px; display:block; }
.category p { font-size:11px; color:#333; margin:0; }
.category.clicked { animation:bounce 0.4s ease; }
@keyframes bounce { 0% { transform:scale(1); } 30% { transform:scale(0.9); } 60% { transform:scale(1.05); } 100% { transform:scale(1); } }
.subcategories { display:flex; flex-wrap:wrap; gap:15px; justify-content:center; margin-top:15px; padding:10px; }
.subcategory { flex:0 0 auto; width:120px; text-align:center; background:#fff; border-radius:10px; padding:12px; box-shadow:0 2px 5px rgba(0,0,0,0.1); cursor:pointer; transition:transform 0.2s ease, box-shadow 0.2s ease; }
.subcategory:hover { transform:translateY(-4px); box-shadow:0 4px 8px rgba(0,0,0,0.15); }
.subcategory i { font-size:26px; color:#009688; margin-bottom:5px; }
.subcategory p { font-size:13px; margin:0; color:#333; }
.category.active { background:#1976d2; color:white; border-radius:8px; }
.category.active i { color:white; }
#notLoggedMsg { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; padding:20px 30px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.25); text-align:center; z-index:99999; }
#notLoggedMsg a { display:inline-block; margin:8px 0; color:#009688; text-decoration:none; font-weight:bold; }
#notLoggedMsg a:hover { text-decoration:underline; }
.seller-info { flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; position:relative; padding-right:70px; }
.seller-info strong { display:block; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; font-size:13px; }
.loader { border:6px solid #f3f3f3; border-top:6px solid #009688; border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite; }
@keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
.annonce-card .time-badge { position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.6); color:#fff; padding:4px 8px; border-radius:6px; font-size:12px; font-weight:bold; z-index:5; }
.annonce-card .title { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; text-overflow:ellipsis; font-size:16px; line-height:1.2em; }
.annonce-card .title.long-text { font-size:14px; }
.location { line-height:1.2; }
.annonce-card .price, .annonce-card .title { margin:0 5px; line-height:1.2; }
.seller-info { position: relative;overflow: hidden;white-space: nowrap;text-overflow: ellipsis; padding-right: 70px;min-height: 30px; display: flex; align-items: center; }
.seller-info .boutique-pro {position: absolute;right: 0;top: 50%;transform: translateY(-50%);background: white;color: #00796B;font-size: 34px;padding: 6px;border-radius: 6px;display: flex;align-items: center;justify-content: center;}
.material-symbols-outlined {font-variation-settings:'FILL' 0,'wght' 400,'GRAD' 0, 'opsz' 24; font-size: 30px; color: #1f1f1f; }
.image-container {position: relative; display: block;}
.boost-icon {position: absolute;bottom: 8px;right: 8px;font-size: 40px;color: #00796B;background: transparent; border-radius: 0; padding: 0; z-index: 20;display: flex; align-items: center;justify-content: center; line-height: 1;}
</style>
</head>
<body>
<div class="search-bar" style="display:flex; align-items:center; gap:10px;">
  <div class="search-box" style="flex:1; display:flex; align-items:center; position:relative;">
    <input type="text" id="search-input" placeholder="Rechercher..." style="flex:1; padding:8px 36px 8px 12px; border:1px solid #ccc; border-radius:8px;">
    <span class="material-icons search-btn" id="search-btn" style="position:absolute; right:8px; cursor:pointer; color:#009688;">search</span>
    <div id="suggestions" class="suggestions" style="display:none;"></div>
  </div>
  <span id="filter-toggle" class="material-icons" style="cursor:pointer; color:#009688; font-size:28px;">
    filter_list
  </span>
</div>
<div id="filter-menu" style="display:none; margin-top:6px; background:#fff; border:1px solid #ccc; border-radius:8px; padding:6px; width:200px; box-shadow:0 2px 6px rgba(0,0,0,0.15);">
  <button class="price-btn" id="price-asc">
    <span class="material-icons">arrow_upward</span>
    <span class="label">Prix â†‘</span>
  </button>
  <button class="price-btn" id="price-desc">
    <span class="material-icons">arrow_downward</span>
    <span class="label">Prix â†“</span>
  </button>
</div>
<section class="categories">
  <div class="categories-wrapper">
    <div class="categories-scroll">
      <div class="category" data-cat="all">
         <i class="material-icons">apps</i>
        <p>Tous</p>
      </div>
      <div class="category" data-cat="vehicules">
        <i class="material-icons">directions_car</i>
        <p>VÃ©hicules</p>
      </div>
      <div class="category" data-cat="electronique">
        <i class="material-icons">devices</i>
        <p>Ã‰lectronique</p>
      </div>
      <div class="category" data-cat="immobilier">
        <i class="material-icons">home</i>
        <p>Immobilier</p>
      </div>
    </div>
  </div>
  <div id="subcategories-container"></div>
</section>
<div id="spinner" style="display:flex; justify-content:center; align-items:center; height:200px;">
  <div class="loader"></div>
</div>
<div id="annonces" class="annonces-container"></div>
<div id="notLoggedMsg" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; padding:20px 30px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.25); text-align:center; z-index:99999;">
  <p>Veuillez vous connecter pour ajouter â€¯cette annonce Ã  vos favoris.</p>
  <a href="login.html">Se connecter</a>
</div>

<!-- Modal -->
<div id="detailsModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center; overflow:auto;">
  <div id="modalContent" style="background:#fff; border-radius:12px; max-width:800px; width:90%; margin:40px auto; position:relative; padding:20px;">
    <span id="closeModal" style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:24px; font-weight:bold;">&times;</span>
    <div id="modalInnerContent">
      <!-- Le contenu de Details.html sera chargÃ© ici -->
      <p style="text-align:center;">Chargement...</p>
    </div>
  </div>
</div>
  
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy, limit, startAfter, doc, updateDoc, arrayUnion, arrayRemove, getDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
const firebaseConfig = {
  apiKey: "AIzaSyDLrPKEzDueP4j-HjAdOhmkuA74cLsCn2M",
  authDomain: "diallo-ee5aa.firebaseapp.com",
  projectId: "diallo-ee5aa",
  storageBucket: "diallo-ee5aa.firebasestorage.app",
  messagingSenderId: "662485613383",
  appId: "1:662485613383:web:c1129a35c335cc95c0ea62",
  measurementId: "G-F3092DTNZY"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();
const categoriesData = {
  "vehicules": [
    {"label": "Voitures & utilitaires", "icon": "directions_car"},
    {"label": "Moto & scooters", "icon": "motorcycle"},
    {"label": "Camion & bus", "icon": "local_shipping"},
    {"label": "Ã‰quipements et accessoires", "icon": "build"},
    {"label": "Location de vÃ©hicule", "icon": "key"},
    {"label": "Bateaux", "icon": "sailing"}
  ],
  "immobilier": [
    {"label": "Villas", "icon": "villa"},
    {"label": "Terrains", "icon": "terrain"},
    {"label": "Appartements", "icon": "apartment"},
    {"label": "Immeubles", "icon": "domain"},
    {"label": "Bureaux et commerce", "icon": "business"},
    {"label": "Maison de vacances", "icon": "holiday_village"},
    {"label": "Chambres", "icon": "bedroom_parent"},
    {"label": "Terrains agricoles", "icon": "agriculture"},
    {"label": "Appartements meublÃ©s", "icon": "home_filled"},
    {"label": "Ferme et verger", "icon": "agriculture"}
  ],
  "electronique": [
    { "label": "TÃ©lÃ©phones & Tablettes", "icon": "smartphone" },
    { "label": "Ordinateurs", "icon": "computer" },
    { "label": "Son, Hifi & Casques", "icon": "headphones" },
    { "label": "Accessoires Informatiques", "icon": "keyboard" },
    { "label": "Jeux vidÃ©o & Consoles", "icon": "sports_esports" },
    { "label": "Accessoires TÃ©lÃ©phonie", "icon": "phone_iphone" },
    { "label": "TV, box & VidÃ©o projecteurs", "icon": "tv" },
    { "label": "Appareils photos et CamÃ©ras", "icon": "photo_camera" },
    { "label": "Montres connectÃ©es & GPS", "icon": "watch" },
    { "label": "Imprimantes & Photocopieurs", "icon": "print" },
    { "label": "Autres Ã©lectronique", "icon": "devices_other" }
  ]
};

const annoncesContainer = document.getElementById("annonces");
const subContainer = document.getElementById("subcategories-container");
const categoryElements = document.querySelectorAll(".category");
const suggestionsBox = document.getElementById("suggestions");

const filterToggle = document.getElementById("filter-toggle");
const filterMenu = document.getElementById("filter-menu");
const priceAscBtn = document.getElementById("price-asc");
const priceDescBtn = document.getElementById("price-desc");

let currentUser = null;
let userFavorites = [];
let annoncesData = [];
let selectedCategory = "all";
let selectedSubcategory = null;
let searchText = "";
let sortOrder = "default";
let currentPage = 1;
const annoncesPerPage = 50;

function timeAgo(timestamp){
  if(!timestamp) return "Date inconnue";
  const seconds = (Date.now() - timestamp.toDate().getTime()) / 1000;
  if(seconds < 60) return "Ã  lâ€™instant";
  const minutes = Math.floor(seconds/60);
  if(minutes < 60) return `il y a ${minutes} min`;
  const hours = Math.floor(minutes/60);
  if(hours < 24) return `il y a ${hours} h`;
  const days = Math.floor(hours/24);
  return `il y a ${days} j`;
}
onAuthStateChanged(auth, async (user) => {
  currentUser = user;
  if(user){
    const userRef = doc(db,"users",user.uid);
    const userSnap = await getDoc(userRef);
    userFavorites = userSnap.data()?.favorites || [];
  } else {
    userFavorites = [];
  }
  loadAnnonces();
});

// âœ… VERSION OPTIMISÃ‰E : supporte 1M+ annonces sans lag
async function loadAnnonces(limitCount = 50) {
  if (!window.annoncesData) window.annoncesData = [];
  if (!window.lastVisible) window.lastVisible = null;
  if (window.isLoading) return; // âš¡ Stop double chargement
  window.isLoading = true;

  document.getElementById("spinner").style.display = "flex";

  try {
    let annoncesQuery = query(
      collection(db, "annonces"),
      orderBy("createdAt", "desc"),
      limit(limitCount)
    );

    if (window.lastVisible) {
      annoncesQuery = query(
        collection(db, "annonces"),
        orderBy("createdAt", "desc"),
        startAfter(window.lastVisible),
        limit(limitCount)
      );
    }

    const annoncesSnap = await getDocs(annoncesQuery);

    if (annoncesSnap.empty) {
      window.allAnnoncesLoaded = true;
      if (window.annoncesData.length === 0) {
        annoncesContainer.innerHTML = "<p>Aucune annonce disponible.</p>";
      }
      return;
    }

    // âš¡ Ajout progressif
    const newAnnonces = annoncesSnap.docs.map(d => ({ ...d.data(), id: d.id }));
    window.annoncesData.push(...newAnnonces);
    window.lastVisible = annoncesSnap.docs[annoncesSnap.docs.length - 1];

    // âš¡ Cache utilisateurs (une seule fois)
    if (!window.__usersCache) {
      try {
        const usersSnap = await getDocs(collection(db, "users"));
        const byEmail = {}, byId = {};
        usersSnap.forEach(uDoc => {
          const u = uDoc.data() || {};
          byId[uDoc.id] = u;
          const email = (u.email || u.emailAddress || "").toLowerCase().trim();
          if (email) byEmail[email] = u;
        });
        window.__usersCache = { byEmail, byId };
      } catch (err) {
        console.error("Erreur chargement users:", err);
        window.__usersCache = { byEmail: {}, byId: {} };
      }
    }

    // âš¡ Setup filtre (une seule fois)
    if (!window.hasSetupFilters) {
      setupCategoryFilters();
      setupSearchAndSort();
      setupFilterMenu();
      window.hasSetupFilters = true;
    }

    applyAllFilters(); // nâ€™affiche que le lot chargÃ©
  } catch (err) {
    console.error("Erreur chargement annonces:", err);
    annoncesContainer.innerHTML = `<p>âš ï¸ Erreur de chargement : ${err.message}</p>`;
  } finally {
    window.isLoading = false;
    document.getElementById("spinner").style.display = "none";
  }
}

// âš¡ Scroll infini optimisÃ© avec throttle
let scrollTimeout = null;
window.addEventListener("scroll", () => {
  if (window.allAnnoncesLoaded) return;
  if (scrollTimeout) return;
  
  scrollTimeout = setTimeout(() => {
    scrollTimeout = null;
    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
      loadAnnonces();
    }
  }, 200); // âš¡ ne dÃ©clenche pas plus d'une fois toutes les 200ms
});

function escapeHTML(str) {
  if (!str) return "";
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
}

async function renderAnnonces(filtered) {
  annoncesContainer.innerHTML = ""; // vide le conteneur avant affichage

  if (filtered.length === 0) {
    annoncesContainer.innerHTML = "<p>âŒ Aucun rÃ©sultat trouvÃ©.</p>";
    return;
  }

  // âš¡ Pagination
  const totalPages = Math.ceil(filtered.length / annoncesPerPage);
  if (currentPage > totalPages) currentPage = 1;
  const start = (currentPage - 1) * annoncesPerPage;
  const end = start + annoncesPerPage;
  const pageItems = filtered.slice(start, end);

  // âš¡ Cache utilisateurs
  if (!window.__usersCache) {
    try {
      const usersSnap = await getDocs(collection(db, "users"));
      const byEmail = {}, byId = {};
      usersSnap.forEach(uDoc => {
        const u = uDoc.data() || {};
        byId[uDoc.id] = u;
        const email = (u.email || u.emailAddress || "").toLowerCase().trim();
        if (email) byEmail[email] = u;
      });
      window.__usersCache = { byEmail, byId };
    } catch (err) {
      console.error("Erreur chargement users:", err);
      window.__usersCache = { byEmail: {}, byId: {} };
    }
  }

  // âš¡ CrÃ©ation batch
  const fragment = document.createDocumentFragment();

  for (const a of pageItems) {
    const docId = escapeHTML(a.id || "");
    const card = document.createElement("div");
    card.className = "annonce-card";

    const isFav = currentUser && userFavorites.includes(a.id);

    // âš¡ RÃ©cupÃ©ration vendeur
    let sellerData = null;
    const annonceEmail = (a.userEmail || "").toLowerCase().trim();
    if (annonceEmail) sellerData = window.__usersCache.byEmail[annonceEmail];
    if (!sellerData && a.userId) sellerData = window.__usersCache.byId[a.userId];
    if (!sellerData && a.uid) sellerData = window.__usersCache.byId[a.uid];
    if (!sellerData && a.user && typeof a.user === "object") sellerData = a.user;

    // âš¡ Boutique pro
    let isPro = false;
    if (sellerData?.subscribe) {
      const now = new Date();
      const subEnd = sellerData.subscribeEnd?.toDate ? sellerData.subscribeEnd.toDate() : new Date(sellerData.subscribeEnd);
      if (subEnd > now) isPro = true;
    }

    // âš¡ Nom et photo
    let fullName = sellerData
      ? escapeHTML(
          sellerData.fullName ||
          `${sellerData.firstName || sellerData.prenom || ""} ${sellerData.lastName || sellerData.nom || ""}`.trim() ||
          sellerData.displayName || sellerData.name || "Utilisateur"
        )
      : "Utilisateur inconnu";

    let sellerPhoto = escapeHTML(
      sellerData?.profileImage ||
      sellerData?.profilePic ||
      sellerData?.profile ||
      sellerData?.photoURL ||
      sellerData?.avatar ||
      "https://via.placeholder.com/40"
    );

    let annonceImage = escapeHTML(a.images?.[0] || "https://via.placeholder.com/400x200?text=Annonce");

    // âš¡ Structure HTML
    card.innerHTML = `
      <div class="image-container">
        <img src="${annonceImage}" loading="lazy" alt="${escapeHTML(a.title || 'Annonce')}"
             onerror="this.onerror=null;this.src='https://via.placeholder.com/400x200?text=Annonce'">
        ${isBoostActive(a) ? '<span class="boost-icon material-symbols-outlined">arrow_shape_up</span>' : ''}
        <span class="time-badge">â° ${timeAgo(a.createdAt)}</span>
        <span class="material-icons favorite ${isFav ? 'active' : ''}">
          ${isFav ? 'favorite' : 'favorite_border'}
        </span>
      </div>
      <div class="content">
        <p class="price">${escapeHTML(a.price ? a.price + " FCFA" : "Prix sur demande")}</p>
        <h3 class="title">${escapeHTML(a.title || "Sans titre")}</h3>
        <p class="location">ğŸ“ ${escapeHTML(a.city || "Ville non prÃ©cisÃ©e")}${a.quartier ? ", " + escapeHTML(a.quartier) : ""}</p>
      </div>
      <div class="seller">
        <img src="${sellerPhoto}" loading="lazy" alt="profil vendeur"
             onerror="this.onerror=null;this.src='https://via.placeholder.com/40'">
        <div class="seller-info">
          <strong>${fullName}</strong>
          ${isPro ? '<span class="boutique-pro material-symbols-outlined" title="Boutique Pro">storefront</span>' : ''}
        </div>
      </div>
    `;

    // âš¡ Texte long
    if ((a.title || "").length > 30) card.querySelector('.title').classList.add('long-text');

    // âš¡ Bouton favoris
    card.querySelector(".favorite").addEventListener("click", async e => {
      e.stopPropagation();
      if (!currentUser) {
        const msg = document.getElementById("notLoggedMsg");
        msg.style.display = "block";
        setTimeout(() => { msg.style.display = "none"; }, 3000);
        return;
      }
      const favRef = doc(db, "users", currentUser.uid);
      if (userFavorites.includes(docId)) {
        userFavorites = userFavorites.filter(id => id !== docId);
        await updateDoc(favRef, { favorites: arrayRemove(docId) });
        e.target.classList.remove("active");
        e.target.textContent = "favorite_border";
      } else {
        userFavorites.push(docId);
        await updateDoc(favRef, { favorites: arrayUnion(docId) });
        e.target.classList.add("active");
        e.target.textContent = "favorite";
      }
    });

    // âš¡ Clic sur card
    card.addEventListener("click", async e => {
  if (e.target.classList.contains("favorite")) return;

  const modal = document.getElementById("detailsModal");
  const modalInner = document.getElementById("modalInnerContent");
  modal.style.display = "flex";
  modalInner.innerHTML = "<p style='text-align:center;'>Chargement...</p>";

  try {
    const docRef = doc(db, "annonces", docId);
    const docSnap = await getDoc(docRef);
    if (!docSnap.exists()) throw new Error("Annonce introuvable.");

    const a = docSnap.data();
    
    // Seller info
    let sellerData = window.__usersCache.byId[a.userId] || {};
    let fullName = sellerData.fullName || "Utilisateur inconnu";
    let sellerPhoto = sellerData.profileImage || "https://via.placeholder.com/50";

    // Images
    let mainImage = a.images?.[0] || "https://via.placeholder.com/400x200?text=Annonce";
    let thumbnails = a.images?.map(img => `<img src="${img}" />`).join('') || "";

    modalInner.innerHTML = `
      <div class="container">
        <div class="image-wrapper">
          <img class="main-image" src="${mainImage}" />
        </div>
        <div class="product-header">
          <p class="price">${a.price ? a.price + " FCFA" : "Prix sur demande"}</p>
          <h1>${a.title}</h1>
        </div>
        <div class="details">
          <p><i class="material-icons">place</i> ${a.city || "Ville non prÃ©cisÃ©e"}${a.quartier ? ", "+a.quartier : ""}</p>
          <div class="description-content">${a.description || "Pas de description"}</div>
        </div>
        <div class="seller">
          <a href="#">
            <img src="${sellerPhoto}" />
            <div>
              <strong>${fullName}</strong>
              <span class="material-symbols-outlined">storefront</span>
            </div>
          </a>
        </div>
        <div class="buttons">
          <a class="button whatsapp" href="https://wa.me/${a.whatsapp}" target="_blank">WhatsApp</a>
          <a class="button phone" href="tel:${a.phone}">Appeler</a>
        </div>
      </div>
    `;
  } catch (err) {
    modalInner.innerHTML = `<p style="color:red;">Erreur : ${err.message}</p>`;
  }
});

    fragment.appendChild(card);
  }

  annoncesContainer.appendChild(fragment);
  renderPagination(totalPages);
}

function renderPagination(totalPages){
  let paginationContainer = document.getElementById("pagination");
  if(!paginationContainer){
    paginationContainer = document.createElement("div");
    paginationContainer.id = "pagination";
    paginationContainer.style.textAlign = "center";
    paginationContainer.style.marginTop = "20px";
    document.body.appendChild(paginationContainer);
  }

  paginationContainer.innerHTML = "";

  const createPageBtn = (num) => {
    const btn = document.createElement("button");
    btn.textContent = num;
    btn.style.margin = "0 5px";
    btn.style.padding = "6px 12px";
    btn.style.borderRadius = "6px";
    btn.style.border = num === currentPage ? "2px solid #009688" : "1px solid #ccc";
    btn.style.background = num === currentPage ? "#009688" : "#fff";
    btn.style.color = num === currentPage ? "#fff" : "#000";
    btn.style.cursor = "pointer";
    btn.addEventListener("click", () => {
      currentPage = num;
      applyAllFilters();
    });
    return btn;
  }

  const maxButtons = 7;
  let startPage = Math.max(1, currentPage - 3);
  let endPage = Math.min(totalPages, startPage + maxButtons - 1);
  startPage = Math.max(1, endPage - maxButtons + 1);

  if(startPage > 1){
    paginationContainer.appendChild(createPageBtn(1));
    if(startPage > 2) paginationContainer.appendChild(document.createTextNode("..."));
  }

  for(let i = startPage; i <= endPage; i++){
    paginationContainer.appendChild(createPageBtn(i));
  }

  if(endPage < totalPages){
    if(endPage < totalPages -1) paginationContainer.appendChild(document.createTextNode("..."));
    paginationContainer.appendChild(createPageBtn(totalPages));
  }
}

function setupCategoryFilters() {
  const allCategory = document.querySelector('.category[data-cat="all"]');
  if (allCategory) allCategory.classList.add("active");

  document.addEventListener("click", e => {
    const menu = document.getElementById("subDropdownMenu");
    if (menu && !menu.parentElement.contains(e.target)) {
      menu.style.display = "none";
    }
  });

  categoryElements.forEach(cat => {
    cat.addEventListener("click", () => {
      categoryElements.forEach(c => c.classList.remove("active"));
      cat.classList.add("active");

      selectedCategory = cat.dataset.cat;
      selectedSubcategory = null;
      currentPage = 1;
      const subs = categoriesData[selectedCategory] || [];
      if (subs.length === 0) {
        subContainer.innerHTML = "<p style='text-align:center;color:#777;'>Aucune sous-catÃ©gorie</p>";
      } else {
        subContainer.innerHTML = `
          <div style="text-align:center; margin-top:10px; position:relative; display:inline-block;">
            <button id="subDropdownBtn" style="padding:8px 12px; border-radius:8px; border:1px solid #ccc; background:#fff; cursor:pointer;">
              SÃ©lectionner une sous-catÃ©gorie â–¼
            </button>
            <div id="subDropdownMenu" style="display:none; position:absolute; top:100%; left:0; background:#fff; border:1px solid #ccc; border-radius:8px; width:220px; box-shadow:0 2px 6px rgba(0,0,0,0.15); z-index:1000;">
              ${subs.map(s => `<div class="sub-item" style="display:flex; align-items:center; gap:8px; padding:6px 10px; cursor:pointer;">
                <i class="material-icons" style="color:#009688;">${s.icon}</i>
                <span>${s.label}</span>
              </div>`).join('')}
            </div>
          </div>
        `;

        const btn = document.getElementById("subDropdownBtn");
        const items = document.querySelectorAll(".sub-item");

        btn.addEventListener("click", () => {
          const menu = document.getElementById("subDropdownMenu");
          menu.style.display = menu.style.display === "block" ? "none" : "block";
        });

        items.forEach(item => {
          item.addEventListener("click", () => {
            items.forEach(i => { i.style.background = "#fff"; i.style.color = "#000"; });
            item.style.background = "#009688";
            item.style.color = "#fff";
            selectedSubcategory = item.querySelector("span").textContent.trim();
            btn.textContent = selectedSubcategory + " â–¼";
            document.getElementById("subDropdownMenu").style.display = "none";
            currentPage = 1;
            applyAllFilters();
          });
        });
      }
      applyAllFilters();
    });
  });
}

function setupSearchAndSort(){
  const searchInput = document.getElementById("search-input");
  const searchBtn = document.getElementById("search-btn");

  searchInput.addEventListener("input", ()=>{ searchText = searchInput.value; });
  searchBtn.addEventListener("click", ()=>{ searchText = searchInput.value; currentPage = 1; applyAllFilters(); });
  searchInput.addEventListener("keypress", e=>{ if(e.key==="Enter"){ searchText = searchInput.value; currentPage = 1; applyAllFilters(); } });
}

function setupFilterMenu(){
  if(!filterToggle) return;

  filterToggle.addEventListener("click", () => { filterMenu.style.display = filterMenu.style.display === "block" ? "none" : "block"; });
  priceAscBtn.addEventListener("click", () => { sortOrder = "asc"; currentPage = 1; applyAllFilters(); filterMenu.style.display = "none"; });
  priceDescBtn.addEventListener("click", () => { sortOrder = "desc"; currentPage = 1; applyAllFilters(); filterMenu.style.display = "none"; });

  document.addEventListener("click", (e) => {
    if (!filterMenu.contains(e.target) && e.target !== filterToggle) filterMenu.style.display = "none";
  });
}

function isBoostActive(annonce) {
  if (!annonce.boost || !annonce.boostEnd) return false;
  const now = new Date();
  const boostEndDate = new Date(annonce.boostEnd.toDate ? annonce.boostEnd.toDate() : annonce.boostEnd);
  return boostEndDate > now;
}

// âš¡ VERSION ULTRA OPTIMISÃ‰E â€” Supporte 500k annonces
function applyAllFilters() {
  let data = window.annoncesData;
  if (!data || data.length === 0) return renderAnnonces([]);

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // âš¡ FAST-PATH : si aucun filtre ni tri â†’ affichage direct ultra rapide
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const noFilter =
    (!selectedCategory || selectedCategory === "all") &&
    !selectedSubcategory &&
    !searchText &&
    sortOrder === null;

  if (noFilter) {
    return renderAnnonces(data);
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // âš¡ PRE-CALCULS pour accÃ©lÃ©rer (micro-cache)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const lowerSearch = searchText ? searchText.toLowerCase() : null;

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // âš¡ FILTRAGE HYPER RAPIDE (1 seul passage)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const filtered = [];
  for (let i = 0; i < data.length; i++) {
    const a = data[i];

    if (selectedCategory && selectedCategory !== "all" && a.categorie !== selectedCategory) continue;
    if (selectedSubcategory && a.souscategorie !== selectedSubcategory) continue;

    if (lowerSearch) {
      const t = a.title?.toLowerCase() || "";
      const c = a.city?.toLowerCase() || "";
      if (!t.includes(lowerSearch) && !c.includes(lowerSearch)) continue;
    }

    filtered.push(a);
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // âš¡ TRI OPTIMISÃ‰ (Boost â†’ Prix â†’ Date)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  filtered.sort((a, b) => {
    // BOOST
    const aBoost = isBoostActive(a);
    const bBoost = isBoostActive(b);
    if (aBoost !== bBoost) return bBoost - aBoost;

    if (aBoost && bBoost) {
      const aEnd = a.boostEnd ? (a.boostEnd.toDate ? a.boostEnd.toDate() : new Date(a.boostEnd)) : 0;
      const bEnd = b.boostEnd ? (b.boostEnd.toDate ? b.boostEnd.toDate() : new Date(b.boostEnd)) : 0;
      return bEnd - aEnd;
    }

    // TRI PRIX
    if (sortOrder === "asc") return (a.price || 0) - (b.price || 0);
    if (sortOrder === "desc") return (b.price || 0) - (a.price || 0);

    // TRI DATE
    const aDate = a.createdAt ? a.createdAt.seconds * 1000 : 0;
    const bDate = b.createdAt ? b.createdAt.seconds * 1000 : 0;
    return bDate - aDate;
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // âš¡ AFFICHAGE (ultra fluide)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  renderAnnonces(filtered);
}

document.getElementById("closeModal").addEventListener("click", () => {
  document.getElementById("detailsModal").style.display = "none";
});

// Fermer si on clique en dehors du contenu
document.getElementById("detailsModal").addEventListener("click", (e) => {
  if (e.target.id === "detailsModal") {
    e.target.style.display = "none";
  }
});

</script> 

</body>
</html>
