<!DOCTYPE html> 
<html lang="fr"> 
<head> 
<meta charset="UTF-8"> 
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Annonces</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
<style>
body { font-family:Arial, sans-serif; background:#f7f7f7; margin:0; padding:8px; padding-bottom:100px; }
h2 { text-align:center; margin-bottom:20px; color:#00796B; }
.annonces-container { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:20px; }
@media (min-width:1024px){ .annonces-container { grid-template-columns:repeat(4,1fr); } }
@media (max-width:600px){ .annonces-container { grid-template-columns:repeat(2,1fr); } }
.annonce-card { background:white; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); overflow:hidden; display:flex; flex-direction:column; position:relative; cursor:pointer; }
.annonce-card img { width:100%; height:150px; object-fit:cover; border-radius:8px 8px 0 0; display:block; margin-bottom:2px; }
.favorite { position:absolute; top:10px; right:10px; background:white; border-radius:50%; padding:5px; cursor:pointer; color:#00796B; box-shadow:0 2px 6px rgba(0,0,0,0.2); transition:color 0.3s; }
.favorite.active { color:red; }
.content { padding:0; flex:1; min-width:0; }
.price { color:#00796B; font-weight:bold; font-size:18px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex-shrink:0; margin:0; line-height:1; }
.title { font-size:16px; font-weight:bold; color:#333; display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical; overflow:hidden; text-overflow:ellipsis; white-space:normal; line-height:1.2em; margin:0; }
.location, .date { font-size:13px; color:#555; margin:2px 0; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
.seller { display:flex; align-items:center; gap:8px; padding:2px 12px; border-top:1px solid #eee; background:#fafafa; }
.seller img { width:30px; height:30px; border-radius:50%; object-fit:cover; }
.search-bar { display:flex; flex-direction:row; align-items:center; justify-content:center; gap:10px; margin-bottom:10px; width:100%; }
.search-box { flex:0 1 auto; max-width:600px; }
#search-input { width:100%; padding:12px 50px 12px 16px; font-size:16px; border-radius:10px; border:1px solid #ccc; box-sizing:border-box; outline:none; transition:border 0.3s ease; }
#search-input:focus { border-color:#009688; }
.search-btn { position:absolute; right:12px; top:50%; transform:translateY(-50%); cursor:pointer; color:#009688; font-size:24px; transition:color 0.3s ease; }
.search-btn:hover { color:#004d40; }
.suggestions { position:absolute; top:100%; left:0; right:0; background:white; border:1px solid #ccc; border-top:none; max-height:200px; overflow-y:auto; z-index:1000; border-radius:0 0 8px 8px; }
.suggestion-item { padding:10px 12px; cursor:pointer; font-size:15px; }
.suggestion-item:hover { background:#f0f0f0; }
.price-filters { display:flex; gap:10px; justify-content:center; align-items:center; width:100%; max-width:300px; }
.price-btn { border:1px solid #ccc; border-radius:8px; padding:6px 12px; background:white; cursor:pointer; color:#00796B; display:flex; flex-direction:row; align-items:center; gap:6px; font-size:14px; transition:0.2s ease; }
.price-btn .material-icons { font-size:18px; }
.price-btn span.label { font-size:13px; color:#333; }
.price-btn:hover { background:#f0f0f0; color:#004d40; }
.categories { margin:20px 0; text-align:center; margin-top:5px; }
.center-title { margin-bottom:15px; font-weight:bold; font-size:18px; color:#222; }
.categories-wrapper { display:flex; justify-content:center; }
.categories-scroll { display:flex; overflow-x:auto; gap:20px; padding:15px; max-width:650px; scrollbar-width:thin; }
.categories-scroll::-webkit-scrollbar { height:6px; }
.categories-scroll::-webkit-scrollbar-thumb { background:#009688; border-radius:10px; }
.category { flex:0 0 auto; text-align:center; width:60px; background:#fff; border-radius:12px; padding:13px; transition:transform 0.3s ease, box-shadow 0.3s ease; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.1); text-decoration:none; color:inherit; display:flex; flex-direction:column; align-items:center; }
.category:hover { transform:translateY(-5px); box-shadow:0 4px 10px rgba(0,0,0,0.15); }
.category i { font-size:28px; color:gray; margin-bottom:5px; display:block; }
.category p { font-size:11px; color:#333; margin:0; }
.category.clicked { animation:bounce 0.4s ease; }
@keyframes bounce { 0% { transform:scale(1); } 30% { transform:scale(0.9); } 60% { transform:scale(1.05); } 100% { transform:scale(1); } }
.subcategories { display:flex; flex-wrap:wrap; gap:15px; justify-content:center; margin-top:15px; padding:10px; }
.subcategory { flex:0 0 auto; width:120px; text-align:center; background:#fff; border-radius:10px; padding:12px; box-shadow:0 2px 5px rgba(0,0,0,0.1); cursor:pointer; transition:transform 0.2s ease, box-shadow 0.2s ease; }
.subcategory:hover { transform:translateY(-4px); box-shadow:0 4px 8px rgba(0,0,0,0.15); }
.subcategory i { font-size:26px; color:#009688; margin-bottom:5px; }
.subcategory p { font-size:13px; margin:0; color:#333; }
.category.active { background:#1976d2; color:white; border-radius:8px; }
.category.active i { color:white; }
#notLoggedMsg { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; padding:20px 30px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.25); text-align:center; z-index:99999; }
#notLoggedMsg a { display:inline-block; margin:8px 0; color:#009688; text-decoration:none; font-weight:bold; }
#notLoggedMsg a:hover { text-decoration:underline; }
.seller-info { flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; position:relative; padding-right:70px; }
.seller-info strong { display:block; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; font-size:13px; }
.loader { border:6px solid #f3f3f3; border-top:6px solid #009688; border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite; }
@keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
.annonce-card .time-badge { position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.6); color:#fff; padding:4px 8px; border-radius:6px; font-size:12px; font-weight:bold; z-index:5; }
.annonce-card .title { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; text-overflow:ellipsis; font-size:16px; line-height:1.2em; }
.annonce-card .title.long-text { font-size:14px; }
.location { line-height:1.2; }
.annonce-card .price, .annonce-card .title { margin:0 5px; line-height:1.2; }
.seller-info { position: relative;overflow: hidden;white-space: nowrap;text-overflow: ellipsis; padding-right: 70px;min-height: 30px; display: flex; align-items: center; }
.seller-info .boutique-pro {position: absolute;right: 0;top: 50%;transform: translateY(-50%);background: white;color: #00796B;font-size: 34px;padding: 6px;border-radius: 6px;display: flex;align-items: center;justify-content: center;}
.material-symbols-outlined {font-variation-settings:'FILL' 0,'wght' 400,'GRAD' 0, 'opsz' 24; font-size: 30px; color: #1f1f1f; }
.image-container {position: relative; display: block;}
.boost-icon {position: absolute;bottom: 8px;right: 8px;font-size: 40px;color: #00796B;background: transparent; border-radius: 0; padding: 0; z-index: 20;display: flex; align-items: center;justify-content: center; line-height: 1;}
</style>
</head>
<body>
<div class="search-bar" style="display:flex; align-items:center; gap:10px;">
  <div class="search-box" style="flex:1; display:flex; align-items:center; position:relative;">
    <input type="text" id="search-input" placeholder="Rechercher..." style="flex:1; padding:8px 36px 8px 12px; border:1px solid #ccc; border-radius:8px;">
    <span class="material-icons search-btn" id="search-btn" style="position:absolute; right:8px; cursor:pointer; color:#009688;">search</span>
    <div id="suggestions" class="suggestions" style="display:none;"></div>
  </div>
  <span id="filter-toggle" class="material-icons" style="cursor:pointer; color:#009688; font-size:28px;">
    filter_list
  </span>
</div>
<div id="filter-menu" style="display:none; margin-top:6px; background:#fff; border:1px solid #ccc; border-radius:8px; padding:6px; width:200px; box-shadow:0 2px 6px rgba(0,0,0,0.15);">
  <button class="price-btn" id="price-asc">
    <span class="material-icons">arrow_upward</span>
    <span class="label">Prix ‚Üë</span>
  </button>
  <button class="price-btn" id="price-desc">
    <span class="material-icons">arrow_downward</span>
    <span class="label">Prix ‚Üì</span>
  </button>
</div>
<section class="categories">
  <div class="categories-wrapper">
    <div class="categories-scroll">
     
      <div class="category" data-cat="all">
         <i class="material-icons">apps</i>
        <p>Tous</p>
      </div>
      <div class="category" data-cat="vehicules">
        <i class="material-icons">directions_car</i>
        <p>V√©hicules</p>
      </div>
      <div class="category" data-cat="electronique">
        <i class="material-icons">devices</i>
        <p>√âlectronique</p>
      </div>
      <div class="category" data-cat="immobilier">
        <i class="material-icons">home</i>
        <p>Immobilier</p>
      </div>
      <div class="category" data-cat="mode">
        <i class="material-icons">checkroom</i>
        <p>Mode & Beaut√©</p>
      </div>
      <div class="category" data-cat="electromenager">
        <i class="material-icons">kitchen</i>
        <p>√âlectrom√©nager</p>
      </div>
      <div class="category" data-cat="maison">
        <i class="material-icons">king_bed</i>
        <p>Pour la maison</p>
      </div>
      <div class="category" data-cat="emplois">
        <i class="material-icons">work</i>
        <p>Emplois</p>
      </div>
      <div class="category" data-cat="services">
        <i class="material-icons">handshake</i>
        <p>Services</p>
      </div>
      <div class="category" data-cat="sports_loisirs">
        <i class="material-icons">sports_basketball</i>
        <p>Sports & Loisirs</p>
      </div>
      <div class="category" data-cat="alimentation">
        <i class="material-icons">restaurant</i>
        <p>Alimentation</p>
      </div>
      <div class="category" data-cat="animaux">
        <i class="material-icons">pets</i>
        <p>Animaux</p>
      </div>
      <div class="category" data-cat="materiel_pro">
        <i class="material-icons">build</i>
        <p>Mat√©riel Pro</p>
      </div>
    </div>
  </div>
  <div id="subcategories-container"></div>
</section>
<div id="spinner" style="display:flex; justify-content:center; align-items:center; height:200px;">
  <div class="loader"></div>
</div>
<div id="annonces" class="annonces-container"></div>
<div id="notLoggedMsg" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; padding:20px 30px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.25); text-align:center; z-index:99999;">
  <p>Veuillez vous connecter pour ajouter ‚ÄØcette annonce √† vos favoris.</p>
  <a href="login.html">Se connecter</a>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy, limit, startAfter, doc, updateDoc, arrayUnion, arrayRemove, getDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
const firebaseConfig = {
  apiKey: "AIzaSyDLrPKEzDueP4j-HjAdOhmkuA74cLsCn2M",
  authDomain: "diallo-ee5aa.firebaseapp.com",
  projectId: "diallo-ee5aa",
  storageBucket: "diallo-ee5aa.firebasestorage.app",
  messagingSenderId: "662485613383",
  appId: "1:662485613383:web:c1129a35c335cc95c0ea62",
  measurementId: "G-F3092DTNZY"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();
const categoriesData = {
  "vehicules": [
    {"label": "Voitures & utilitaires", "icon": "directions_car"},
    {"label": "Moto & scooters", "icon": "motorcycle"},
    {"label": "Camion & bus", "icon": "local_shipping"},
    {"label": "√âquipements et accessoires", "icon": "build"},
    {"label": "Location de v√©hicule", "icon": "key"},
    {"label": "Bateaux", "icon": "sailing"}
  ],
  "immobilier": [
    {"label": "Villas", "icon": "villa"},
    {"label": "Terrains", "icon": "terrain"},
    {"label": "Appartements", "icon": "apartment"},
    {"label": "Immeubles", "icon": "domain"},
    {"label": "Bureaux et commerce", "icon": "business"},
    {"label": "Maison de vacances", "icon": "holiday_village"},
    {"label": "Chambres", "icon": "bedroom_parent"},
    {"label": "Terrains agricoles", "icon": "agriculture"},
    {"label": "Appartements meubl√©s", "icon": "home_filled"},
    {"label": "Ferme et verger", "icon": "agriculture"}
  ],
  "electronique": [
    { "label": "T√©l√©phones & Tablettes", "icon": "smartphone" },
    { "label": "Ordinateurs", "icon": "computer" },
    { "label": "Son, Hifi & Casques", "icon": "headphones" },
    { "label": "Accessoires Informatiques", "icon": "keyboard" },
    { "label": "Jeux vid√©o & Consoles", "icon": "sports_esports" },
    { "label": "Accessoires T√©l√©phonie", "icon": "phone_iphone" },
    { "label": "TV, box & Vid√©o projecteurs", "icon": "tv" },
    { "label": "Appareils photos et Cam√©ras", "icon": "photo_camera" },
    { "label": "Montres connect√©es & GPS", "icon": "watch" },
    { "label": "Imprimantes & Photocopieurs", "icon": "print" },
    { "label": "Autres √©lectronique", "icon": "devices_other" }
  ],
  "mode": [
    { "label": "V√™tements Homme", "icon": "checkroom" },
    { "label": "V√™tements Femme", "icon": "checkroom" },
    { "label": "Chaussures Homme", "icon": "hiking" },
    { "label": "Chaussures Femme", "icon": "hiking" },
    { "label": "Montres & Bijoux", "icon": "watch" },
    { "label": "Cosm√©tique & Parfums", "icon": "spa" },
    { "label": "Maroquinerie & Bagagerie", "icon": "work" },
    { "label": "Accessoires cheveux, Coiffure & Cils", "icon": "content_cut" },
    { "label": "Tissus & Foulards", "icon": "texture" },
    { "label": "Lingerie", "icon": "favorite" },
    { "label": "Lunettes", "icon": "visibility" },
    { "label": "Autres accessoires", "icon": "more_horiz" }
  ],
  "electromenager": [
    { "label": "Cuisini√®res, Gazini√®res & Fours", "icon": "kitchen" },
    { "label": "R√©frig√©rateurs & Cong√©lateurs", "icon": "ac_unit" },
    { "label": "Climatiseurs & ventilateurs", "icon": "air" },
    { "label": "Machine √† laver vaisselles & linges", "icon": "local_laundry_service" },
    { "label": "Petit √©lectrom√©nager", "icon": "blender" },
    { "label": "Autre √©lectrom√©nager", "icon": "devices_other" }
  ],
  "maison": [
    { "label": "Meubles", "icon": "weekend" },
    { "label": "Vaisselle", "icon": "restaurant" },
    { "label": "D√©coration & luminaires", "icon": "lightbulb" },
    { "label": "Linges de maison", "icon": "hotel" },
    { "label": "Jardin & Piscine", "icon": "pool" },
    { "label": "Bricolage", "icon": "build" },
    { "label": "Literie & Matelas", "icon": "bed" },
    { "label": "Autres pour la maison", "icon": "home" }
  ],
  "emplois": [
    { "label": "Offre d'emploi", "icon": "work" },
    { "label": "Demande d'emploi", "icon": "search" },
    { "label": "Formation", "icon": "school" }
  ],
  "services": [
    { "label": "Covoiturage", "icon": "directions_car" },
    { "label": "Cours particuliers", "icon": "school" },
    { "label": "Babysitting et nounou", "icon": "child_care" },
    { "label": "M√©nage & Cuisine", "icon": "cleaning_services" },
    { "label": "Courses, livraisons & d√©m√©nagement", "icon": "local_shipping" },
    { "label": "Travaux, bricolage et jardinage", "icon": "construction" },
    { "label": "Services Web, Design & Photo", "icon": "photo_camera" },
    { "label": "Services Mode, Beaut√© & Bien-√™tre", "icon": "spa" },
    { "label": "Autres services", "icon": "miscellaneous_services" }
  ],
  "enfant": [
    { "label": "V√™tements Enfants", "icon": "checkroom" },
    { "label": "Chaussures Enfants", "icon": "hiking" },
    { "label": "Mobilier & √âquipement b√©b√©", "icon": "crib" },
    { "label": "Jeux et Jouets", "icon": "toys" },
    { "label": "Fournitures Scolaires", "icon": "menu_book" },
    { "label": "Autres", "icon": "child_friendly" }
  ],
  "sports_loisirs": [
    { "label": "DVDs, CDs & Livres", "icon": "library_books" },
    { "label": "V√©los & Trottinettes", "icon": "directions_bike" },
    { "label": "Instruments de musique", "icon": "music_note" },
    { "label": "Sport & Fitness", "icon": "fitness_center" },
    { "label": "√âv√©nements", "icon": "event" },
    { "label": "Art & Artisanat", "icon": "palette" },
    { "label": "Voyage & Tourisme", "icon": "flight_takeoff" },
    { "label": "Autres Sports & Loisirs", "icon": "sports" }
  ],
  "alimentation": [],
  "animaux": [
    { "label": "Chiens", "icon": "pets" },
    { "label": "Moutons", "icon": "yard" },
    { "label": "Poules, Lapins & Pigeons", "icon": "egg" },
    { "label": "Mat√©riel pour animaux", "icon": "pets" },
    { "label": "Autres animaux", "icon": "eco" }
  ],
  "materiel_pro": [
    { "label": "Mat√©riel Agricole", "icon": "agriculture" },
    { "label": "Transport & Manutention", "icon": "local_shipping" },
    { "label": "Mat√©riaux Construction, BTP, Outillages", "icon": "construction" },
    { "label": "Fournitures de Bureaux", "icon": "business_center" },
    { "label": "Mat√©riel March√©s & Commerces", "icon": "store" },
    { "label": "Mat√©riel M√©dical", "icon": "medical_services" },
    { "label": "√ânergie, Groupes √âlectrog√®ne & Panneaux solaires", "icon": "battery_charging_full" },
    { "label": "Cam√©ras et Mat√©riel de surveillance", "icon": "videocam" },
    { "label": "Autre mat√©riel professionnel", "icon": "miscellaneous_services" }
  ]
};

const annoncesContainer = document.getElementById("annonces");
const subContainer = document.getElementById("subcategories-container");
const categoryElements = document.querySelectorAll(".category");
const suggestionsBox = document.getElementById("suggestions");

const filterToggle = document.getElementById("filter-toggle");
const filterMenu = document.getElementById("filter-menu");
const priceAscBtn = document.getElementById("price-asc");
const priceDescBtn = document.getElementById("price-desc");

let currentUser = null;
let userFavorites = [];
let annoncesData = [];
let selectedCategory = "all";
let selectedSubcategory = null;
let searchText = "";
let sortOrder = "default";
let currentPage = 1;
const annoncesPerPage = 20;

function timeAgo(timestamp){
  if(!timestamp) return "Date inconnue";
  const seconds = (Date.now() - timestamp.toDate().getTime()) / 1000;
  if(seconds < 60) return "√† l‚Äôinstant";
  const minutes = Math.floor(seconds/60);
  if(minutes < 60) return `il y a ${minutes} min`;
  const hours = Math.floor(minutes/60);
  if(hours < 24) return `il y a ${hours} h`;
  const days = Math.floor(hours/24);
  return `il y a ${days} j`;
}
onAuthStateChanged(auth, async (user) => {
  currentUser = user;
  if(user){
    const userRef = doc(db,"users",user.uid);
    const userSnap = await getDoc(userRef);
    userFavorites = userSnap.data()?.favorites || [];
  } else {
    userFavorites = [];
  }
  loadAnnonces();
});

// ‚úÖ VERSION OPTIMIS√âE : supporte +100 000 annonces sans lag
async function loadAnnonces(limitCount = 100) {
  if (!window.annoncesData) window.annoncesData = [];
  if (!window.lastVisible) window.lastVisible = null;

  document.getElementById("spinner").style.display = "flex";

  try {
    // ‚ö° Chargement par lot (pagination Firestore)
    let annoncesQuery = query(
      collection(db, "annonces"),
      orderBy("createdAt", "desc"),
      limit(limitCount)
    );
    if (window.lastVisible) {
      annoncesQuery = query(
        collection(db, "annonces"),
        orderBy("createdAt", "desc"),
        startAfter(window.lastVisible),
        limit(limitCount)
      );
    }

    const annoncesSnap = await getDocs(annoncesQuery);

    if (annoncesSnap.empty) {
      console.log("Toutes les annonces ont √©t√© charg√©es ‚úÖ");
      window.allAnnoncesLoaded = true;
      document.getElementById("spinner").style.display = "none";
      return;
    }

    if (annoncesSnap.empty && window.annoncesData.length === 0) {
      annoncesContainer.innerHTML = "<p>Aucune annonce disponible.</p>";
      document.getElementById("spinner").style.display = "none";
      return;
    }

    // ‚ö° Ajout progressif (sans recr√©er tout le tableau)
    const newAnnonces = annoncesSnap.docs.map(d => ({
      ...d.data(),
      id: d.id
    }));

    // ‚ö° Limiter la taille de window.annoncesData pour √©viter le lag
    window.annoncesData.push(...newAnnonces);
    if (window.annoncesData.length > 5000) {
      // Supprime les annonces les plus anciennes du tableau
      window.annoncesData.splice(0, window.annoncesData.length - 5000);
    }

    window.lastVisible = annoncesSnap.docs[annoncesSnap.docs.length - 1];

    // ‚ö° Cache utilisateurs (charg√© une seule fois)
    if (!window.__usersCache) {
      try {
        const usersSnap = await getDocs(collection(db, "users"));
        const byEmail = {};
        const byId = {};
        usersSnap.forEach(uDoc => {
          const u = uDoc.data() || {};
          byId[uDoc.id] = u;
          const email = (u.email || u.emailAddress || "").toLowerCase().trim();
          if (email) byEmail[email] = u;
        });
        window.__usersCache = { byEmail, byId };
      } catch (err) {
        console.error("Erreur chargement users:", err);
        window.__usersCache = { byEmail: {}, byId: {} };
      }
    }

    // ‚ö° Affichage progressif (rend visible au fur et √† mesure)
    if (!window.hasSetupFilters) {
      setupCategoryFilters();
      setupSearchAndSort();
      setupFilterMenu();
      window.hasSetupFilters = true;
    }

    applyAllFilters(); // n‚Äôaffiche que les annonces du lot charg√©

  } catch (err) {
    console.error("Erreur chargement annonces:", err);
    annoncesContainer.innerHTML = `<p>‚ö†Ô∏è Erreur de chargement : ${err.message}</p>`;
  } finally {
    document.getElementById("spinner").style.display = "none";
  }
}

// ‚ö° Scroll infini pour charger automatiquement les lots suivants
window.addEventListener("scroll", () => {
  if (window.allAnnoncesLoaded) return;
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
    loadAnnonces();
  }
});


function escapeHTML(str) {
  if (!str) return "";
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
}

// REMPLACE ta renderAnnonces par celle-ci (pr√™te √† coller)
// VERSION PRO - Virtual scroll avec pool r√©utilisable (1M+ annonces)
async function renderAnnonces(filtered) {
  // vide le conteneur (structure globale inchang√©e)
  annoncesContainer.innerHTML = "";

  if (!filtered || filtered.length === 0) {
    annoncesContainer.innerHTML = "<p>‚ùå Aucun r√©sultat trouv√©.</p>";
    return;
  }

  // --- CHARGEMENT CACHE USERS (inchang√©) ---
  if (!window.__usersCache) {
    try {
      const usersSnap = await getDocs(collection(db, "users"));
      const byEmail = {};
      const byId = {};
      usersSnap.forEach(uDoc => {
        const u = uDoc.data() || {};
        byId[uDoc.id] = u;
        const email = (u.email || u.emailAddress || "").toLowerCase().trim();
        if (email) byEmail[email] = u;
      });
      window.__usersCache = { byEmail, byId };
    } catch (err) {
      console.error("Erreur chargement users:", err);
      window.__usersCache = { byEmail: {}, byId: {} };
    }
  }

  // --- helper: HTML template de ta carte (identique au markup) ---
  // Cette fonction retourne uniquement le HTML int√©rieur d'une carte (ne touche pas aux classes)
  function createCardHTML(a) {
    const docId = escapeHTML(a.id || "");
    const annonceImage = escapeHTML(a.images?.[0] || "https://via.placeholder.com/400x200?text=Annonce");
    const title = escapeHTML(a.title || "Sans titre");
    const price = escapeHTML(a.price ? a.price + " FCFA" : "Prix sur demande");
    const location = escapeHTML(a.city || "Ville non pr√©cis√©e") + (a.quartier ? ", " + escapeHTML(a.quartier) : "");
    const time = `‚è∞ ${timeAgo(a.createdAt)}`;
    const isFav = currentUser && userFavorites.includes(a.id);
    const favIcon = isFav ? 'favorite' : 'favorite_border';
    const boost = isBoostActive(a) ? '<span class="boost-icon material-symbols-outlined">arrow_shape_up</span>' : '';
    // seller info will √™tre inject√© ensuite via createSellerHTML
    return `
      <div class="image-container">
        <img src="${annonceImage}" 
             loading="lazy"
             alt="${title}"
             onerror="this.onerror=null;this.src='https://via.placeholder.com/400x200?text=Annonce'">
        ${boost}
        <span class="time-badge">${time}</span>
        <span class="material-icons favorite ${isFav ? 'active' : ''}" data-action="fav">${favIcon}</span>
      </div>
      <div class="content">
        <p class="price">${price}</p>
        <h3 class="title">${title}</h3>
        <p class="location">üìç ${location}</p>
      </div>
    `;
  }

  function createSellerHTMLFromData(sellerData) {
    if (!sellerData) {
      return `
        <div class="seller">
          <img src="https://via.placeholder.com/40" loading="lazy" alt="profil vendeur" onerror="this.onerror=null;this.src='https://via.placeholder.com/40'">
          <div class="seller-info"><strong>Utilisateur inconnu</strong></div>
        </div>
      `;
    }
    const sellerPhoto =
      (sellerData.profileImage ||
        sellerData.profilePic ||
        sellerData.profile ||
        sellerData.photoURL ||
        sellerData.avatar ||
        sellerData.image ||
        sellerData.photo) || "https://via.placeholder.com/40";
    const fullName =
      escapeHTML(
        sellerData.fullName ||
          `${sellerData.firstName || sellerData.prenom || ""} ${sellerData.lastName || sellerData.nom || ""}`.trim() ||
          sellerData.displayName ||
          sellerData.name ||
          sellerData.nom ||
          sellerData.prenom ||
          "Utilisateur"
      );
    const isPro = (() => {
      if (!sellerData) return false;
      if (sellerData.subscribe === true) {
        try {
          const now = new Date();
          const subEnd = sellerData.subscribeEnd?.toDate ? sellerData.subscribeEnd.toDate() : new Date(sellerData.subscribeEnd);
          return subEnd > now;
        } catch (e) { return false; }
      }
      return false;
    })();
    return `
      <div class="seller">
        <img src="${escapeHTML(sellerPhoto)}" loading="lazy" alt="profil vendeur" onerror="this.onerror=null;this.src='https://via.placeholder.com/40'">
        <div class="seller-info">
          <strong>${fullName}</strong>
          ${isPro ? '<span class="boutique-pro material-symbols-outlined" title="Boutique Pro">storefront</span>' : ''}
        </div>
      </div>
    `;
  }

  // --- Mesure dynamique de la hauteur d'une carte (respecte ton CSS) ---
  const measureWrapper = document.createElement("div");
  measureWrapper.style.visibility = "hidden";
  measureWrapper.style.position = "absolute";
  measureWrapper.style.left = "-9999px";
  measureWrapper.style.top = "0";
  const sampleCard = document.createElement("div");
  sampleCard.className = "annonce-card";
  sampleCard.innerHTML = createCardHTML(filtered[0] || {}) + createSellerHTMLFromData(
    (() => {
      const a = filtered[0] || {};
      let seller = null;
      const email = (a.userEmail || "").toLowerCase().trim();
      if (email) seller = window.__usersCache.byEmail[email];
      if (!seller && a.userId) seller = window.__usersCache.byId[a.userId];
      if (!seller && a.uid) seller = window.__usersCache.byId[a.uid];
      if (!seller && a.user && typeof a.user === "object") seller = a.user;
      return seller;
    })()
  );
  measureWrapper.appendChild(sampleCard);
  document.body.appendChild(measureWrapper);
  let measuredCardHeight = Math.max(1, sampleCard.offsetHeight);
  document.body.removeChild(measureWrapper);

  // --- param√®tres de fen√™trage et pool ---
  function getCols() {
    try { return window.innerWidth < 768 ? 2 : 4; } catch (e) { return 4; }
  }
  let cols = getCols();
  let rowCount = Math.ceil(filtered.length / cols);
  let totalHeight = rowCount * measuredCardHeight;

  // Pool sizing: visibleRows + buffer
  const BUFFER_ROWS = 4; // tu peux ajuster, 3-5 est bon pour fluidit√©
  function calcPoolSize() {
    const viewportHeight = annoncesContainer.clientHeight || window.innerHeight;
    const visibleRows = Math.ceil(viewportHeight / measuredCardHeight);
    const poolRows = visibleRows + BUFFER_ROWS * 2;
    return Math.min(filtered.length, poolRows * cols);
  }

  let poolSize = calcPoolSize();
  const pool = []; // nodes

  // --- init pool nodes (cr√©ation unique) ---
  for (let i = 0; i < poolSize; i++) {
    const node = document.createElement("div");
    node.className = "annonce-card";
    node.dataset.index = -1;
    // keep pointer for quick updates
    pool.push(node);
    annoncesContainer.appendChild(node);
  }

  // set paddingBottom large pour simuler l'espace total
  annoncesContainer.style.paddingBottom = totalHeight + "px";
  annoncesContainer.style.paddingTop = "0px";

  // --- content update function (remplit une carte existante) ---
  function updateCardNode(node, a, realIndex) {
    // compute seller data once
    let sellerData = null;
    const annonceEmail = (a.userEmail || "").toLowerCase().trim();
    if (annonceEmail) sellerData = window.__usersCache.byEmail[annonceEmail];
    if (!sellerData && a.userId) sellerData = window.__usersCache.byId[a.userId];
    if (!sellerData && a.uid) sellerData = window.__usersCache.byId[a.uid];
    if (!sellerData && a.user && typeof a.user === "object") sellerData = a.user;

    node.innerHTML = createCardHTML(a) + createSellerHTMLFromData(sellerData);
    node.dataset.index = realIndex;

    const titleEl = node.querySelector('.title');
    if (titleEl) {
      if ((a.title || "").length > 30) titleEl.classList.add('long-text');
      else titleEl.classList.remove('long-text');
    }
    node.style.display = ""; // ensure visible
  }

  // --- hide a node when index out of range ---
  function hideNode(node) {
    node.dataset.index = -1;
    node.style.display = "none";
  }

  // --- Event delegation: clicks on container for fav and open details ---
  // remove previous handler if present
  if (annoncesContainer._vScrollDelegator) {
    annoncesContainer.removeEventListener('click', annoncesContainer._vScrollDelegator);
  }
  annoncesContainer._vScrollDelegator = function (e) {
    const favEl = e.target.closest('[data-action="fav"]');
    if (favEl && annoncesContainer.contains(favEl)) {
      // favorite click
      const card = favEl.closest('.annonce-card');
      const idx = Number(card?.dataset?.index);
      if (Number.isFinite(idx) && idx >= 0) {
        const annonce = filtered[idx];
        if (!currentUser) {
          const msg = document.getElementById("notLoggedMsg");
          if (msg) {
            msg.style.display = "block";
            setTimeout(() => { msg.style.display = "none"; }, 3000);
          }
          return;
        }
        const docId = escapeHTML(annonce.id || "");
        const favRef = doc(db, "users", currentUser.uid);
        // toggle UI immediate
        const isActive = favEl.classList.contains('active');
        if (isActive) {
          favEl.classList.remove('active');
          favEl.textContent = "favorite_border";
          userFavorites = userFavorites.filter(id => id !== docId);
          updateDoc(favRef, { favorites: arrayRemove(docId) }).catch(err=>console.error(err));
        } else {
          favEl.classList.add('active');
          favEl.textContent = "favorite";
          userFavorites.push(docId);
          updateDoc(favRef, { favorites: arrayUnion(docId) }).catch(err=>console.error(err));
        }
      }
      return;
    }

    // open details click (ignore clicks on fav icon)
    const card = e.target.closest('.annonce-card');
    if (!card) return;
    const idx = Number(card.dataset.index);
    if (!Number.isFinite(idx) || idx < 0) return;
    // if click on favorite icon we already handled; else navigate
    if (e.target.closest('[data-action="fav"]')) return;
    const annonce = filtered[idx];
    const docId = escapeHTML(annonce.id || "");
    window.location.href = `Details.html?id=${encodeURIComponent(docId)}`;
  };
  annoncesContainer.addEventListener('click', annoncesContainer._vScrollDelegator);

  // --- renderVisible using the pool (no create/remove) ---
  let lastStartIndex = -1;
  let ticking = false;
  function renderVisible() {
    const scrollTop = annoncesContainer.scrollTop;
    const viewportHeight = annoncesContainer.clientHeight || window.innerHeight;

    cols = getCols();
    rowCount = Math.ceil(filtered.length / cols);
    totalHeight = rowCount * measuredCardHeight;
    annoncesContainer.style.paddingBottom = totalHeight + "px";

    const firstVisibleRow = Math.floor(scrollTop / measuredCardHeight);
    const visibleRows = Math.ceil(viewportHeight / measuredCardHeight);
    const startRow = Math.max(0, firstVisibleRow - BUFFER_ROWS);
    const endRow = Math.min(rowCount - 1, firstVisibleRow + visibleRows + BUFFER_ROWS);

    const startIndex = Math.max(0, startRow * cols);
    const endIndex = Math.min(filtered.length, (endRow + 1) * cols);
    const neededCount = endIndex - startIndex;

    // If startIndex hasn't changed and pool is sufficient, we can still skip heavy ops
    if (startIndex === lastStartIndex) {
      // but still update paddingTop if necessary
      annoncesContainer.style.paddingTop = (startRow * measuredCardHeight) + "px";
      return;
    }
    lastStartIndex = startIndex;

    // ensure pool size matches need (recreate pool only when necessary or cols changed significantly)
    const desiredPoolSize = Math.min(filtered.length, neededCount);
    if (desiredPoolSize > pool.length) {
      // create additional nodes
      const createCount = desiredPoolSize - pool.length;
      for (let i = 0; i < createCount; i++) {
        const node = document.createElement("div");
        node.className = "annonce-card";
        node.dataset.index = -1;
        pool.push(node);
        annoncesContainer.appendChild(node);
      }
    } else if (desiredPoolSize < pool.length && pool.length > 0) {
      // we keep extra nodes but hide the surplus to avoid removing from DOM (cheap)
      // (optional) we could remove them if pool becomes huge - but keeping avoids re-allocations
    }

    // Update pool nodes to reflect startIndex..endIndex-1
    for (let p = 0; p < pool.length; p++) {
      const realIndex = startIndex + p;
      const node = pool[p];
      if (realIndex >= startIndex && realIndex < endIndex) {
        const a = filtered[realIndex];
        if (a) updateCardNode(node, a, realIndex);
        else hideNode(node);
      } else {
        hideNode(node);
      }
    }

    // Reorder nodes in container to match sequence (minimize DOM moves)
    // Append pool nodes in order; appended nodes will be moved if already present (cheap)
    const fragment = document.createDocumentFragment();
    for (let p = 0; p < pool.length; p++) {
      fragment.appendChild(pool[p]);
    }
    annoncesContainer.appendChild(fragment);

    // update padding top to offset rows before startRow
    const topPadding = startRow * measuredCardHeight;
    annoncesContainer.style.paddingTop = topPadding + "px";
  }

  function onScroll() {
    if (!ticking) {
      window.requestAnimationFrame(() => {
        renderVisible();
        ticking = false;
      });
      ticking = true;
    }
  }

  // attach scroll handler once (remove previous)
  if (annoncesContainer._vScrollHandler) {
    annoncesContainer.removeEventListener("scroll", annoncesContainer._vScrollHandler);
  }
  annoncesContainer._vScrollHandler = onScroll;
  annoncesContainer.addEventListener("scroll", onScroll, { passive: true });

  // --- resize observer : remesure si la largeur change (responsive cols) ---
  if (annoncesContainer._resizeObserver) {
    annoncesContainer._resizeObserver.disconnect();
  }
  annoncesContainer._resizeObserver = new ResizeObserver(() => {
    // recalculer la hauteur d'une carte (au cas o√π ton CSS change via media queries)
    const temp = document.createElement("div");
    temp.className = "annonce-card";
    temp.style.visibility = "hidden";
    temp.innerHTML = createCardHTML(filtered[0] || {}) + createSellerHTMLFromData(null);
    document.body.appendChild(temp);
    const newHeight = Math.max(1, temp.offsetHeight);
    document.body.removeChild(temp);

    if (newHeight !== measuredCardHeight) {
      measuredCardHeight = newHeight;
    }
    cols = getCols();
    rowCount = Math.ceil(filtered.length / cols);
    totalHeight = rowCount * measuredCardHeight;
    annoncesContainer.style.paddingBottom = totalHeight + "px";

    // recalc pool size and if it increased, create nodes
    const newPoolSize = calcPoolSize();
    if (newPoolSize > pool.length) {
      const createCount = newPoolSize - pool.length;
      for (let i = 0; i < createCount; i++) {
        const node = document.createElement("div");
        node.className = "annonce-card";
        node.dataset.index = -1;
        pool.push(node);
        annoncesContainer.appendChild(node);
      }
    }
    // d√©clenche rendu
    renderVisible();
  });
  annoncesContainer._resizeObserver.observe(annoncesContainer);

  // --- initial render ---
  renderVisible();
}

function renderPagination(totalPages){
  let paginationContainer = document.getElementById("pagination");
  if(!paginationContainer){
    paginationContainer = document.createElement("div");
    paginationContainer.id = "pagination";
    paginationContainer.style.textAlign = "center";
    paginationContainer.style.marginTop = "20px";
    document.body.appendChild(paginationContainer);
  }

  paginationContainer.innerHTML = "";

  const createPageBtn = (num) => {
    const btn = document.createElement("button");
    btn.textContent = num;
    btn.style.margin = "0 5px";
    btn.style.padding = "6px 12px";
    btn.style.borderRadius = "6px";
    btn.style.border = num === currentPage ? "2px solid #009688" : "1px solid #ccc";
    btn.style.background = num === currentPage ? "#009688" : "#fff";
    btn.style.color = num === currentPage ? "#fff" : "#000";
    btn.style.cursor = "pointer";
    btn.addEventListener("click", () => {
      currentPage = num;
      applyAllFilters();
    });
    return btn;
  }

  const maxButtons = 7;
  let startPage = Math.max(1, currentPage - 3);
  let endPage = Math.min(totalPages, startPage + maxButtons - 1);
  startPage = Math.max(1, endPage - maxButtons + 1);

  if(startPage > 1){
    paginationContainer.appendChild(createPageBtn(1));
    if(startPage > 2) paginationContainer.appendChild(document.createTextNode("..."));
  }

  for(let i = startPage; i <= endPage; i++){
    paginationContainer.appendChild(createPageBtn(i));
  }

  if(endPage < totalPages){
    if(endPage < totalPages -1) paginationContainer.appendChild(document.createTextNode("..."));
    paginationContainer.appendChild(createPageBtn(totalPages));
  }
}

function setupCategoryFilters() {
  const allCategory = document.querySelector('.category[data-cat="all"]');
  if (allCategory) allCategory.classList.add("active");

  document.addEventListener("click", e => {
    const menu = document.getElementById("subDropdownMenu");
    if (menu && !menu.parentElement.contains(e.target)) {
      menu.style.display = "none";
    }
  });

  categoryElements.forEach(cat => {
    cat.addEventListener("click", () => {
      categoryElements.forEach(c => c.classList.remove("active"));
      cat.classList.add("active");

      selectedCategory = cat.dataset.cat;
      selectedSubcategory = null;
      currentPage = 1;
      const subs = categoriesData[selectedCategory] || [];
      if (subs.length === 0) {
        subContainer.innerHTML = "<p style='text-align:center;color:#777;'>Aucune sous-cat√©gorie</p>";
      } else {
        subContainer.innerHTML = `
          <div style="text-align:center; margin-top:10px; position:relative; display:inline-block;">
            <button id="subDropdownBtn" style="padding:8px 12px; border-radius:8px; border:1px solid #ccc; background:#fff; cursor:pointer;">
              S√©lectionner une sous-cat√©gorie ‚ñº
            </button>
            <div id="subDropdownMenu" style="display:none; position:absolute; top:100%; left:0; background:#fff; border:1px solid #ccc; border-radius:8px; width:220px; box-shadow:0 2px 6px rgba(0,0,0,0.15); z-index:1000;">
              ${subs.map(s => `<div class="sub-item" style="display:flex; align-items:center; gap:8px; padding:6px 10px; cursor:pointer;">
                <i class="material-icons" style="color:#009688;">${s.icon}</i>
                <span>${s.label}</span>
              </div>`).join('')}
            </div>
          </div>
        `;

        const btn = document.getElementById("subDropdownBtn");
        const items = document.querySelectorAll(".sub-item");

        btn.addEventListener("click", () => {
          const menu = document.getElementById("subDropdownMenu");
          menu.style.display = menu.style.display === "block" ? "none" : "block";
        });

        items.forEach(item => {
          item.addEventListener("click", () => {
            items.forEach(i => { i.style.background = "#fff"; i.style.color = "#000"; });
            item.style.background = "#009688";
            item.style.color = "#fff";
            selectedSubcategory = item.querySelector("span").textContent.trim();
            btn.textContent = selectedSubcategory + " ‚ñº";
            document.getElementById("subDropdownMenu").style.display = "none";
            currentPage = 1;
            applyAllFilters();
          });
        });
      }
      applyAllFilters();
    });
  });
}

function setupSearchAndSort(){
  const searchInput = document.getElementById("search-input");
  const searchBtn = document.getElementById("search-btn");

  searchInput.addEventListener("input", ()=>{ searchText = searchInput.value; });
  searchBtn.addEventListener("click", ()=>{ searchText = searchInput.value; currentPage = 1; applyAllFilters(); });
  searchInput.addEventListener("keypress", e=>{ if(e.key==="Enter"){ searchText = searchInput.value; currentPage = 1; applyAllFilters(); } });
}

function setupFilterMenu(){
  if(!filterToggle) return;

  filterToggle.addEventListener("click", () => { filterMenu.style.display = filterMenu.style.display === "block" ? "none" : "block"; });
  priceAscBtn.addEventListener("click", () => { sortOrder = "asc"; currentPage = 1; applyAllFilters(); filterMenu.style.display = "none"; });
  priceDescBtn.addEventListener("click", () => { sortOrder = "desc"; currentPage = 1; applyAllFilters(); filterMenu.style.display = "none"; });

  document.addEventListener("click", (e) => {
    if (!filterMenu.contains(e.target) && e.target !== filterToggle) filterMenu.style.display = "none";
  });
}

function isBoostActive(annonce) {
  if (!annonce.boost || !annonce.boostEnd) return false;
  const now = new Date();
  const boostEndDate = new Date(annonce.boostEnd.toDate ? annonce.boostEnd.toDate() : annonce.boostEnd);
  return boostEndDate > now;
}

// ‚úÖ VERSION OPTIMIS√âE : applyAllFilters pour +20 000 annonces
function applyAllFilters() {
  // ‚ö° On travaille sur le cache global window.annoncesData
  let filtered = window.annoncesData || [];

  // ‚ö° Filtrage cat√©gorie / sous-cat√©gorie / recherche
  if (selectedCategory && selectedCategory !== "all") {
    filtered = filtered.filter(a => a.categorie === selectedCategory);
  }
  if (selectedSubcategory) {
    filtered = filtered.filter(a => a.souscategorie === selectedSubcategory);
  }
  if (searchText) {
    const lowerSearch = searchText.toLowerCase();
    filtered = filtered.filter(a => 
      (a.title?.toLowerCase().includes(lowerSearch)) || 
      (a.city?.toLowerCase().includes(lowerSearch))
    );
  }

  // ‚ö° Tri optimis√© avec boost et prix/date
  filtered.sort((a, b) => {
    const aBoost = isBoostActive(a);
    const bBoost = isBoostActive(b);

    if (aBoost && !bBoost) return -1;
    if (!aBoost && bBoost) return 1;
    if (aBoost && bBoost) {
      const aEnd = a.boostEnd ? (a.boostEnd.toDate ? a.boostEnd.toDate() : new Date(a.boostEnd)) : 0;
      const bEnd = b.boostEnd ? (b.boostEnd.toDate ? b.boostEnd.toDate() : new Date(b.boostEnd)) : 0;
      return bEnd - aEnd;
    }

    if (sortOrder === "asc") return (a.price || 0) - (b.price || 0);
    if (sortOrder === "desc") return (b.price || 0) - (a.price || 0);

    const aDate = a.createdAt ? a.createdAt.seconds * 1000 : 0;
    const bDate = b.createdAt ? b.createdAt.seconds * 1000 : 0;
    return bDate - aDate;
  });

  // ‚ö° Affichage uniquement du lot actuel pour fluidit√©
  renderAnnonces(filtered);
}

</script>  
</body>
</html>
