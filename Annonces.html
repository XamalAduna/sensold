
<!DOCTYPE html> 
<html lang="fr"> 
<head> 
<meta charset="UTF-8"> 
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Annonces</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
<style>
body { font-family:Arial, sans-serif; background:#f7f7f7; margin:0; padding:8px; padding-bottom:100px; }
h2 { text-align:center; margin-bottom:20px; color:#00796B; }
.annonces-container { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:20px; }
@media (min-width:1024px){ .annonces-container { grid-template-columns:repeat(4,1fr); } }
@media (max-width:600px){ .annonces-container { grid-template-columns:repeat(2,1fr); } }
.annonce-card { background:white; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); overflow:hidden; display:flex; flex-direction:column; position:relative; cursor:pointer; }
.annonce-card img { width:100%; height:150px; object-fit:cover; border-radius:8px 8px 0 0; display:block; margin-bottom:2px; }
.favorite { position:absolute; top:10px; right:10px; background:white; border-radius:50%; padding:5px; cursor:pointer; color:#00796B; box-shadow:0 2px 6px rgba(0,0,0,0.2); transition:color 0.3s; }
.favorite.active { color:red; }
.content { padding:0; flex:1; min-width:0; }
.price { color:#00796B; font-weight:bold; font-size:18px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex-shrink:0; margin:0; line-height:1; }
.title { font-size:16px; font-weight:bold; color:#333; display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical; overflow:hidden; text-overflow:ellipsis; white-space:normal; line-height:1.2em; margin:0; }
.location, .date { font-size:13px; color:#555; margin:2px 0; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
.seller { display:flex; align-items:center; gap:8px; padding:2px 12px; border-top:1px solid #eee; background:#fafafa; }
.seller img { width:30px; height:30px; border-radius:50%; object-fit:cover; }
.search-bar { display:flex; flex-direction:row; align-items:center; justify-content:center; gap:10px; margin-bottom:10px; width:100%; }
.search-box { flex:0 1 auto; max-width:600px; }
#search-input { width:100%; padding:12px 50px 12px 16px; font-size:16px; border-radius:10px; border:1px solid #ccc; box-sizing:border-box; outline:none; transition:border 0.3s ease; }
#search-input:focus { border-color:#009688; }
.search-btn { position:absolute; right:12px; top:50%; transform:translateY(-50%); cursor:pointer; color:#009688; font-size:24px; transition:color 0.3s ease; }
.search-btn:hover { color:#004d40; }
.suggestions { position:absolute; top:100%; left:0; right:0; background:white; border:1px solid #ccc; border-top:none; max-height:200px; overflow-y:auto; z-index:1000; border-radius:0 0 8px 8px; }
.suggestion-item { padding:10px 12px; cursor:pointer; font-size:15px; }
.suggestion-item:hover { background:#f0f0f0; }
.price-filters { display:flex; gap:10px; justify-content:center; align-items:center; width:100%; max-width:300px; }
.price-btn { border:1px solid #ccc; border-radius:8px; padding:6px 12px; background:white; cursor:pointer; color:#00796B; display:flex; flex-direction:row; align-items:center; gap:6px; font-size:14px; transition:0.2s ease; }
.price-btn .material-icons { font-size:18px; }
.price-btn span.label { font-size:13px; color:#333; }
.price-btn:hover { background:#f0f0f0; color:#004d40; }
.categories { margin:20px 0; text-align:center; margin-top:5px; }
.center-title { margin-bottom:15px; font-weight:bold; font-size:18px; color:#222; }
.categories-wrapper { display:flex; justify-content:center; }
.categories-scroll { display:flex; overflow-x:auto; gap:20px; padding:15px; max-width:650px; scrollbar-width:thin; }
.categories-scroll::-webkit-scrollbar { height:6px; }
.categories-scroll::-webkit-scrollbar-thumb { background:#009688; border-radius:10px; }
.category { flex:0 0 auto; text-align:center; width:60px; background:#fff; border-radius:12px; padding:13px; transition:transform 0.3s ease, box-shadow 0.3s ease; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.1); text-decoration:none; color:inherit; display:flex; flex-direction:column; align-items:center; }
.category:hover { transform:translateY(-5px); box-shadow:0 4px 10px rgba(0,0,0,0.15); }
.category i { font-size:28px; color:gray; margin-bottom:5px; display:block; }
.category p { font-size:11px; color:#333; margin:0; }
.category.clicked { animation:bounce 0.4s ease; }
@keyframes bounce { 0% { transform:scale(1); } 30% { transform:scale(0.9); } 60% { transform:scale(1.05); } 100% { transform:scale(1); } }
.subcategories { display:flex; flex-wrap:wrap; gap:15px; justify-content:center; margin-top:15px; padding:10px; }
.subcategory { flex:0 0 auto; width:120px; text-align:center; background:#fff; border-radius:10px; padding:12px; box-shadow:0 2px 5px rgba(0,0,0,0.1); cursor:pointer; transition:transform 0.2s ease, box-shadow 0.2s ease; }
.subcategory:hover { transform:translateY(-4px); box-shadow:0 4px 8px rgba(0,0,0,0.15); }
.subcategory i { font-size:26px; color:#009688; margin-bottom:5px; }
.subcategory p { font-size:13px; margin:0; color:#333; }
.category.active { background:#1976d2; color:white; border-radius:8px; }
.category.active i { color:white; }
#notLoggedMsg { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; padding:20px 30px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.25); text-align:center; z-index:99999; }
#notLoggedMsg a { display:inline-block; margin:8px 0; color:#009688; text-decoration:none; font-weight:bold; }
#notLoggedMsg a:hover { text-decoration:underline; }
.seller-info { flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; position:relative; padding-right:70px; }
.seller-info strong { display:block; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; font-size:13px; }
.loader { border:6px solid #f3f3f3; border-top:6px solid #009688; border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite; }
@keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
.annonce-card .time-badge { position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.6); color:#fff; padding:4px 8px; border-radius:6px; font-size:12px; font-weight:bold; z-index:5; }
.annonce-card .title { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; text-overflow:ellipsis; font-size:16px; line-height:1.2em; }
.annonce-card .title.long-text { font-size:14px; }
.location { line-height:1.2; }
.annonce-card .price, .annonce-card .title { margin:0 5px; line-height:1.2; }
.seller-info { position: relative;overflow: hidden;white-space: nowrap;text-overflow: ellipsis; padding-right: 70px;min-height: 30px; display: flex; align-items: center; }
.seller-info .boutique-pro {position: absolute;right: 0;top: 50%;transform: translateY(-50%);background: white;color: #00796B;font-size: 34px;padding: 6px;border-radius: 6px;display: flex;align-items: center;justify-content: center;}
.material-symbols-outlined {font-variation-settings:'FILL' 0,'wght' 400,'GRAD' 0, 'opsz' 24; font-size: 30px; color: #1f1f1f; }
.image-container {position: relative; display: block;}
.boost-icon {position: absolute;bottom: 8px;right: 8px;font-size: 40px;color: #00796B;background: transparent; border-radius: 0; padding: 0; z-index: 20;display: flex; align-items: center;justify-content: center; line-height: 1;}
</style>
</head>
<body>
<div class="search-bar" style="display:flex; align-items:center; gap:10px;">
  <div class="search-box" style="flex:1; display:flex; align-items:center; position:relative;">
    <input type="text" id="search-input" placeholder="Rechercher..." style="flex:1; padding:8px 36px 8px 12px; border:1px solid #ccc; border-radius:8px;">
    <span class="material-icons search-btn" id="search-btn" style="position:absolute; right:8px; cursor:pointer; color:#009688;">search</span>
    <div id="suggestions" class="suggestions" style="display:none;"></div>
  </div>
  <span id="filter-toggle" class="material-icons" style="cursor:pointer; color:#009688; font-size:28px;">
    filter_list
  </span>
</div>
<div id="filter-menu" style="display:none; margin-top:6px; background:#fff; border:1px solid #ccc; border-radius:8px; padding:6px; width:200px; box-shadow:0 2px 6px rgba(0,0,0,0.15);">
  <button class="price-btn" id="price-asc">
    <span class="material-icons">arrow_upward</span>
    <span class="label">Prix ‚Üë</span>
  </button>
  <button class="price-btn" id="price-desc">
    <span class="material-icons">arrow_downward</span>
    <span class="label">Prix ‚Üì</span>
  </button>
</div>
<section class="categories">
  <div class="categories-wrapper">
    <div class="categories-scroll">
     
      <div class="category" data-cat="all">
         <i class="material-icons">apps</i>
        <p>Tous</p>
      </div>
      <div class="category" data-cat="vehicules">
        <i class="material-icons">directions_car</i>
        <p>V√©hicules</p>
      </div>
      <div class="category" data-cat="electronique">
        <i class="material-icons">devices</i>
        <p>√âlectronique</p>
      </div>
      <div class="category" data-cat="immobilier">
        <i class="material-icons">home</i>
        <p>Immobilier</p>
      </div>
      <div class="category" data-cat="mode">
        <i class="material-icons">checkroom</i>
        <p>Mode & Beaut√©</p>
      </div>
      <div class="category" data-cat="electromenager">
        <i class="material-icons">kitchen</i>
        <p>√âlectrom√©nager</p>
      </div>
      <div class="category" data-cat="maison">
        <i class="material-icons">king_bed</i>
        <p>Pour la maison</p>
      </div>
      <div class="category" data-cat="emplois">
        <i class="material-icons">work</i>
        <p>Emplois</p>
      </div>
      <div class="category" data-cat="services">
        <i class="material-icons">handshake</i>
        <p>Services</p>
      </div>
      <div class="category" data-cat="sports_loisirs">
        <i class="material-icons">sports_basketball</i>
        <p>Sports & Loisirs</p>
      </div>
      <div class="category" data-cat="alimentation">
        <i class="material-icons">restaurant</i>
        <p>Alimentation</p>
      </div>
      <div class="category" data-cat="animaux">
        <i class="material-icons">pets</i>
        <p>Animaux</p>
      </div>
      <div class="category" data-cat="materiel_pro">
        <i class="material-icons">build</i>
        <p>Mat√©riel Pro</p>
      </div>
    </div>
  </div>
  <div id="subcategories-container"></div>
</section>
<div id="spinner" style="display:flex; justify-content:center; align-items:center; height:200px;">
  <div class="loader"></div>
</div>
<div id="annonces" class="annonces-container"></div>
<div id="notLoggedMsg" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; padding:20px 30px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.25); text-align:center; z-index:99999;">
  <p>Veuillez vous connecter pour ajouter ‚ÄØcette annonce √† vos favoris.</p>
  <a href="login.html">Se connecter</a>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy, limit, startAfter, doc, updateDoc, arrayUnion, arrayRemove, getDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
const firebaseConfig = {
  apiKey: "AIzaSyDLrPKEzDueP4j-HjAdOhmkuA74cLsCn2M",
  authDomain: "diallo-ee5aa.firebaseapp.com",
  projectId: "diallo-ee5aa",
  storageBucket: "diallo-ee5aa.firebasestorage.app",
  messagingSenderId: "662485613383",
  appId: "1:662485613383:web:c1129a35c335cc95c0ea62",
  measurementId: "G-F3092DTNZY"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();
const categoriesData = {
  "vehicules": [
    {"label": "Voitures & utilitaires", "icon": "directions_car"},
    {"label": "Moto & scooters", "icon": "motorcycle"},
    {"label": "Camion & bus", "icon": "local_shipping"},
    {"label": "√âquipements et accessoires", "icon": "build"},
    {"label": "Location de v√©hicule", "icon": "key"},
    {"label": "Bateaux", "icon": "sailing"}
  ],
  "immobilier": [
    {"label": "Villas", "icon": "villa"},
    {"label": "Terrains", "icon": "terrain"},
    {"label": "Appartements", "icon": "apartment"},
    {"label": "Immeubles", "icon": "domain"},
    {"label": "Bureaux et commerce", "icon": "business"},
    {"label": "Maison de vacances", "icon": "holiday_village"},
    {"label": "Chambres", "icon": "bedroom_parent"},
    {"label": "Terrains agricoles", "icon": "agriculture"},
    {"label": "Appartements meubl√©s", "icon": "home_filled"},
    {"label": "Ferme et verger", "icon": "agriculture"}
  ],
  "electronique": [
    { "label": "T√©l√©phones & Tablettes", "icon": "smartphone" },
    { "label": "Ordinateurs", "icon": "computer" },
    { "label": "Son, Hifi & Casques", "icon": "headphones" },
    { "label": "Accessoires Informatiques", "icon": "keyboard" },
    { "label": "Jeux vid√©o & Consoles", "icon": "sports_esports" },
    { "label": "Accessoires T√©l√©phonie", "icon": "phone_iphone" },
    { "label": "TV, box & Vid√©o projecteurs", "icon": "tv" },
    { "label": "Appareils photos et Cam√©ras", "icon": "photo_camera" },
    { "label": "Montres connect√©es & GPS", "icon": "watch" },
    { "label": "Imprimantes & Photocopieurs", "icon": "print" },
    { "label": "Autres √©lectronique", "icon": "devices_other" }
  ],
  "mode": [
    { "label": "V√™tements Homme", "icon": "checkroom" },
    { "label": "V√™tements Femme", "icon": "checkroom" },
    { "label": "Chaussures Homme", "icon": "hiking" },
    { "label": "Chaussures Femme", "icon": "hiking" },
    { "label": "Montres & Bijoux", "icon": "watch" },
    { "label": "Cosm√©tique & Parfums", "icon": "spa" },
    { "label": "Maroquinerie & Bagagerie", "icon": "work" },
    { "label": "Accessoires cheveux, Coiffure & Cils", "icon": "content_cut" },
    { "label": "Tissus & Foulards", "icon": "texture" },
    { "label": "Lingerie", "icon": "favorite" },
    { "label": "Lunettes", "icon": "visibility" },
    { "label": "Autres accessoires", "icon": "more_horiz" }
  ],
  "electromenager": [
    { "label": "Cuisini√®res, Gazini√®res & Fours", "icon": "kitchen" },
    { "label": "R√©frig√©rateurs & Cong√©lateurs", "icon": "ac_unit" },
    { "label": "Climatiseurs & ventilateurs", "icon": "air" },
    { "label": "Machine √† laver vaisselles & linges", "icon": "local_laundry_service" },
    { "label": "Petit √©lectrom√©nager", "icon": "blender" },
    { "label": "Autre √©lectrom√©nager", "icon": "devices_other" }
  ],
  "maison": [
    { "label": "Meubles", "icon": "weekend" },
    { "label": "Vaisselle", "icon": "restaurant" },
    { "label": "D√©coration & luminaires", "icon": "lightbulb" },
    { "label": "Linges de maison", "icon": "hotel" },
    { "label": "Jardin & Piscine", "icon": "pool" },
    { "label": "Bricolage", "icon": "build" },
    { "label": "Literie & Matelas", "icon": "bed" },
    { "label": "Autres pour la maison", "icon": "home" }
  ],
  "emplois": [
    { "label": "Offre d'emploi", "icon": "work" },
    { "label": "Demande d'emploi", "icon": "search" },
    { "label": "Formation", "icon": "school" }
  ],
  "services": [
    { "label": "Covoiturage", "icon": "directions_car" },
    { "label": "Cours particuliers", "icon": "school" },
    { "label": "Babysitting et nounou", "icon": "child_care" },
    { "label": "M√©nage & Cuisine", "icon": "cleaning_services" },
    { "label": "Courses, livraisons & d√©m√©nagement", "icon": "local_shipping" },
    { "label": "Travaux, bricolage et jardinage", "icon": "construction" },
    { "label": "Services Web, Design & Photo", "icon": "photo_camera" },
    { "label": "Services Mode, Beaut√© & Bien-√™tre", "icon": "spa" },
    { "label": "Autres services", "icon": "miscellaneous_services" }
  ],
  "enfant": [
    { "label": "V√™tements Enfants", "icon": "checkroom" },
    { "label": "Chaussures Enfants", "icon": "hiking" },
    { "label": "Mobilier & √âquipement b√©b√©", "icon": "crib" },
    { "label": "Jeux et Jouets", "icon": "toys" },
    { "label": "Fournitures Scolaires", "icon": "menu_book" },
    { "label": "Autres", "icon": "child_friendly" }
  ],
  "sports_loisirs": [
    { "label": "DVDs, CDs & Livres", "icon": "library_books" },
    { "label": "V√©los & Trottinettes", "icon": "directions_bike" },
    { "label": "Instruments de musique", "icon": "music_note" },
    { "label": "Sport & Fitness", "icon": "fitness_center" },
    { "label": "√âv√©nements", "icon": "event" },
    { "label": "Art & Artisanat", "icon": "palette" },
    { "label": "Voyage & Tourisme", "icon": "flight_takeoff" },
    { "label": "Autres Sports & Loisirs", "icon": "sports" }
  ],
  "alimentation": [],
  "animaux": [
    { "label": "Chiens", "icon": "pets" },
    { "label": "Moutons", "icon": "yard" },
    { "label": "Poules, Lapins & Pigeons", "icon": "egg" },
    { "label": "Mat√©riel pour animaux", "icon": "pets" },
    { "label": "Autres animaux", "icon": "eco" }
  ],
  "materiel_pro": [
    { "label": "Mat√©riel Agricole", "icon": "agriculture" },
    { "label": "Transport & Manutention", "icon": "local_shipping" },
    { "label": "Mat√©riaux Construction, BTP, Outillages", "icon": "construction" },
    { "label": "Fournitures de Bureaux", "icon": "business_center" },
    { "label": "Mat√©riel March√©s & Commerces", "icon": "store" },
    { "label": "Mat√©riel M√©dical", "icon": "medical_services" },
    { "label": "√ânergie, Groupes √âlectrog√®ne & Panneaux solaires", "icon": "battery_charging_full" },
    { "label": "Cam√©ras et Mat√©riel de surveillance", "icon": "videocam" },
    { "label": "Autre mat√©riel professionnel", "icon": "miscellaneous_services" }
  ]
};

const annoncesContainer = document.getElementById("annonces");
const subContainer = document.getElementById("subcategories-container");
const categoryElements = document.querySelectorAll(".category");
const suggestionsBox = document.getElementById("suggestions");

const filterToggle = document.getElementById("filter-toggle");
const filterMenu = document.getElementById("filter-menu");
const priceAscBtn = document.getElementById("price-asc");
const priceDescBtn = document.getElementById("price-desc");

let currentUser = null;
let userFavorites = [];
let annoncesData = [];
let selectedCategory = "all";
let selectedSubcategory = null;
let searchText = "";
let sortOrder = "default";
let currentPage = 1;
const annoncesPerPage = 20;

function timeAgo(timestamp){
  if(!timestamp) return "Date inconnue";
  const seconds = (Date.now() - timestamp.toDate().getTime()) / 1000;
  if(seconds < 60) return "√† l‚Äôinstant";
  const minutes = Math.floor(seconds/60);
  if(minutes < 60) return `il y a ${minutes} min`;
  const hours = Math.floor(minutes/60);
  if(hours < 24) return `il y a ${hours} h`;
  const days = Math.floor(hours/24);
  return `il y a ${days} j`;
}
onAuthStateChanged(auth, async (user) => {
  currentUser = user;
  if(user){
    const userRef = doc(db,"users",user.uid);
    const userSnap = await getDoc(userRef);
    userFavorites = userSnap.data()?.favorites || [];
  } else {
    userFavorites = [];
  }
  loadAnnonces();
});

// ‚úÖ VERSION OPTIMIS√âE : supporte +20 000 annonces sans lag
async function loadAnnonces(limitCount = 100) {
  // ‚ö° Ne vide plus le conteneur √† chaque appel (pr√©serve l‚Äôaffichage progressif)
  if (!window.annoncesData) window.annoncesData = [];
  if (!window.lastVisible) window.lastVisible = null;

  document.getElementById("spinner").style.display = "flex";

  try {
    // ‚ö° Chargement par lot (pagination Firestore)
    let annoncesQuery = query(
      collection(db, "annonces"),
      orderBy("createdAt", "desc"),
      limit(limitCount)
    );
    if (window.lastVisible) {
      annoncesQuery = query(
        collection(db, "annonces"),
        orderBy("createdAt", "desc"),
        startAfter(window.lastVisible),
        limit(limitCount)
      );
    }

    const annoncesSnap = await getDocs(annoncesQuery);
    
    if (annoncesSnap.empty) {
      console.log("Toutes les annonces ont √©t√© charg√©es ‚úÖ");
      window.allAnnoncesLoaded = true;

      document.getElementById("spinner").style.display = "none"; // üëà ajoute ceci
      
      return;
     }


    if (annoncesSnap.empty && window.annoncesData.length === 0) {
      annoncesContainer.innerHTML = "<p>Aucune annonce disponible.</p>";
      document.getElementById("spinner").style.display = "none";
      return;
    }

    // ‚ö° Ajout progressif (sans recr√©er tout le tableau)
    const newAnnonces = annoncesSnap.docs.map(d => ({
      ...d.data(),
      id: d.id
    }));
    window.annoncesData.push(...newAnnonces);
    window.lastVisible = annoncesSnap.docs[annoncesSnap.docs.length - 1];

    // ‚ö° Cache utilisateurs (charg√© une seule fois)
    if (!window.__usersCache) {
      try {
        const usersSnap = await getDocs(collection(db, "users"));
        const byEmail = {};
        const byId = {};
        usersSnap.forEach(uDoc => {
          const u = uDoc.data() || {};
          byId[uDoc.id] = u;
          const email = (u.email || u.emailAddress || "").toLowerCase().trim();
          if (email) byEmail[email] = u;
        });
        window.__usersCache = { byEmail, byId };
      } catch (err) {
        console.error("Erreur chargement users:", err);
        window.__usersCache = { byEmail: {}, byId: {} };
      }
    }

    // ‚ö° Affichage progressif (rend visible au fur et √† mesure)
    if (!window.hasSetupFilters) {
      setupCategoryFilters();
      setupSearchAndSort();
      setupFilterMenu();
      window.hasSetupFilters = true;
    }

    applyAllFilters(); // n‚Äôaffiche que les annonces du lot charg√©

  } catch (err) {
    console.error("Erreur chargement annonces:", err);
    annoncesContainer.innerHTML = `<p>‚ö†Ô∏è Erreur de chargement : ${err.message}</p>`;
  } finally {
    document.getElementById("spinner").style.display = "none";
  }
}

// ‚ö° Scroll infini pour charger automatiquement les lots suivants
window.addEventListener("scroll", () => {
  // üõë Stoppe le chargement si toutes les annonces sont d√©j√† r√©cup√©r√©es
  if (window.allAnnoncesLoaded) return;

  // üì¶ Si on arrive √† 500px du bas de la page ‚Üí on charge la suite
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
    loadAnnonces();
  }
});


// ‚ö° Infinite scroll pour charger automatiquement les lots suivants
//window.addEventListener("scroll", () => {
 // if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
  //  loadAnnonces(); // charge le prochain lot de 100 annonces
 // }
//});

function escapeHTML(str) {
  if (!str) return "";
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
}

// VERSION PRO - vrai Virtual Scroll avec pool / recyclage (remplace ta renderAnnonces)
async function renderAnnonces(filtered) {
  // garde ancien comportement si vide
  if (!filtered || filtered.length === 0) {
    annoncesContainer.innerHTML = "<p>‚ùå Aucun r√©sultat trouv√©.</p>";
    return;
  }

  // --- CHARGEMENT CACHE USERS (inchang√©) ---
  if (!window.__usersCache) {
    try {
      const usersSnap = await getDocs(collection(db, "users"));
      const byEmail = {};
      const byId = {};
      usersSnap.forEach(uDoc => {
        const u = uDoc.data() || {};
        byId[uDoc.id] = u;
        const email = (u.email || u.emailAddress || "").toLowerCase().trim();
        if (email) byEmail[email] = u;
      });
      window.__usersCache = { byEmail, byId };
    } catch (err) {
      console.error("Erreur chargement users:", err);
      window.__usersCache = { byEmail: {}, byId: {} };
    }
  }

  // --- helpers internes (ne pas toucher si tu veux garder ton design) ---
  function createCardSkeleton() {
    // cr√©e la structure HTML de la carte une seule fois (√©vite innerHTML r√©p√©titif)
    const card = document.createElement("div");
    card.className = "annonce-card"; // garde ta classe
    // structure interne bas√©e sur ton markup initial
    card.innerHTML = `
      <div class="image-container">
        <img class="annonce-img" src="https://via.placeholder.com/400x200?text=Annonce" loading="lazy" alt="Annonce">
        <span class="boost-icon material-symbols-outlined" style="display:none">arrow_shape_up</span>
        <span class="time-badge">‚è∞</span>
        <span class="material-icons favorite">favorite_border</span>
      </div>
      <div class="content">
        <p class="price"></p>
        <h3 class="title"></h3>
        <p class="location"></p>
      </div>
      <div class="seller">
        <img class="seller-photo" src="https://via.placeholder.com/40" loading="lazy" alt="profil vendeur">
        <div class="seller-info">
          <strong class="seller-name"></strong>
          <span class="boutique-pro material-symbols-outlined" title="Boutique Pro" style="display:none">storefront</span>
        </div>
      </div>
    `;

    // gestion erreur image (met en place handler une fois)
    const annonceImg = card.querySelector('.annonce-img');
    annonceImg.addEventListener('error', () => { annonceImg.onerror = null; annonceImg.src = 'https://via.placeholder.com/400x200?text=Annonce'; });

    const sellerImg = card.querySelector('.seller-photo');
    sellerImg.addEventListener('error', () => { sellerImg.onerror = null; sellerImg.src = 'https://via.placeholder.com/40'; });

    // favorite click (lit data-index pour savoir quelle annonce)
    const favBtn = card.querySelector('.favorite');
    favBtn.addEventListener('click', async (e) => {
      e.stopPropagation();
      if (!currentUser) {
        const msg = document.getElementById("notLoggedMsg");
        if (msg) { msg.style.display = "block"; setTimeout(() => { msg.style.display = "none"; }, 3000); }
        return;
      }
      const idx = Number(card.dataset.index);
      const annonce = filtered[idx];
      if (!annonce) return;
      const docId = escapeHTML(annonce.id || "");
      const favRef = doc(db, "users", currentUser.uid);

      if (favBtn.classList.contains("active")) {
        favBtn.classList.remove("active");
        favBtn.textContent = "favorite_border";
        userFavorites = userFavorites.filter(id => id !== docId);
        try { await updateDoc(favRef, { favorites: arrayRemove(docId) }); } catch (err) { console.error(err); }
      } else {
        favBtn.classList.add("active");
        favBtn.textContent = "favorite";
        userFavorites.push(docId);
        try { await updateDoc(favRef, { favorites: arrayUnion(docId) }); } catch (err) { console.error(err); }
      }
    });

    // click sur la carte (navigation)
    card.addEventListener('click', (e) => {
      if (e.target.classList.contains('favorite')) return;
      const idx = Number(card.dataset.index);
      const annonce = filtered[idx];
      if (!annonce) return;
      const docId = escapeHTML(annonce.id || "");
      window.location.href = `Details.html?id=${encodeURIComponent(docId)}`;
    });

    return card;
  }

  function setCardData(card, a, idx) {
    // met √† jour uniquement le contenu (pas le DOM structurel)
    card.dataset.index = idx;

    const isFav = currentUser && userFavorites.includes(a.id);
    const favBtn = card.querySelector('.favorite');
    favBtn.classList.toggle('active', !!isFav);
    favBtn.textContent = isFav ? 'favorite' : 'favorite_border';

    // seller data extraction (reproduit ta logique)
    let sellerData = null;
    const annonceEmail = (a.userEmail || "").toLowerCase().trim();
    if (annonceEmail) sellerData = window.__usersCache.byEmail[annonceEmail];
    if (!sellerData && a.userId) sellerData = window.__usersCache.byId[a.userId];
    if (!sellerData && a.uid) sellerData = window.__usersCache.byId[a.uid];
    if (!sellerData && a.user && typeof a.user === "object") sellerData = a.user;

    let isPro = false;
    if (sellerData && sellerData.subscribe === true) {
      const now = new Date();
      const subEnd = sellerData.subscribeEnd?.toDate ? sellerData.subscribeEnd.toDate() : new Date(sellerData.subscribeEnd);
      if (subEnd > now) isPro = true;
    }

    const fullName =
      sellerData
        ? escapeHTML(
            sellerData.fullName ||
            `${sellerData.firstName || sellerData.prenom || ""} ${sellerData.lastName || sellerData.nom || ""}`.trim() ||
            sellerData.displayName || sellerData.name || sellerData.nom || sellerData.prenom || "Utilisateur"
          )
        : "Utilisateur inconnu";

    const sellerPhoto =
      escapeHTML(
        (sellerData && (
          sellerData.profileImage ||
          sellerData.profilePic ||
          sellerData.profile ||
          sellerData.photoURL ||
          sellerData.avatar ||
          sellerData.image ||
          sellerData.photo
        )) || "https://via.placeholder.com/40"
      );

    const annonceImage = escapeHTML(a.images?.[0] || "https://via.placeholder.com/400x200?text=Annonce");

    // update DOM nodes
    const imgEl = card.querySelector('.annonce-img');
    imgEl.src = annonceImage;
    imgEl.alt = escapeHTML(a.title || 'Annonce');

    const boostIcon = card.querySelector('.boost-icon');
    if (isBoostActive(a)) { boostIcon.style.display = ''; } else { boostIcon.style.display = 'none'; }

    const timeBadge = card.querySelector('.time-badge');
    timeBadge.textContent = `‚è∞ ${timeAgo(a.createdAt)}`;

    const priceEl = card.querySelector('.price');
    priceEl.textContent = a.price ? `${a.price} FCFA` : "Prix sur demande";

    const titleEl = card.querySelector('.title');
    titleEl.textContent = a.title || "Sans titre";
    // garde ta logique de class long-text
    titleEl.classList.toggle('long-text', (a.title || "").length > 30);

    const locationEl = card.querySelector('.location');
    locationEl.textContent = `üìç ${a.city ? a.city : 'Ville non pr√©cis√©e'}${a.quartier ? ', ' + a.quartier : ''}`;

    const sellerImg = card.querySelector('.seller-photo');
    sellerImg.src = sellerPhoto;

    const sellerName = card.querySelector('.seller-name');
    sellerName.textContent = fullName;

    const proBadge = card.querySelector('.boutique-pro');
    proBadge.style.display = isPro ? '' : 'none';
  }

  // --- mesure dynamique (une seule mesure puis r√©utilis√©e) ---
  // cr√©e une carte temporaire puis mesure
  const measureWrapper = document.createElement("div");
  measureWrapper.style.visibility = "hidden";
  measureWrapper.style.position = "absolute";
  measureWrapper.style.left = "-9999px";
  measureWrapper.style.top = "0";
  const sampleCard = createCardSkeleton();
  measureWrapper.appendChild(sampleCard);
  document.body.appendChild(measureWrapper);
  const measuredCardHeight = Math.max(1, sampleCard.offsetHeight);
  document.body.removeChild(measureWrapper);

  // --- calc cols / rows / totalHeight ---
  const cols = (() => { try { return window.innerWidth < 768 ? 2 : 4; } catch (e) { return 4; } })();
  const rowCount = Math.ceil(filtered.length / cols);
  const totalHeight = rowCount * measuredCardHeight;

  // --- pool (recyclage) ---
  const BUFFER_ROWS = 3;
  const viewportHeight = annoncesContainer.clientHeight || window.innerHeight;
  const visibleRowsEstimate = Math.ceil(viewportHeight / measuredCardHeight);
  const poolRows = visibleRowsEstimate + BUFFER_ROWS * 2;
  const poolSize = Math.min(filtered.length, poolRows * cols);

  // clean container but DO NOT remove pool if exists (re-init safe)
  // on reset, remove old pool and handlers to avoid doubles
  if (annoncesContainer._vPool) {
    // remove existing children and clear metadata
    annoncesContainer.innerHTML = "";
    annoncesContainer._vPool = null;
    annoncesContainer._indexToSlot = null;
    if (annoncesContainer._vScrollHandler) {
      annoncesContainer.removeEventListener("scroll", annoncesContainer._vScrollHandler);
      annoncesContainer._vScrollHandler = null;
    }
    if (annoncesContainer._resizeObserver) {
      annoncesContainer._resizeObserver.disconnect();
      annoncesContainer._resizeObserver = null;
    }
  } else {
    // if container had content, clear it once
    annoncesContainer.innerHTML = "";
  }

  // create pool elements once
  const pool = [];
  for (let i = 0; i < poolSize; i++) {
    const card = createCardSkeleton();
    // dataset.index initial -1 (vide)
    card.dataset.index = -1;
    pool.push(card);
    annoncesContainer.appendChild(card);
  }
  annoncesContainer._vPool = pool;
  const indexToSlot = new Map(); // annonceIndex -> slotIndex
  annoncesContainer._indexToSlot = indexToSlot;

  // --- simulate full height with paddings (garde ta grille CSS) ---
  annoncesContainer.style.paddingTop = "0px";
  annoncesContainer.style.paddingBottom = totalHeight + "px";

  // --- renderVisible : met √† jour contenu des cards du pool sans recr√©er ---
  function renderVisible() {
    const scrollTop = annoncesContainer.scrollTop;
    const viewportH = annoncesContainer.clientHeight || window.innerHeight;

    const firstVisibleRow = Math.floor(scrollTop / measuredCardHeight);
    const visibleRows = Math.ceil(viewportH / measuredCardHeight);

    const startRow = Math.max(0, firstVisibleRow - BUFFER_ROWS);
    const endRow = Math.min(rowCount - 1, firstVisibleRow + visibleRows + BUFFER_ROWS);

    const startIndex = Math.max(0, startRow * cols);
    const endIndex = Math.min(filtered.length, (endRow + 1) * cols);
    const neededCount = endIndex - startIndex;

    // safety bound: neededCount <= poolSize by design. If not, we clamp.
    const useCount = Math.min(neededCount, pool.length);

    // Assign pool slots to indexes startIndex..(startIndex+useCount-1)
    for (let slot = 0; slot < useCount; slot++) {
      const targetIndex = startIndex + slot;
      const existingSlotForIndex = indexToSlot.get(targetIndex);
      if (existingSlotForIndex !== undefined) {
        // already assigned, nothing to do
        continue;
      }
      // find a free slot (slot whose current index is out of range)
      let chosenSlot = -1;
      for (let s = 0; s < pool.length; s++) {
        const curIndex = Number(pool[s].dataset.index);
        if (curIndex < startIndex || curIndex >= endIndex) { chosenSlot = s; break; }
      }
      if (chosenSlot === -1) {
        // fallback: pick slot = slot (overwrite)
        chosenSlot = slot % pool.length;
        const prevIndex = Number(pool[chosenSlot].dataset.index);
        if (!Number.isNaN(prevIndex)) indexToSlot.delete(prevIndex);
      } else {
        // free slot chosen: remove its previous mapping
        const prevIndex = Number(pool[chosenSlot].dataset.index);
        if (!Number.isNaN(prevIndex)) indexToSlot.delete(prevIndex);
      }
      // now set data
      const card = pool[chosenSlot];
      const a = filtered[targetIndex];
      if (a) setCardData(card, a, targetIndex);
      indexToSlot.set(targetIndex, chosenSlot);
    }

    // For any pool slots that fall outside startIndex..endIndex, mark dataset.index = -1 (optional)
    for (let s = 0; s < pool.length; s++) {
      const curIndex = Number(pool[s].dataset.index);
      if (curIndex < startIndex || curIndex >= endIndex) {
        pool[s].dataset.index = -1;
      }
    }

    // Reorder DOM children to match visual order startIndex..endIndex (only append existing nodes)
    // Build mapping index->node for visible indexes
    const nodesToAppend = [];
    for (let i = startIndex; i < endIndex; i++) {
      const s = indexToSlot.get(i);
      if (s !== undefined && pool[s]) nodesToAppend.push(pool[s]);
    }
    // append in order (moves nodes)
    nodesToAppend.forEach(n => annoncesContainer.appendChild(n));

    // Update paddingTop to offset rows before startRow
    const topPadding = startRow * measuredCardHeight;
    annoncesContainer.style.paddingTop = topPadding + "px";
  }

  // --- scroll handling (raf) ---
  let ticking = false;
  function onScroll() {
    if (!ticking) {
      window.requestAnimationFrame(() => {
        renderVisible();
        ticking = false;
      });
      ticking = true;
    }
  }

  // attach handler (remove previous if any)
  if (annoncesContainer._vScrollHandler) {
    annoncesContainer.removeEventListener("scroll", annoncesContainer._vScrollHandler);
  }
  annoncesContainer._vScrollHandler = onScroll;
  annoncesContainer.addEventListener("scroll", onScroll, { passive: true });

  // --- resize observer : remesure si la largeur change (responsive cols) ---
  if (annoncesContainer._resizeObserver) {
    annoncesContainer._resizeObserver.disconnect();
  }
  annoncesContainer._resizeObserver = new ResizeObserver(() => {
    // recalculer la hauteur d'une carte
    const temp = createCardSkeleton();
    temp.style.visibility = "hidden";
    document.body.appendChild(temp);
    const newHeight = Math.max(1, temp.offsetHeight);
    document.body.removeChild(temp);

    // mise √† jour des param√®tres d√©pendants
    const newCols = window.innerWidth < 768 ? 2 : 4;
    const newRowCount = Math.ceil(filtered.length / newCols);
    annoncesContainer.style.paddingBottom = (newRowCount * newHeight) + "px";

    // met √† jour la mesure globale et force rendu
    // (on ne recr√©e pas pool, on laisse renderVisible recalculer)
    renderVisible();
  });
  annoncesContainer._resizeObserver.observe(annoncesContainer);

  // --- initial render (remplit pool avec les premi√®res annonces visibles) ---
  renderVisible();
}

function renderPagination(totalPages){
  let paginationContainer = document.getElementById("pagination");
  if(!paginationContainer){
    paginationContainer = document.createElement("div");
    paginationContainer.id = "pagination";
    paginationContainer.style.textAlign = "center";
    paginationContainer.style.marginTop = "20px";
    document.body.appendChild(paginationContainer);
  }

  paginationContainer.innerHTML = "";

  const createPageBtn = (num) => {
    const btn = document.createElement("button");
    btn.textContent = num;
    btn.style.margin = "0 5px";
    btn.style.padding = "6px 12px";
    btn.style.borderRadius = "6px";
    btn.style.border = num === currentPage ? "2px solid #009688" : "1px solid #ccc";
    btn.style.background = num === currentPage ? "#009688" : "#fff";
    btn.style.color = num === currentPage ? "#fff" : "#000";
    btn.style.cursor = "pointer";
    btn.addEventListener("click", () => {
      currentPage = num;
      applyAllFilters();
    });
    return btn;
  }

  const maxButtons = 7;
  let startPage = Math.max(1, currentPage - 3);
  let endPage = Math.min(totalPages, startPage + maxButtons - 1);
  startPage = Math.max(1, endPage - maxButtons + 1);

  if(startPage > 1){
    paginationContainer.appendChild(createPageBtn(1));
    if(startPage > 2) paginationContainer.appendChild(document.createTextNode("..."));
  }

  for(let i = startPage; i <= endPage; i++){
    paginationContainer.appendChild(createPageBtn(i));
  }

  if(endPage < totalPages){
    if(endPage < totalPages -1) paginationContainer.appendChild(document.createTextNode("..."));
    paginationContainer.appendChild(createPageBtn(totalPages));
  }
}

function setupCategoryFilters() {
  const allCategory = document.querySelector('.category[data-cat="all"]');
  if (allCategory) allCategory.classList.add("active");

  document.addEventListener("click", e => {
    const menu = document.getElementById("subDropdownMenu");
    if (menu && !menu.parentElement.contains(e.target)) {
      menu.style.display = "none";
    }
  });

  categoryElements.forEach(cat => {
    cat.addEventListener("click", () => {
      categoryElements.forEach(c => c.classList.remove("active"));
      cat.classList.add("active");

      selectedCategory = cat.dataset.cat;
      selectedSubcategory = null;
      currentPage = 1;
      const subs = categoriesData[selectedCategory] || [];
      if (subs.length === 0) {
        subContainer.innerHTML = "<p style='text-align:center;color:#777;'>Aucune sous-cat√©gorie</p>";
      } else {
        subContainer.innerHTML = `
          <div style="text-align:center; margin-top:10px; position:relative; display:inline-block;">
            <button id="subDropdownBtn" style="padding:8px 12px; border-radius:8px; border:1px solid #ccc; background:#fff; cursor:pointer;">
              S√©lectionner une sous-cat√©gorie ‚ñº
            </button>
            <div id="subDropdownMenu" style="display:none; position:absolute; top:100%; left:0; background:#fff; border:1px solid #ccc; border-radius:8px; width:220px; box-shadow:0 2px 6px rgba(0,0,0,0.15); z-index:1000;">
              ${subs.map(s => `<div class="sub-item" style="display:flex; align-items:center; gap:8px; padding:6px 10px; cursor:pointer;">
                <i class="material-icons" style="color:#009688;">${s.icon}</i>
                <span>${s.label}</span>
              </div>`).join('')}
            </div>
          </div>
        `;

        const btn = document.getElementById("subDropdownBtn");
        const items = document.querySelectorAll(".sub-item");

        btn.addEventListener("click", () => {
          const menu = document.getElementById("subDropdownMenu");
          menu.style.display = menu.style.display === "block" ? "none" : "block";
        });

        items.forEach(item => {
          item.addEventListener("click", () => {
            items.forEach(i => { i.style.background = "#fff"; i.style.color = "#000"; });
            item.style.background = "#009688";
            item.style.color = "#fff";
            selectedSubcategory = item.querySelector("span").textContent.trim();
            btn.textContent = selectedSubcategory + " ‚ñº";
            document.getElementById("subDropdownMenu").style.display = "none";
            currentPage = 1;
            applyAllFilters();
          });
        });
      }
      applyAllFilters();
    });
  });
}

function setupSearchAndSort(){
  const searchInput = document.getElementById("search-input");
  const searchBtn = document.getElementById("search-btn");

  searchInput.addEventListener("input", ()=>{ searchText = searchInput.value; });
  searchBtn.addEventListener("click", ()=>{ searchText = searchInput.value; currentPage = 1; applyAllFilters(); });
  searchInput.addEventListener("keypress", e=>{ if(e.key==="Enter"){ searchText = searchInput.value; currentPage = 1; applyAllFilters(); } });
}

function setupFilterMenu(){
  if(!filterToggle) return;

  filterToggle.addEventListener("click", () => { filterMenu.style.display = filterMenu.style.display === "block" ? "none" : "block"; });
  priceAscBtn.addEventListener("click", () => { sortOrder = "asc"; currentPage = 1; applyAllFilters(); filterMenu.style.display = "none"; });
  priceDescBtn.addEventListener("click", () => { sortOrder = "desc"; currentPage = 1; applyAllFilters(); filterMenu.style.display = "none"; });

  document.addEventListener("click", (e) => {
    if (!filterMenu.contains(e.target) && e.target !== filterToggle) filterMenu.style.display = "none";
  });
}

function isBoostActive(annonce) {
  if (!annonce.boost || !annonce.boostEnd) return false;
  const now = new Date();
  const boostEndDate = new Date(annonce.boostEnd.toDate ? annonce.boostEnd.toDate() : annonce.boostEnd);
  return boostEndDate > now;
}

// ‚úÖ VERSION OPTIMIS√âE : applyAllFilters pour +20 000 annonces
function applyAllFilters() {
  // ‚ö° On travaille sur le cache global window.annoncesData
  let filtered = window.annoncesData || [];

  // ‚ö° Filtrage cat√©gorie / sous-cat√©gorie / recherche
  if (selectedCategory && selectedCategory !== "all") {
    filtered = filtered.filter(a => a.categorie === selectedCategory);
  }
  if (selectedSubcategory) {
    filtered = filtered.filter(a => a.souscategorie === selectedSubcategory);
  }
  if (searchText) {
    const lowerSearch = searchText.toLowerCase();
    filtered = filtered.filter(a => 
      (a.title?.toLowerCase().includes(lowerSearch)) || 
      (a.city?.toLowerCase().includes(lowerSearch))
    );
  }

  // ‚ö° Tri optimis√© avec boost et prix/date
  filtered.sort((a, b) => {
    const aBoost = isBoostActive(a);
    const bBoost = isBoostActive(b);

    if (aBoost && !bBoost) return -1;
    if (!aBoost && bBoost) return 1;
    if (aBoost && bBoost) {
      const aEnd = a.boostEnd ? (a.boostEnd.toDate ? a.boostEnd.toDate() : new Date(a.boostEnd)) : 0;
      const bEnd = b.boostEnd ? (b.boostEnd.toDate ? b.boostEnd.toDate() : new Date(b.boostEnd)) : 0;
      return bEnd - aEnd;
    }

    if (sortOrder === "asc") return (a.price || 0) - (b.price || 0);
    if (sortOrder === "desc") return (b.price || 0) - (a.price || 0);

    const aDate = a.createdAt ? a.createdAt.seconds * 1000 : 0;
    const bDate = b.createdAt ? b.createdAt.seconds * 1000 : 0;
    return bDate - aDate;
  });

  // ‚ö° Affichage uniquement du lot actuel pour fluidit√©
  renderAnnonces(filtered);
}

</script>  
</body>
</html>
